---
phase: 04-dual-adapter-validation
plan: 05
type: execute
wave: 4
depends_on: ["04-04"]
files_modified:
  - .planning/reviews/phase-4/PHASE_4_PLAN_SUMMARY.md
  - .planning/reviews/phase-4/PHASE_4_EVIDENCE.md
autonomous: false
requirements:
  - ADPT-02
  - ADPT-03
  - ADPT-04
  - TEST-04
  - PORT-03

must_haves:
  truths:
    - "Plan summary published and reviewed by Codex"
    - "Evidence packet compiled with test results, coverage, and LoC metrics"
    - "Codex post-execution review completed with gate decision"
    - "All carry-forward items from Phase 3 addressed or re-scheduled"
  artifacts:
    - path: ".planning/reviews/phase-4/PHASE_4_PLAN_SUMMARY.md"
      provides: "Plan summary for pre-execution review"
    - path: ".planning/reviews/phase-4/PHASE_4_EVIDENCE.md"
      provides: "Evidence packet for post-execution review"
  key_links: []
---

<objective>
Run the Phase 4 review cycle: pre-execution plan review (advisory), then post-execution evidence audit with Codex for gate decision.

Purpose: Validate that the dual adapter implementation is sound, the IR is proven engine-agnostic, and the incremental delta system works correctly before building collaboration on top.

Output: Review artifacts in `.planning/reviews/phase-4/`, gate decision (PASS, PASS_WITH_CONDITIONS, or FAIL).
</objective>

<execution_context>
@/home/frank/.claude/get-shit-done/workflows/execute-plan.md
@/home/frank/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PHASE_REVIEW_PROTOCOL.md
@.planning/ROADMAP.md
@.planning/STATE.md
@scripts/codex-review.sh
@.planning/phases/04-dual-adapter-validation/04-01-SUMMARY.md
@.planning/phases/04-dual-adapter-validation/04-02-SUMMARY.md
@.planning/phases/04-dual-adapter-validation/04-03-SUMMARY.md
@.planning/phases/04-dual-adapter-validation/04-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pre-execution plan review and post-execution evidence audit</name>
  <files>
    .planning/reviews/phase-4/PHASE_4_PLAN_SUMMARY.md
    .planning/reviews/phase-4/PHASE_4_EVIDENCE.md
  </files>
  <action>
    Follow the Phase Review Protocol from `.planning/PHASE_REVIEW_PROTOCOL.md`:

    **Pre-execution (advisory):**
    1. Compile `PHASE_4_PLAN_SUMMARY.md` from all plan files (04-01 through 04-04)
    2. Run `./scripts/codex-review.sh plan-review 4` (or `--chunked` if 5+ plans)
    3. Read Codex feedback, write response, incorporate any critical feedback into plans before execution

    **Post-execution (gate decision):**
    1. Compile `PHASE_4_EVIDENCE.md` with:
       - Test results: `pnpm turbo run test` output (unit, conformance, property)
       - Visual regression results (Playwright screenshot diffs)
       - Coverage metrics
       - LoC budget report: `bash scripts/check-adapter-loc.sh`
       - CI run URLs (CF-P3-01)
       - Carry-forward item status (CF-P3-01 through CF-P3-04)
    2. Run `./scripts/codex-review.sh post-review 4`
    3. Read Codex review, write response addressing each finding
    4. Run `./scripts/codex-review.sh final-review 4`
    5. Record gate decision

    **Carry-forward items to address:**
    - CF-P3-01: Attach CI run URLs + test artifacts to evidence ✓ (include in evidence)
    - CF-P3-02: Promote visual regression to required CI ✓ (done in 04-04)
    - CF-P3-03: Multi-seed property suite ✓ (done in 04-04)
    - CF-P3-04: Mechanical mutation-boundary enforcement (Phase 4/5) -- assess and document status

    Update `.planning/STATE.md` with Phase 4 results.
  </action>
  <verify>
    `.planning/reviews/phase-4/` directory contains all review artifacts.
    Gate decision recorded.
    STATE.md updated.
  </verify>
  <done>
    Phase 4 review cycle complete. Gate decision recorded. STATE.md reflects Phase 4 completion status.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification of Phase 4 deliverables</name>
  <files>.planning/reviews/phase-4/PHASE_4_EVIDENCE.md</files>
  <action>
    Human verification of Phase 4: Dual Adapter Validation.

    What was built: Babylon.js adapter that renders all golden fixtures from Canonical IR, incremental delta update system replacing full scene rebuilds, engine switching UI in top bar with confirmation dialog and camera preservation, engine tuning inspector section, conformance test suite, and Codex review.

    Steps to verify:
    1. Open the editor in a browser with a project loaded
    2. Verify the engine switcher appears in the top bar with a subtle engine icon
    3. Click the engine switcher and confirm the dialog appears ("Switch to Babylon.js? Scene will reload.")
    4. Switch to Babylon.js -- verify the scene renders (same objects, same positions, materials look correct)
    5. Switch back to PlayCanvas -- verify camera position was preserved and selection was reset
    6. Edit a transform or material property in the inspector -- verify no full-scene flicker (delta update working)
    7. Check the Engine Tuning section in the inspector (collapsed by default, expandable)
    8. Verify engine switcher is disabled during play-test mode
    9. Run `pnpm turbo run test` and confirm all tests pass
    10. Review the Codex gate decision in `.planning/reviews/phase-4/`
  </action>
  <verify>
    Human confirms all 10 verification steps pass.
  </verify>
  <done>
    Phase 4 human verification complete. All deliverables functioning as expected.
  </done>
</task>

</tasks>

<verification>
- Review artifacts exist in `.planning/reviews/phase-4/`
- Gate decision is PASS or PASS_WITH_CONDITIONS
- All carry-forward items addressed or re-scheduled
- STATE.md updated with Phase 4 results
</verification>

<success_criteria>
- Codex gate decision is PASS or PASS_WITH_CONDITIONS
- All Phase 4 success criteria from ROADMAP.md are met:
  1. All golden fixtures render on both engines within tolerance
  2. User can switch between engines with consistent scene
  3. Property edits use incremental delta (not full rebuild)
  4. Engine tuning respected by target adapter, ignored by other
</success_criteria>

<output>
After completion, create `.planning/phases/04-dual-adapter-validation/04-05-SUMMARY.md`
</output>
