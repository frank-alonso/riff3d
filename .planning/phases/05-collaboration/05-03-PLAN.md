---
phase: 05-collaboration
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - apps/editor/src/collaboration/hooks/use-awareness.ts
  - apps/editor/src/collaboration/hooks/use-remote-changes.ts
  - apps/editor/src/components/editor/collaboration/collaborator-bar.tsx
  - apps/editor/src/components/editor/collaboration/offline-banner.tsx
  - apps/editor/src/components/editor/hierarchy/tree-node.tsx
  - apps/editor/src/components/editor/inspector/inspector-panel.tsx
  - apps/editor/src/components/editor/shell/top-bar.tsx
  - packages/adapter-playcanvas/src/editor-tools/presence-renderer.ts
autonomous: true
requirements: ["COLLAB-02"]

must_haves:
  truths:
    - "Colored cursors with user names are visible in the 2D hierarchy panel (colored border + avatar chip on entity rows)"
    - "Camera frustum cones with floating name labels are visible in the 3D viewport for each remote user"
    - "A collaborator bar in the toolbar shows all active users with their assigned colors"
    - "Join/leave events trigger both a toast notification and update the collaborator bar"
    - "When connection is lost, an offline banner appears and the editor becomes read-only"
    - "When viewing an entity in the inspector while another user changes a property, the changed property briefly flashes in the other user's color"
  artifacts:
    - path: "apps/editor/src/collaboration/hooks/use-awareness.ts"
      provides: "Hook for subscribing to Yjs Awareness state changes"
      exports: ["useAwareness"]
    - path: "apps/editor/src/components/editor/collaboration/collaborator-bar.tsx"
      provides: "Toolbar component showing active collaborators"
      exports: ["CollaboratorBar"]
    - path: "apps/editor/src/components/editor/collaboration/offline-banner.tsx"
      provides: "Offline status banner component"
      exports: ["OfflineBanner"]
    - path: "packages/adapter-playcanvas/src/editor-tools/presence-renderer.ts"
      provides: "3D frustum cone + name label rendering for remote users"
      exports: ["PresenceRenderer"]
  key_links:
    - from: "use-awareness.ts"
      to: "y-protocols/awareness"
      via: "Awareness.on('change') subscription"
      pattern: "awareness\\.on.*change"
    - from: "presence-renderer.ts"
      to: "PlayCanvas app.drawLines"
      via: "Immediate-mode frustum cone drawing (same pattern as grid.ts)"
      pattern: "drawLines.*frustumCone"
    - from: "collaborator-bar.tsx"
      to: "collab-slice collaborators"
      via: "Zustand selector for collaborators list"
      pattern: "useEditorStore.*collaborators"
---

<objective>
Build the presence and awareness system: collaborator bar, 2D hierarchy presence indicators, 3D viewport frustum cones, join/leave notifications, remote property change highlights, and offline banner.

Purpose: Presence awareness is the most visible collaboration feature -- users need to see WHO is editing, WHERE they're looking, and WHAT they're changing. This plan makes the collaborative experience feel alive and connected.

Output: Collaborator bar in toolbar, colored presence in hierarchy and viewport, join/leave toasts, offline banner, remote change highlights
</objective>

<execution_context>
@/home/frank/.claude/get-shit-done/workflows/execute-plan.md
@/home/frank/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/05-collaboration/05-RESEARCH.md
@.planning/phases/05-collaboration/05-CONTEXT.md
@.planning/phases/05-collaboration/05-02-SUMMARY.md
@apps/editor/src/collaboration/awareness-state.ts
@apps/editor/src/collaboration/presence-colors.ts
@apps/editor/src/collaboration/provider.tsx
@apps/editor/src/stores/slices/collab-slice.ts
@apps/editor/src/components/editor/hierarchy/tree-node.tsx
@apps/editor/src/components/editor/shell/top-bar.tsx
@packages/adapter-playcanvas/src/editor-tools/grid.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Awareness hooks, collaborator bar, join/leave toasts, offline banner, and remote change highlights</name>
  <files>
    apps/editor/src/collaboration/hooks/use-awareness.ts
    apps/editor/src/collaboration/hooks/use-remote-changes.ts
    apps/editor/src/components/editor/collaboration/collaborator-bar.tsx
    apps/editor/src/components/editor/collaboration/offline-banner.tsx
    apps/editor/src/components/editor/hierarchy/tree-node.tsx
    apps/editor/src/components/editor/inspector/inspector-panel.tsx
    apps/editor/src/components/editor/shell/top-bar.tsx
  </files>
  <action>
    Build the 2D presence UI layer.

    **Awareness hook (`use-awareness.ts`):**
    - Subscribe to Yjs Awareness `change` events via the collaboration context
    - Return `Map<clientId, PresenceState>` of all remote users (exclude self)
    - Update local awareness state when selection changes: `awareness.setLocalStateField('selection', selectedEntityIds)`
    - Update local awareness state when camera moves (throttled to 100ms): `awareness.setLocalStateField('camera', cameraState)`
    - Handle join/leave detection: compare previous state map keys with current. New key = join, removed key = leave
    - On join: `toast.info("Alice joined")` with user's color accent
    - On leave: `toast.info("Alice left")`
    - Update collab-slice `collaborators` array on every awareness change

    **Remote change tracking hook (`use-remote-changes.ts`):**
    - Subscribe to Y.Doc entity map changes (deep observer from sync bridge)
    - Track which properties of which entities were changed by remote users (via Awareness state cross-reference)
    - Maintain a `recentRemoteChanges: Map<entityId, { property: string, color: string, timestamp: number }>` that clears entries after 2 seconds
    - Expose this as a hook: `useRemoteChanges()` returns the map for UI consumption

    **Collaborator bar (`collaborator-bar.tsx`):**
    Per locked decision: persistent collaborator bar in toolbar showing active users.
    - Render in the top bar, right side (between save indicator and user avatar)
    - Show colored circles with user initials for each collaborator
    - Tooltip on hover showing full name
    - Max 5 visible, overflow shows "+N" badge
    - Only visible when `isCollaborating` is true

    **Offline banner (`offline-banner.tsx`):**
    Per locked decision: banner "Offline -- changes will sync when reconnected", editor read-only.
    - Fixed position banner at top of viewport area (below top bar)
    - Yellow/amber warning style
    - Text: "Offline -- changes will sync when reconnected"
    - Visible when `isOffline` is true in collab-slice
    - When offline, the banner appears AND `setReadOnly(true)` is called (wired in collaboration provider from 05-02)

    **Hierarchy presence (`tree-node.tsx` modification):**
    Per locked decision: colored border + small avatar chip on entity rows showing other users' selections.
    - Import `useAwareness` hook
    - For each entity row, check if any remote user has this entity in their `selection` array
    - If so: add a 2px left border in the remote user's color, show a small colored circle (12px) with the user's initial next to the entity name
    - Multiple users selecting same entity: show multiple chips (up to 3, then "+N")

    **Inspector remote change highlights (`inspector-panel.tsx` modification):**
    Per locked decision: brief color flash/highlight on changed property in other user's color.
    - Import `useRemoteChanges` hook
    - For the currently inspected entity, check `recentRemoteChanges` for matching entries
    - If a property was recently changed by a remote user: apply a brief background-color flash (CSS transition, 0.5s fade from user's color to transparent)
    - Show a small colored dot next to the property label during the flash

    **Top bar integration:**
    - Add `<CollaboratorBar />` to top-bar.tsx in the right section
    - Add `<OfflineBanner />` to editor-shell.tsx above the viewport

    Run `pnpm typecheck` and `pnpm test`.
  </action>
  <verify>
    - `pnpm typecheck` passes
    - `pnpm test` passes
    - With two tabs: selecting an entity in tab A shows colored border on that entity in tab B's hierarchy
    - CollaboratorBar shows both users with correct colors
    - Disconnecting one tab shows "Alice left" toast in the other
    - Editing a property in tab A causes a brief color flash in tab B's inspector (when viewing same entity)
    - Disconnecting network shows offline banner and read-only mode
  </verify>
  <done>
    2D presence indicators (hierarchy borders, avatar chips), collaborator bar, join/leave toasts, offline banner, and remote change highlights all functional.
  </done>
</task>

<task type="auto">
  <name>Task 2: 3D viewport frustum cone presence rendering</name>
  <files>
    packages/adapter-playcanvas/src/editor-tools/presence-renderer.ts
    packages/adapter-playcanvas/src/editor-tools/index.ts
    apps/editor/src/components/editor/viewport/viewport-canvas.tsx
  </files>
  <action>
    Build the 3D presence visualization: camera frustum cones with floating name labels for each remote user.

    **Frustum cone renderer (`presence-renderer.ts`):**
    Per locked decision: floating name label + camera frustum cone (colored wireframe showing where they're looking), always visible.

    - Create `PresenceRenderer` class following the same pattern as `Grid` class in grid.ts (immediate-mode drawing)
    - Constructor takes `pc.Application` reference
    - `update(remoteUsers: Array<{name, color, position, rotation, fov, mode}>)`: called each frame
    - For each remote user in 'editor' mode (not avatar mode):
      - Draw a simplified frustum cone using `app.drawLines()`:
        - 4 lines from camera position to corners of the near plane (at a fixed distance, e.g., 3 meters)
        - 4 lines connecting the corners to form the near plane rectangle
        - Cone depth represents FOV visually
      - Color all lines in the user's assigned color
      - For the name label: Use PlayCanvas `pc.Element` or a screen-space DOM overlay
        - Simplest approach: maintain a DOM div per remote user, positioned via `app.graphicsDevice.canvas` screen-space projection of the user's position
        - The div shows the user name in a small pill/tag above the frustum cone
        - Update position each frame by projecting 3D position to 2D screen coordinates
    - For users in 'avatar' mode: skip frustum cone (avatar rendering handled in 05-05)
    - `dispose()`: clean up DOM elements and references

    **Integration with viewport-canvas.tsx:**
    - After initializing the PlayCanvas adapter's editor tools (gizmos, grid, selection), also create a PresenceRenderer
    - Each frame (via app.on('update')), feed the PresenceRenderer with remote user data from Awareness state
    - The awareness data comes from the collab-slice `collaborators` array or directly from the awareness hook
    - Register a Zustand subscription or awareness observer that updates the renderer's user list
    - On adapter dispose, dispose the PresenceRenderer

    **Coordinate system:**
    - Remote camera positions from Awareness are in world space (same as IR convention: right-handed, Y-up)
    - PlayCanvas uses the same coordinate system, so no conversion needed
    - The frustum cone math: halfH = tan(fov/2) * distance, halfW = halfH * aspect (16/9 default)

    **Name label DOM approach (preferred over 3D text):**
    - Create a container div absolutely positioned over the canvas
    - For each remote user, create a child div styled as a small colored pill
    - Each frame, project the user's 3D position (slightly above, +0.5m Y offset) to 2D screen space
    - Use `camera.worldToScreen(position)` from PlayCanvas to get screen coordinates
    - Position the div at those coordinates
    - Hide labels that are behind the camera (z < 0 after projection)

    Run `pnpm typecheck` and `pnpm test`.
  </action>
  <verify>
    - `pnpm typecheck` passes
    - `pnpm test` passes
    - With two tabs: moving the camera in tab A shows a colored frustum cone in tab B's viewport at tab A's camera position
    - Name label floats above the frustum cone and tracks position
    - Label is hidden when the remote user is behind the local camera
  </verify>
  <done>
    3D frustum cones with floating name labels render for each remote user in the viewport. Presence indicators are always visible per locked decision.
  </done>
</task>

</tasks>

<verification>
- All presence indicators working: 2D hierarchy (borders + chips), 3D viewport (frustum cones + labels), collaborator bar, join/leave toasts
- Remote property change highlights in inspector
- Offline banner appears on disconnect, editor goes read-only
- Reconnection restores editing capability
</verification>

<success_criteria>
- COLLAB-02: Multiplayer cursors and presence -- colored indicators in both 2D panels and 3D viewport with user names
- Two users see each other's selections highlighted in hierarchy panel
- Two users see each other's camera positions as frustum cones in viewport
- Join/leave triggers both toast AND collaborator bar update
- Offline = banner + read-only per locked decision
</success_criteria>

<output>
After completion, create `.planning/phases/05-collaboration/05-03-SUMMARY.md`
</output>
