---
phase: 06-review-gate-core-platform
plan: 02
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - apps/editor/__tests__/stress-test-collab.test.ts
  - apps/editor/__tests__/stress-test-helpers.ts
  - apps/editor/e2e/stress-collab.spec.ts
autonomous: true
requirements: []

must_haves:
  truths:
    - "4 headless Y.Doc clients editing a 200-entity scene converge to identical state after sync"
    - "200-entity scene with diverse component types (mesh, light, camera, groups, multi-component) can be built programmatically"
    - "Concurrent edits to different entities by 4 clients all survive CRDT merge (no silent data loss)"
    - "Concurrent edits to the SAME entity by 2 clients both survive at the property level (LWW per property)"
    - "Network disruption (delayed sync) still produces convergent state after reconnection"
    - "Cross-engine collaboration test validates that ECSON/Yjs layer is engine-agnostic"
    - "FPS measurement infrastructure exists for 200-entity scene rendering validation"
  artifacts:
    - path: "apps/editor/__tests__/stress-test-helpers.ts"
      provides: "200-entity scene builder, multi-client sync helpers, FPS measurement helper"
      contains: "build200EntityScene"
    - path: "apps/editor/__tests__/stress-test-collab.test.ts"
      provides: "4-client headless CRDT stress tests, convergence validation, conflict resolution, network simulation"
      contains: "4 clients"
    - path: "apps/editor/e2e/stress-collab.spec.ts"
      provides: "Playwright E2E stress test for multi-user collab, FPS measurement, cross-engine validation"
      contains: "stress"
  key_links:
    - from: "apps/editor/__tests__/stress-test-collab.test.ts"
      to: "apps/editor/src/collaboration/sync-bridge.ts"
      via: "import initializeYDoc, yDocToEcson, syncToYDoc"
      pattern: "initializeYDoc|yDocToEcson"
    - from: "apps/editor/__tests__/stress-test-helpers.ts"
      to: "@riff3d/ecson"
      via: "SceneDocumentSchema.parse for 200-entity scene construction"
      pattern: "SceneDocumentSchema"
    - from: "apps/editor/e2e/stress-collab.spec.ts"
      to: "playwright.config.ts"
      via: "Playwright test infrastructure"
      pattern: "test.*expect"
---

<objective>
Build and execute the stress test suite that validates the core platform under load: 4 concurrent clients, 200-entity scenes, adverse network conditions, and cross-engine collaboration. This produces the quantitative evidence needed for the Phase 6 review gate.

Purpose: The locked decisions require testing with 4 concurrent users, 200 entities (above the 100-entity SC3 target), network condition simulation, and cross-engine collaboration. These stress tests prove the platform is stable before the game layer is built on top.

Output: Stress test files (headless Vitest + Playwright E2E), test results documenting convergence, FPS measurements, and conflict resolution behavior.
</objective>

<execution_context>
@/home/frank/.claude/get-shit-done/workflows/execute-plan.md
@/home/frank/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-review-gate-core-platform/06-RESEARCH.md
@.planning/phases/06-review-gate-core-platform/06-01-SUMMARY.md
@apps/editor/__tests__/collaboration.test.ts
@apps/editor/src/collaboration/sync-bridge.ts
@apps/editor/e2e/editor-smoke.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: 200-entity scene builder and 4-client headless CRDT stress tests</name>
  <files>
    apps/editor/__tests__/stress-test-helpers.ts
    apps/editor/__tests__/stress-test-collab.test.ts
  </files>
  <action>
    **Step 1: Create stress test helper module**

    Create `apps/editor/__tests__/stress-test-helpers.ts` with:

    1. **`build200EntityScene(): SceneDocument`** -- Builds a 200-entity ECSON scene programmatically using `SceneDocumentSchema.parse()`:
       - 50 mesh entities: Transform + MeshRenderer (box) + Material (varied colors). Spread across positions (i*2, 0, 0) to avoid overlap.
       - 30 light entities: 10 directional, 10 point, 10 spot lights. Varied positions and intensities.
       - 20 camera entities: With perspective projection, different positions/rotations.
       - 50 group entities: Nested hierarchy (10 groups of 5, creating 2-level deep nesting). Empty components but valid hierarchy.
       - 50 multi-component entities: Transform + MeshRenderer + Material + at least one additional component (e.g., a simple event wire or tag).
       - Root entity with all 200 children (or hierarchical children through groups).
       - All entity IDs use predictable prefixes: `mesh-0`, `light-0`, `cam-0`, `grp-0`, `multi-0`.
       - Validate the scene passes `SceneDocumentSchema.parse()`.

    2. **`syncDocs(docA: Y.Doc, docB: Y.Doc): void`** -- Bidirectional sync using `Y.encodeStateAsUpdate` / `Y.applyUpdate` (from existing collaboration.test.ts pattern).

    3. **`syncAll(docs: Y.Doc[]): void`** -- Sync all pairs in the array (N*(N-1)/2 operations for N docs). Use the pairwise approach from the research:
       ```typescript
       for (let i = 0; i < docs.length; i++) {
         for (let j = i + 1; j < docs.length; j++) {
           syncDocs(docs[i], docs[j]);
         }
       }
       ```

    4. **`docsConverged(docs: Y.Doc[]): boolean`** -- Check that all docs have identical ECSON by calling `yDocToEcson()` on each and comparing entity counts and key field values.

    **Step 2: Create headless 4-client stress test file**

    Create `apps/editor/__tests__/stress-test-collab.test.ts` with these test cases:

    1. **"4 clients editing 200-entity scene converge to consistent state"**
       - Client 0 initializes Y.Doc from the 200-entity scene.
       - Sync to clients 1-3.
       - Each client edits a disjoint subset of entities (client 0: mesh-0 to mesh-49, client 1: light-0 to light-29, etc.). Each edit renames the entity to `"Client{N}-{entityId}"`.
       - `syncAll(docs)`.
       - Assert all 4 docs produce identical ECSON via `yDocToEcson()`. Compare entity count (201 including root) and spot-check renamed entities.

    2. **"Concurrent edits to SAME entity converge via LWW per property"**
       - All 4 clients edit the same entity (`mesh-0`): client 0 changes name, client 1 changes a component property (position.x), client 2 changes another component property (material color), client 3 changes tags.
       - `syncAll(docs)`.
       - Assert all 4 edits are preserved in the merged state (different Y.Map keys, so all survive). This validates the nested Y.Map architecture from CF-P5-04/COLLAB-05.

    3. **"Rapid sequential edits from single client preserved"**
       - Client 0 makes 100 rapid sequential edits (rename entities mesh-0 through mesh-99) without intermediate sync.
       - `syncAll(docs)`.
       - Assert all 100 renames visible in all 4 docs.

    4. **"Network partition: delayed sync still converges"**
       - Clients 0 and 1 edit independently (no sync between them).
       - Clients 2 and 3 edit independently (no sync between them).
       - Now sync 0<->1, then sync 2<->3, then sync all.
       - Assert all 4 docs converge to the same state. This simulates network partitions.

    5. **"Y.Doc shape version preserved through 4-client sync"**
       - After initialization and sync, verify `_shapeVersion` is present in all 4 docs' meta maps.
       - Verify version equals `COLLAB_SHAPE_VERSION` from sync-bridge.ts.

    6. **"200-entity scene compiles to Canonical IR without error"**
       - Build the 200-entity scene, compile it to IR using the canonical-ir compiler.
       - Assert compilation succeeds (no errors, valid IR output).
       - This validates that stress-test entities are structurally valid all the way through the pipeline.

    **Timing note:** These are headless Vitest tests with no rendering. They should complete in under 10 seconds total. Use `describe("Stress Test: 4-Client Collaboration")` to group them.
  </action>
  <verify>
    - `pnpm turbo test --filter @riff3d/editor` passes (including the new stress tests)
    - The stress test file has 6+ test cases
    - All 6 tests pass (no flakiness -- these are deterministic headless tests)
    - The 200-entity scene builder produces exactly 201 entities (200 + root) validated by SceneDocumentSchema
  </verify>
  <done>
    - 200-entity scene builder creates a diverse scene with mesh, light, camera, group, and multi-component entities
    - 4-client headless CRDT tests prove convergence, conflict resolution, partition recovery, and shape version consistency
    - 200-entity scene compiles to Canonical IR without error
    - All stress tests pass deterministically
  </done>
</task>

<task type="auto">
  <name>Task 2: Playwright E2E stress test (multi-user collab, FPS, cross-engine)</name>
  <files>
    apps/editor/e2e/stress-collab.spec.ts
  </files>
  <action>
    Create `apps/editor/e2e/stress-collab.spec.ts` as a Playwright test file for the E2E stress scenarios that require a running editor and collab server. These tests are **not CI-blocking** -- they are local-only verification tests that produce evidence for the review gate. Mark them with an appropriate skip condition (e.g., `test.skip(!process.env.STRESS_TEST)` or `describe.skip`) so they do not run in regular CI.

    **Test 1: "Golden path end-to-end walkthrough"**

    Exercise the full user journey as a narrative (per CONTEXT.md locked decision):
    1. Navigate to the editor app (assume localhost:3000 or configured base URL).
    2. Create a new project (or load an existing one).
    3. Verify the 3D viewport renders (canvas element present, WebGL context active).
    4. Add an entity via the hierarchy panel (click add button, verify entity appears).
    5. Select the entity, verify inspector shows properties.
    6. Edit a property (change name via inspector input).
    7. Undo the edit (Ctrl+Z), verify name reverts.
    8. Save (Ctrl+S or auto-save trigger).
    9. Reload the page, verify the entity is still present (persistence).
    10. Enter play-test mode (click Play button), verify viewport enters play state.
    11. Stop play-test, verify editor state is preserved.

    This covers SC1 (collaborative build + play-test + save) from a single-user perspective. The multi-user extension depends on Hocuspocus server availability.

    **Test 2: "FPS measurement for 200-entity scene"**

    This test loads a 200-entity scene and measures rendering FPS:
    1. Create/load a project with a large entity count (this may require a pre-seeded project or programmatic entity creation through the UI).
    2. Wait for the scene to fully render (canvas present, no loading indicators).
    3. Measure FPS using the `requestAnimationFrame` + `performance.now()` pattern from the research:
       ```typescript
       const fps = await page.evaluate(() => {
         return new Promise<number>((resolve) => {
           let frames = 0;
           const start = performance.now();
           function count() {
             frames++;
             if (performance.now() - start >= 3000) {
               resolve(frames / ((performance.now() - start) / 1000));
             } else {
               requestAnimationFrame(count);
             }
           }
           requestAnimationFrame(count);
         });
       });
       ```
    4. Take the median of 3 runs.
    5. Log the FPS measurement. Assert `fps >= 25` (allowing noise margin below the 30 FPS floor per research pitfall #2).
    6. Note: This test requires a GPU-capable environment. If running in WSL2 headless, FPS may be unreliable. Document the measurement environment in the test output.

    **Test 3: "Cross-engine scene consistency" (if Babylon adapter available)**

    1. Load a project in the default engine (PlayCanvas).
    2. Capture the entity list from the hierarchy panel.
    3. Switch to Babylon.js engine via the engine switcher UI.
    4. Wait for the scene to rebuild.
    5. Capture the entity list again.
    6. Assert entity lists match (same names, same count).
    7. Switch back to PlayCanvas and verify again.

    **Test 4: "Multi-user collaboration E2E" (requires running Hocuspocus)**

    Skip this test if `NEXT_PUBLIC_COLLAB_URL` is not set. When available:
    1. Create 2 browser contexts (simulating 2 users).
    2. Both navigate to the same project.
    3. User A adds an entity.
    4. Wait for sync (use `expect.poll()` with 5-second timeout).
    5. Verify User B's hierarchy shows the new entity.
    6. User B renames the entity.
    7. Verify User A sees the rename.

    Note: 4-user E2E testing is covered by the headless Vitest stress tests (Task 1). The E2E test validates 2-user live behavior as a representative sample. Full 4-user E2E would be fragile and slow.

    **Important implementation notes:**
    - Wrap ALL E2E stress tests in `describe.skip` or a `STRESS_TEST` environment variable gate. These are NOT CI tests -- they produce evidence for the review gate when run locally.
    - Use generous timeouts (30 seconds for page loads, 10 seconds for sync assertions).
    - Use `expect.poll()` for async state assertions instead of fixed `waitForTimeout()`.
    - FPS measurements should include environment metadata (browser, GPU, OS) in console output for evidence packet inclusion.
    - If the golden path test requires authentication, use the anonymous sign-in flow or a test user from the existing Supabase setup.
  </action>
  <verify>
    - `apps/editor/e2e/stress-collab.spec.ts` exists and compiles (no TypeScript errors)
    - `npx playwright test --list` includes the stress test file (tests are listed but skipped by default)
    - Running with `STRESS_TEST=1 npx playwright test e2e/stress-collab.spec.ts` (if environment supports it) executes the tests
    - The FPS measurement helper returns a numeric value when run in a browser context
    - `pnpm turbo typecheck --filter @riff3d/editor` passes
  </verify>
  <done>
    - Golden path E2E walkthrough test covers the full user journey (create, edit, undo, save, play-test)
    - FPS measurement test targets 200-entity scene with 30 FPS floor (25 FPS allowing for noise)
    - Cross-engine consistency test validates entity list survives engine switch
    - Multi-user E2E test validates 2-user live sync (representative of 4-user headless tests)
    - All tests are local-only (gated behind STRESS_TEST env var), not CI-blocking
    - Evidence-ready: test output can be captured for the Phase 6 evidence packet
  </done>
</task>

</tasks>

<verification>
- `pnpm turbo test` passes (all packages, including new stress tests)
- Headless 4-client stress tests pass deterministically (no flakiness)
- E2E stress tests compile and are listed in Playwright test inventory
- 200-entity scene builder produces valid ECSON that compiles to IR
- FPS measurement infrastructure exists and returns numeric values
</verification>

<success_criteria>
The stress test suite produces quantitative evidence for all 5 Phase 6 success criteria: 4-client convergence (SC1), adapter conformance via cross-engine test (SC2), 200-entity FPS measurement (SC3), and carry-forward validation (SC4/SC5 via 06-01). The headless tests are deterministic and CI-safe. The E2E tests are local evidence-generators gated behind an environment variable.
</success_criteria>

<output>
After completion, create `.planning/phases/06-review-gate-core-platform/06-02-SUMMARY.md`
</output>
