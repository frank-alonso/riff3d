---
phase: 06-review-gate-core-platform
plan: 03
type: execute
wave: 3
depends_on: [06-01, 06-02]
files_modified:
  - .planning/reviews/phase-6/PHASE_6_PLAN_SUMMARY.md
  - .planning/reviews/phase-6/PHASE_6_PLAN_REVIEW.md
  - .planning/reviews/phase-6/PHASE_6_PLAN_REVIEW_RESPONSE.md
  - .planning/reviews/phase-6/PHASE_6_EVIDENCE.md
  - .planning/reviews/phase-6/PHASE_6_REVIEW.md
  - .planning/reviews/phase-6/PHASE_6_REVIEW_RESPONSE.md
  - .planning/reviews/phase-6/PHASE_6_FINAL_REVIEW.md
  - .planning/reviews/phase-6/PHASE_6_DECISION.md
  - .planning/reviews/phase-6/PHASE_6_MANUAL_CHECKLIST.md
  - .planning/STATE.md
  - .planning/ROADMAP.md
autonomous: false
requirements: []

must_haves:
  truths:
    - "All 5 Phase 6 success criteria are verified with evidence"
    - "All 3 carry-forward items (CF-P5-02, CF-P5-04, CF-P5-05) are resolved with proof"
    - "Codex expanded-scope review covers collaboration server deep-audit, sync bridge correctness, architecture boundaries, and cumulative debt"
    - "Architecture drift assessment verifies ECSON/PatchOps/IR contracts still match FOUNDATION.md"
    - "Cumulative PASS_WITH_CONDITIONS debt from Phases 1-5 is audited with no unresolved items"
    - "No S0 or S1 findings remain unresolved after review loop"
    - "Human manual checklist provides golden path walkthrough and executive summary"
    - "Gate decision is PASS, PASS_WITH_CONDITIONS, or FAIL with clear rationale"
  artifacts:
    - path: ".planning/reviews/phase-6/PHASE_6_PLAN_SUMMARY.md"
      provides: "Plan summary index for Codex pre-execution review"
    - path: ".planning/reviews/phase-6/PHASE_6_EVIDENCE.md"
      provides: "Comprehensive evidence packet with all success criteria, expanded-scope sections, stress test results"
    - path: ".planning/reviews/phase-6/PHASE_6_DECISION.md"
      provides: "Final gate decision with rationale and carry-forward table"
    - path: ".planning/reviews/phase-6/PHASE_6_MANUAL_CHECKLIST.md"
      provides: "Human walkthrough checklist with executive summary and golden path"
  key_links:
    - from: ".planning/reviews/phase-6/PHASE_6_EVIDENCE.md"
      to: "scripts/codex-review.sh"
      via: "Evidence fed to Codex for expanded-scope review"
      pattern: "codex-review.sh post-review 6"
    - from: ".planning/reviews/phase-6/PHASE_6_PLAN_SUMMARY.md"
      to: "scripts/codex-review.sh"
      via: "Plan summary fed to Codex for pre-execution review"
      pattern: "codex-review.sh plan-review 6"
---

<objective>
Run the full Phase 6 Review Gate: Core Platform. This includes the mandatory pre-execution plan review, evidence compilation for all 5 success criteria with expanded-scope sections, Codex post-execution deep-audit of the collaboration server, architecture drift assessment, cumulative debt audit, golden path walkthrough, and the formal gate decision.

Purpose: Phase 6 is the last checkpoint before the game layer (Phase 7+). It validates that collaboration, dual adapters, and the editor form a stable platform. Per CONTEXT.md: "This is an expanded-scope review gate covering cross-phase integration across Phases 4-5, cumulative debt from all prior PASS_WITH_CONDITIONS decisions, architecture drift, and carry-forward reconciliation."

Output: Pre-execution plan review artifacts, evidence packet, Codex review cycle artifacts, manual checklist, gate decision, updated STATE.md and ROADMAP.md.
</objective>

<execution_context>
@/home/frank/.claude/get-shit-done/workflows/execute-plan.md
@/home/frank/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/PHASE_REVIEW_PROTOCOL.md
@.planning/phases/06-review-gate-core-platform/06-CONTEXT.md
@.planning/phases/06-review-gate-core-platform/06-RESEARCH.md
@.planning/phases/06-review-gate-core-platform/06-01-SUMMARY.md
@.planning/phases/06-review-gate-core-platform/06-02-SUMMARY.md
@.planning/reviews/phase-3/PHASE_3_DECISION.md
@.planning/reviews/phase-4/PHASE_4_DECISION.md
@.planning/reviews/phase-5/PHASE_5_FINAL_REVIEW.md
@.planning/reviews/phase-5/PHASE_5_EVIDENCE.md
@scripts/codex-review.sh
@servers/collab/src/server.ts
@servers/collab/src/auth.ts
@servers/collab/src/persistence.ts
@apps/editor/src/collaboration/sync-bridge.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pre-execution plan review, evidence packet, and Codex review cycle</name>
  <files>
    .planning/reviews/phase-6/PHASE_6_PLAN_SUMMARY.md
    .planning/reviews/phase-6/PHASE_6_PLAN_REVIEW.md
    .planning/reviews/phase-6/PHASE_6_PLAN_REVIEW_RESPONSE.md
    .planning/reviews/phase-6/PHASE_6_EVIDENCE.md
    .planning/reviews/phase-6/PHASE_6_REVIEW.md
    .planning/reviews/phase-6/PHASE_6_REVIEW_RESPONSE.md
    .planning/reviews/phase-6/PHASE_6_FINAL_REVIEW.md
    .planning/reviews/phase-6/PHASE_6_DECISION.md
    .planning/reviews/phase-6/PHASE_6_MANUAL_CHECKLIST.md
  </files>
  <action>
    This task follows the established review gate pattern from Phase 3 (03-07) with the expanded scope required for Phase 6. Execute in order:

    **PART A: Pre-Execution Plan Review (Mandatory for Review Gates)**

    1. Create `.planning/reviews/phase-6/` directory.

    2. Write `PHASE_6_PLAN_SUMMARY.md` (thin index per PHASE_REVIEW_PROTOCOL.md):
       - Phase goal: Validate core platform stability before game layer
       - Plan files: 06-01 (carry-forwards), 06-02 (stress tests), 06-03 (review gate)
       - Key source files for auditor: `servers/collab/src/`, `apps/editor/src/collaboration/`, `packages/adapter-playcanvas/`, `packages/adapter-babylon/`, `packages/canonical-ir/`
       - Key constraints: 4 users, 200 entities, 30 FPS floor, cross-engine collab
       - Questions for auditor: Focus on collab server security (auth bypass risks), sync bridge correctness (field coverage gaps), carry-forward resolution adequacy

    3. Run Codex pre-execution plan review:
       ```bash
       ./scripts/codex-review.sh plan-review 6
       ```
       Save output to `PHASE_6_PLAN_REVIEW.md`.

    4. Write `PHASE_6_PLAN_REVIEW_RESPONSE.md` -- respond to Codex findings, incorporate actionable feedback. Include Review Value Assessment (HIGH/MEDIUM/LOW).

    **PART B: Run Full Test Suite and Capture Results**

    ```bash
    pnpm turbo typecheck lint test 2>&1 | tee /tmp/phase6-test-output.txt
    bash scripts/check-adapter-loc.sh 2>&1 | tee /tmp/phase6-loc-output.txt
    ```

    **PART C: Compile Evidence Packet**

    Write `PHASE_6_EVIDENCE.md` following the PHASE_REVIEW_PROTOCOL.md template. Cover ALL 5 success criteria with concrete evidence:

    **SC1: Two concurrent users can collaboratively build, play-test, and save without data loss**
    - Reference 06-02 headless 4-client stress test results (convergence, conflict resolution)
    - Reference existing collaboration.test.ts suite (38 tests)
    - Reference E2E golden path walkthrough results
    - Reference sync-bridge.ts origin tagging (feedback loop prevention)
    - Reference Y.UndoManager per-user undo isolation

    **SC2: Adapter conformance passes at 90%+ for both PlayCanvas and Babylon.js**
    - Reference conformance test suite results from test output
    - Count pass/fail per adapter, compute percentage
    - Reference visual regression test results (per-fixture tolerance bands)
    - Reference cross-engine consistency from 06-02 stress tests

    **SC3: Editor handles 100+ entities without FPS drop below baseline**
    - Reference 200-entity scene stress test results (FPS measurement)
    - If FPS measurement was run, include numeric results with environment metadata
    - If WSL2 prevented reliable FPS measurement, document the constraint and reference the FPS measurement infrastructure that exists for local verification
    - Reference 200-entity scene IR compilation success from headless tests

    **SC4: All carry-forward actions from Phase 4-5 reviews resolved or re-scheduled**
    - Reference 06-01 summary for CF-P5-02 (avatar yaw), CF-P5-04 (shape versioning), CF-P5-05 (persistence tests)
    - Reference Phase 5 evidence for CF-P4-01 through CF-P4-07 resolution
    - Enumerate any remaining carry-forwards and their targets

    **SC5: No unaddressed cumulative technical debt from PASS_WITH_CONDITIONS**
    - Audit all PASS_WITH_CONDITIONS decisions from Phases 1-5:
      - Phase 1: 4 S2 + 1 S3 -- all resolved in Phase 2/3
      - Phase 2: 2 S1 fixed, 2 waived, 5 CFs -- all resolved in Phase 3
      - Phase 3: 5 CFs -- 4 resolved in Phase 4/5, CF-P3-05 targets Phase 7
      - Phase 4: 1 S1 waived, 7 CFs -- 6 resolved in Phase 5, CF-P4-04 targets Phase 7
      - Phase 5: PASS (no conditions)
    - Verify resolved items by cross-referencing STATE.md and phase summaries

    **Include expanded-scope sections (required for review gates per PHASE_REVIEW_PROTOCOL.md):**

    **Cross-Phase Integration (Phases 4-5):**
    - Collaboration + dual adapters: Does engine switching work during collab? Reference cross-engine collab test.
    - Adapter conformance + collaboration: Do both adapters reflect collaborative edits correctly?
    - Editor features + collaboration: Do undo, copy/paste, save work in collab mode?

    **Cumulative Debt Assessment:**
    - Table of all PASS_WITH_CONDITIONS decisions with resolution status
    - Identify any compounding patterns
    - List Phase 7+ deferred items (CF-P3-05, CF-P4-04, CF-04)

    **Architecture Drift Assessment:**
    - Verify ECSON schema unchanged through Phases 4-5 (no drift from FOUNDATION.md)
    - Verify PatchOps as single mutation path (with documented exceptions: loadProject, playtest stop, switchEngine)
    - Verify adapter boundary: adapters only import from @riff3d/canonical-ir (mechanically enforced by ESLint no-restricted-imports since Phase 5)
    - Verify package dependency direction: ecson -> patchops -> canonical-ir -> adapters -> editor
    - Reference LoC budget check output

    **Carry-Forward Reconciliation:**
    - CF-P5-02: Resolved in 06-01 (avatar yaw)
    - CF-P5-04: Resolved in 06-01 (shape versioning)
    - CF-P5-05: Resolved in 06-01 (persistence tests)
    - List any new carry-forwards from Phase 6 itself

    **Phase 6-Specific Sections:**
    - Stress Test Results: 4-client convergence, 200-entity performance, network simulation, cross-engine collab
    - Golden Path Walkthrough: Results from E2E test or manual execution
    - Collab Server Audit Focus Areas for Codex: Prioritized list of files and concern areas

    **PART D: Run Codex Post-Execution Review**

    The Codex prompt must emphasize the prioritized focus areas from CONTEXT.md:

    1. **Collaboration Server Deep-Audit (Priority 1):**
       - `servers/collab/src/server.ts` -- server config, auth hook, disconnect handling
       - `servers/collab/src/auth.ts` -- JWT verification, project access, color assignment
       - `servers/collab/src/persistence.ts` -- Y.Doc binary persistence, ECSON dual-write
       - Focus: auth bypass risks, persistence data loss, error handling gaps, race conditions

    2. **Sync Bridge Correctness (Priority 2):**
       - `apps/editor/src/collaboration/sync-bridge.ts` -- bidirectional ECSON<->Y.Doc
       - Focus: field coverage (wiring, environment, metadata), origin tagging, fail-closed validation

    3. **Architecture Boundary Verification (Priority 3):**
       - Adapter imports only from canonical-ir
       - no-restricted-imports ESLint rules still active
       - No new PatchOps bypass paths in Phase 4/5

    4. **Cumulative Debt Triage (Priority 4):**
       - All PASS_WITH_CONDITIONS decisions reviewed
       - Resolved items verified
       - Compounding patterns flagged

    ```bash
    ./scripts/codex-review.sh post-review 6
    ```
    Save to `PHASE_6_REVIEW.md`.

    **PART E: Write Review Response**

    Write `PHASE_6_REVIEW_RESPONSE.md`:
    - For each finding: classify severity (S0-S3), agree/disagree, action taken
    - Fix S0/S1 issues immediately and re-run affected tests
    - S2/S3: triage as fix-now, carry-forward, or defer with rationale
    - Include Review Value Assessment
    - Per CONTEXT.md: "Issues found during review that require code changes are fixed within Phase 6"

    **PART F: Run Codex Final Review**

    ```bash
    ./scripts/codex-review.sh final-review 6
    ```
    Save to `PHASE_6_FINAL_REVIEW.md`.

    **PART G: Write Gate Decision**

    Write `PHASE_6_DECISION.md` based on Codex final review:
    - PASS: No S0/S1 open, all criteria met, all carry-forwards resolved
    - PASS_WITH_CONDITIONS: S2 carry-forwards with clear targets, all criteria fundamentally met (per CONTEXT.md: "pragmatic gate")
    - FAIL: S0/S1 unresolved or success criterion not met

    Include:
    - Conditions (if any)
    - Carry-forward actions with targets
    - Cumulative debt summary

    **PART H: Create Manual Checklist**

    Write `PHASE_6_MANUAL_CHECKLIST.md` with executive summary and golden path walkthrough:

    ```markdown
    # Phase 6 Manual Walkthrough Checklist

    ## Executive Summary (Spot-Check, 2 minutes)
    - [ ] Open editor, load a project -- scene renders in 3D viewport
    - [ ] Move an entity -- gizmo works, undo reverts
    - [ ] Switch to Babylon.js -- scene re-renders consistently
    - [ ] Switch back to PlayCanvas -- scene intact
    - [ ] Run `pnpm turbo test` -- all green

    ## Golden Path (Full Walkthrough, 15-20 minutes)
    ### Solo Editing
    - [ ] Create new project from dashboard
    - [ ] Add entity, edit transform, edit inspector property
    - [ ] Undo/redo works across edit types
    - [ ] Save and reload -- state persists
    - [ ] Play-test -- runtime runs without page reload
    - [ ] Stop play-test -- editor state preserved

    ### Engine Switching
    - [ ] Switch to Babylon.js via engine switcher
    - [ ] Scene renders with consistent entities
    - [ ] Edit a property -- delta update works (no full rebuild flicker)
    - [ ] Switch back to PlayCanvas -- no data loss

    ### Collaboration (requires collab server)
    - [ ] Open two tabs to same project (NEXT_PUBLIC_COLLAB_URL set)
    - [ ] Tab A creates entity -- Tab B sees it within 2 seconds
    - [ ] Tab B renames entity -- Tab A sees rename
    - [ ] Colored collaborator bar shows both users
    - [ ] Tab A selects entity -- Tab B hierarchy shows colored border
    - [ ] Tab A locks entity -- Tab B sees lock icon, inspector read-only
    - [ ] Tab A unlocks -- Tab B can edit again
    - [ ] Tab A toggles avatar mode -- Tab B sees capsule
    - [ ] Tab A undoes -- only Tab A's change reverts, Tab B unaffected

    ### Performance
    - [ ] Editor feels responsive with default scene
    - [ ] No visible lag during property editing
    - [ ] Engine switch completes in under 3 seconds

    ### Contracts
    - [ ] Run `pnpm turbo test --filter @riff3d/conformance` -- all pass
    - [ ] Run `bash scripts/check-adapter-loc.sh` -- PASS
    ```
  </action>
  <verify>
    Verify all review artifacts exist in `.planning/reviews/phase-6/`:
    - PHASE_6_PLAN_SUMMARY.md (pre-execution plan summary)
    - PHASE_6_PLAN_REVIEW.md (Codex plan review)
    - PHASE_6_PLAN_REVIEW_RESPONSE.md (Claude response)
    - PHASE_6_EVIDENCE.md (comprehensive evidence packet)
    - PHASE_6_REVIEW.md (Codex post-execution review)
    - PHASE_6_REVIEW_RESPONSE.md (Claude response with fixes)
    - PHASE_6_FINAL_REVIEW.md (Codex final review)
    - PHASE_6_DECISION.md (formal gate decision)
    - PHASE_6_MANUAL_CHECKLIST.md (human walkthrough)
    Verify `pnpm turbo test` passes after any review fixes.
    Verify gate decision is recorded.
  </verify>
  <done>
    - Pre-execution plan review completed (mandatory for review gates)
    - Evidence packet covers all 5 success criteria with expanded-scope sections
    - Codex deep-audit of collaboration server completed with prioritized focus areas
    - All S0/S1 findings fixed within Phase 6 (per CONTEXT.md: "gate isn't done until issues are resolved")
    - Gate decision recorded with carry-forward table
    - Manual checklist ready for human golden path walkthrough
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification of Phase 6 Review Gate</name>
  <files>.planning/reviews/phase-6/PHASE_6_DECISION.md</files>
  <action>
    Human verification of the Phase 6 Review Gate: Core Platform.

    What was built: Expanded-scope review covering 3 carry-forward items resolved (avatar yaw, shape versioning, persistence tests), 4-client CRDT convergence on 200-entity scenes, cross-engine collaboration correctness, architecture drift assessment (ECSON/PatchOps/IR contracts), cumulative PASS_WITH_CONDITIONS debt from Phases 1-5, Codex deep-audit of collaboration server code, and full golden path end-to-end coverage.

    Steps to verify:
    1. Review `.planning/reviews/phase-6/PHASE_6_DECISION.md` for gate decision and conditions
    2. Run the executive summary spot-check from PHASE_6_MANUAL_CHECKLIST.md:
       - Open editor, load a project -- scene renders
       - Move an entity -- gizmo works, undo reverts
       - Switch to Babylon.js and back -- scene consistent
       - Run `pnpm turbo test` -- all green
    3. Optionally run the full golden path walkthrough (15-20 min) including collaboration
    4. Review any PASS_WITH_CONDITIONS carry-forward items
    5. Review Codex findings in PHASE_6_REVIEW.md and responses in PHASE_6_REVIEW_RESPONSE.md

    Type "approved" to accept the gate decision, or describe issues to investigate.
  </action>
  <verify>Gate decision reviewed and accepted by human.</verify>
  <done>Phase 6 Review Gate verified by human. Gate decision accepted.</done>
</task>

</tasks>

<verification>
- All review artifacts present in `.planning/reviews/phase-6/`
- All 5 success criteria verified with evidence
- Pre-execution plan review completed (mandatory for review gates)
- Codex expanded-scope review with collab server deep-audit completed
- Architecture drift assessment confirms contract alignment
- Cumulative debt audit shows no unresolved items
- Gate decision is PASS, PASS_WITH_CONDITIONS, or FAIL
- `pnpm turbo test` passes after all review fixes
- Manual checklist exists with golden path walkthrough
- STATE.md and ROADMAP.md updated to reflect Phase 6 completion
</verification>

<success_criteria>
Phase 6 Review Gate is complete: all 5 success criteria verified, all 3 carry-forwards resolved, stress tests prove platform stability under load, Codex expanded-scope audit performed with collaboration server deep-audit, cumulative debt assessed, architecture verified against original contracts, gate decision issued, and human verification confirms the core platform is solid for Phase 7 (Game Runtime & Behaviors).
</success_criteria>

<output>
After completion, create `.planning/phases/06-review-gate-core-platform/06-03-SUMMARY.md`

After human approval, update:
- `.planning/STATE.md` -- Phase 6 complete, Phase 7 ready
- `.planning/ROADMAP.md` -- Phase 6 progress updated, plans list finalized
</output>
