---
phase: 06-review-gate-core-platform
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/editor/src/collaboration/avatar-controller.ts
  - apps/editor/src/collaboration/sync-bridge.ts
  - servers/collab/src/persistence.ts
  - servers/collab/__tests__/persistence.test.ts
  - servers/collab/vitest.config.ts
  - servers/collab/tsconfig.json
autonomous: true
requirements: []

must_haves:
  truths:
    - "Avatar mode preserves the user's current camera yaw on entry instead of resetting to 0"
    - "Y.Doc includes a _shapeVersion field in the meta map, set on initialization and checked on load"
    - "Server-side persistence decode/re-encode is tested with unit tests that run via pnpm turbo test"
  artifacts:
    - path: "apps/editor/src/collaboration/avatar-controller.ts"
      provides: "Fixed yaw initialization from camera euler angles"
      contains: "euler"
    - path: "apps/editor/src/collaboration/sync-bridge.ts"
      provides: "COLLAB_SHAPE_VERSION constant, version stamping in initializeYDoc, version check in yDocToEcson"
      contains: "COLLAB_SHAPE_VERSION"
    - path: "servers/collab/__tests__/persistence.test.ts"
      provides: "Unit tests for persistence decode/re-encode, Y.Doc round-trip, syncEcsonToProject correctness"
    - path: "servers/collab/vitest.config.ts"
      provides: "Vitest configuration for collab server package"
  key_links:
    - from: "apps/editor/src/collaboration/avatar-controller.ts"
      to: "camera entity euler angles"
      via: "getEulerAngles() or equivalent on mode entry"
      pattern: "euler|getEulerAngles|yaw.*camera"
    - from: "apps/editor/src/collaboration/sync-bridge.ts"
      to: "Y.Doc meta map"
      via: "_shapeVersion field read/write"
      pattern: "_shapeVersion"
    - from: "servers/collab/__tests__/persistence.test.ts"
      to: "servers/collab/src/persistence.ts"
      via: "Import and test of syncEcsonToProject or equivalent"
      pattern: "persistence|syncEcsonToProject"
---

<objective>
Resolve the three Phase 6 carry-forward items (CF-P5-02, CF-P5-04, CF-P5-05) before stress testing and the review gate audit. These are targeted bug fixes, a minimal enhancement, and new test coverage -- all small and well-scoped.

Purpose: The carry-forward fixes must land before stress tests run (06-02) and before the evidence packet is compiled (06-03), so the Codex review audits the final codebase. Per CONTEXT.md locked decision: "Carry-forward fixes are implemented inside Phase 6 (within the review plan), not as a separate pre-phase step."

Output: Fixed avatar yaw initialization, collab-doc shape versioning in sync-bridge, server-side persistence unit tests.
</objective>

<execution_context>
@/home/frank/.claude/get-shit-done/workflows/execute-plan.md
@/home/frank/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-review-gate-core-platform/06-RESEARCH.md
@apps/editor/src/collaboration/avatar-controller.ts
@apps/editor/src/collaboration/sync-bridge.ts
@servers/collab/src/persistence.ts
@apps/editor/__tests__/collaboration.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix avatar yaw initialization (CF-P5-02) and add collab-doc shape versioning (CF-P5-04)</name>
  <files>
    apps/editor/src/collaboration/avatar-controller.ts
    apps/editor/src/collaboration/sync-bridge.ts
  </files>
  <action>
    **CF-P5-02: Avatar yaw initialization fix**

    In `avatar-controller.ts`, the constructor (around line 139) currently sets `this.yaw = 0` with a comment "for simplicity." Fix this to read the current camera yaw on avatar mode entry.

    The camera entity provides euler angles. The AvatarController constructor receives a camera interface. Extract the current Y-axis rotation (yaw) from the camera's euler angles:

    ```typescript
    // Instead of: this.yaw = 0;
    // Read camera's current orientation
    const euler = camera.getEulerAngles();
    this.yaw = euler.y;  // Preserve the camera yaw the user was looking at
    this.pitch = euler.x; // Also preserve pitch for continuity
    ```

    The exact camera API depends on the PlayCanvas camera entity interface used in the constructor signature. Check the existing `camera` parameter type and use its available rotation getter. If it provides `getEulerAngles()`, use that. If it provides a rotation quaternion, convert to euler and extract yaw. The key constraint: on avatar mode entry, the user's camera direction must be preserved, not reset to (0,0,0).

    Also update the comment block that says "for simplicity" to explain the fix.

    **CF-P5-04: Collab-doc shape versioning**

    In `sync-bridge.ts`, add minimal shape versioning per the research recommendation:

    1. Add a `COLLAB_SHAPE_VERSION = 1` constant at module level.

    2. In `initializeYDoc()`, after creating the meta Y.Map, stamp the version:
       ```typescript
       yMeta.set("_shapeVersion", COLLAB_SHAPE_VERSION);
       ```

    3. In `yDocToEcson()`, before reconstructing the ECSON document, check the version:
       ```typescript
       const yMeta = yDoc.getMap("meta");
       const version = (yMeta.get("_shapeVersion") as number) ?? 0;
       if (version < COLLAB_SHAPE_VERSION) {
         migrateCollabShape(yDoc, version, COLLAB_SHAPE_VERSION);
       }
       ```

    4. Add a `migrateCollabShape()` function that handles version 0 -> 1 migration. For version 0 (implicit -- no version field), the migration simply stamps `_shapeVersion = 1` on the meta map (no structural changes, since version 1 IS the current shape). This establishes the pattern for future migrations without over-engineering.

    5. Export `COLLAB_SHAPE_VERSION` for use in tests.

    Do NOT build a migration registry, JSON Schema validation, or multi-hop migration chains. The minimal viable versioning is: check version, migrate if old, stamp new version.
  </action>
  <verify>
    - `pnpm turbo typecheck --filter @riff3d/editor` passes (avatar-controller change compiles)
    - `pnpm turbo test --filter @riff3d/editor` passes (existing collaboration tests still green)
    - Grep for `COLLAB_SHAPE_VERSION` in sync-bridge.ts confirms the constant exists
    - Grep for `_shapeVersion` in sync-bridge.ts confirms version stamping and checking are present
    - Grep for `this.yaw = 0` in avatar-controller.ts returns no results (yaw reset removed)
  </verify>
  <done>
    - Avatar controller reads camera euler angles on construction instead of resetting yaw to 0 (CF-P5-02 resolved)
    - Sync bridge stamps _shapeVersion=1 on Y.Doc init and checks/migrates on yDocToEcson load (CF-P5-04 resolved)
    - All existing tests still pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Add server-side persistence unit tests (CF-P5-05)</name>
  <files>
    servers/collab/__tests__/persistence.test.ts
    servers/collab/vitest.config.ts
    servers/collab/tsconfig.json
    servers/collab/package.json
  </files>
  <action>
    **CF-P5-05: Server-side unit tests for collab persistence decode/re-encode**

    The `servers/collab/` package currently has zero test files. Create test infrastructure and write tests for the persistence decode/re-encode path.

    **Step 1: Set up test infrastructure for servers/collab**

    Create `servers/collab/vitest.config.ts` following the pattern used by other packages (e.g., `packages/ecson/vitest.config.ts`). Minimal config:
    ```typescript
    import { defineConfig } from "vitest/config";
    export default defineConfig({
      test: {
        include: ["__tests__/**/*.test.ts"],
      },
    });
    ```

    Ensure `servers/collab/package.json` has a `"test"` script: `"test": "vitest run"`. If it does not, add it. Also ensure `vitest` is available (either as a devDependency or via workspace).

    Update `servers/collab/tsconfig.json` if needed to include the `__tests__` directory.

    **Step 2: Create persistence test file**

    Create `servers/collab/__tests__/persistence.test.ts` with tests covering:

    1. **Y.Doc round-trip through encode/decode preserves all ECSON fields:**
       - Create a Y.Doc, populate it with the sync-bridge `initializeYDoc` pattern (meta, entities as nested Y.Maps, assets, wiring, environment, metadata).
       - Encode with `Y.encodeStateAsUpdate(doc)`.
       - Decode into a fresh Y.Doc with `Y.applyUpdate(newDoc, state)`.
       - Verify all fields survive: meta.id, meta.name, entities with components, assets, wiring array, environment, metadata.

    2. **syncEcsonToProject produces valid ECSON from Y.Doc state:**
       - The `syncEcsonToProject` function in persistence.ts is currently private (not exported). To test it, either:
         (a) Export it for testing (preferred -- add `export` keyword), or
         (b) Test the behavior indirectly through the Database extension's store() method with a mocked Supabase client.
       - Option (a) is simpler and more direct. Export `syncEcsonToProject` and test it directly.
       - Create a Y.Doc with known ECSON structure, encode it to state, call `syncEcsonToProject` with a mock Supabase client, and verify the update payload contains valid ECSON that would pass `SceneDocumentSchema.safeParse()`.

    3. **Persistence fetch returns null for unknown project (first session):**
       - Mock Supabase to return `{ data: null, error: { code: 'PGRST116', message: 'not found' } }`.
       - Verify fetch returns null (the Hocuspocus convention for "no prior state").

    4. **Shape version is present after initialization:**
       - Initialize a Y.Doc with `initializeYDoc` from sync-bridge.ts, encode it, decode in a fresh doc.
       - Verify `_shapeVersion` field exists in the meta map.

    **Mock strategy:** Use `vi.fn()` to mock the Supabase client methods (`from().select().eq().single()`, `from().upsert()`, `from().update().eq()`). Do NOT require a running Supabase instance -- these tests must run in CI without any external dependencies. Follow the mock pattern used in `apps/editor/__tests__/collaboration.test.ts`.

    Target: At least 5 test cases covering the critical persistence paths.
  </action>
  <verify>
    - `pnpm turbo test --filter @riff3d/collab-server` passes (new test file runs successfully)
    - `pnpm turbo test` passes (all packages including the new collab-server tests)
    - `servers/collab/__tests__/persistence.test.ts` exists with 5+ test cases
    - `pnpm turbo typecheck --filter @riff3d/collab-server` passes
  </verify>
  <done>
    - servers/collab has Vitest configuration and test infrastructure
    - At least 5 persistence unit tests covering: Y.Doc round-trip, ECSON reconstruction, fetch-null-for-new, shape version, and store-upsert behavior
    - All tests pass in CI (no external service dependencies)
    - CF-P5-05 resolved
  </done>
</task>

</tasks>

<verification>
- All 3 carry-forward items resolved: CF-P5-02 (avatar yaw), CF-P5-04 (shape versioning), CF-P5-05 (persistence tests)
- `pnpm turbo typecheck lint test` passes across all packages
- No regressions in existing 690+ test suite
- New persistence tests add coverage to previously untested servers/collab/ package
</verification>

<success_criteria>
All three Phase 6 carry-forwards are resolved with code changes committed and tests passing. The codebase is in its final state for stress testing (06-02) and evidence compilation (06-03).
</success_criteria>

<output>
After completion, create `.planning/phases/06-review-gate-core-platform/06-01-SUMMARY.md`
</output>
