---
phase: 01-contracts-testing-spine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - pnpm-workspace.yaml
  - turbo.json
  - tsconfig.base.json
  - vitest.config.ts
  - .github/workflows/ci.yml
  - .eslintrc.cjs
  - .gitignore
  - packages/ecson/package.json
  - packages/ecson/tsconfig.json
  - packages/ecson/vitest.config.ts
  - packages/ecson/src/index.ts
  - packages/patchops/package.json
  - packages/patchops/tsconfig.json
  - packages/patchops/vitest.config.ts
  - packages/patchops/src/index.ts
  - packages/canonical-ir/package.json
  - packages/canonical-ir/tsconfig.json
  - packages/canonical-ir/vitest.config.ts
  - packages/canonical-ir/src/index.ts
  - packages/fixtures/package.json
  - packages/fixtures/tsconfig.json
  - packages/fixtures/vitest.config.ts
  - packages/fixtures/src/index.ts
  - packages/conformance/package.json
  - packages/conformance/tsconfig.json
  - packages/conformance/vitest.config.ts
  - packages/conformance/src/index.ts
  - apps/editor/package.json
autonomous: true
requirements:
  - CORE-09

must_haves:
  truths:
    - "Running `pnpm install` from repo root installs all workspace packages without errors"
    - "Running `pnpm turbo typecheck lint test` from repo root passes for all packages"
    - "Each package can only import from its declared dependencies (no circular deps)"
    - "CI pipeline runs typecheck, lint, and test on every push to main and on PRs"
    - "Package dependency direction is enforced: ecson has zero internal deps, patchops depends on ecson, canonical-ir depends on ecson, fixtures depends on ecson, conformance depends on canonical-ir and fixtures"
  artifacts:
    - path: "package.json"
      provides: "Root workspace package.json with pnpm scripts"
      contains: "turbo"
    - path: "pnpm-workspace.yaml"
      provides: "Workspace package discovery"
      contains: "packages/*"
    - path: "turbo.json"
      provides: "Turborepo task pipeline with caching"
      contains: "dependsOn"
    - path: "tsconfig.base.json"
      provides: "Shared strict TypeScript configuration"
      contains: "noUncheckedIndexedAccess"
    - path: ".github/workflows/ci.yml"
      provides: "GitHub Actions CI pipeline"
      contains: "pnpm turbo"
    - path: "packages/ecson/package.json"
      provides: "ECSON package with zero internal deps"
      contains: "@riff3d/ecson"
    - path: "packages/patchops/package.json"
      provides: "PatchOps package depending on ecson"
      contains: "@riff3d/ecson"
    - path: "packages/canonical-ir/package.json"
      provides: "Canonical IR package depending on ecson"
      contains: "@riff3d/ecson"
  key_links:
    - from: "packages/patchops/package.json"
      to: "packages/ecson"
      via: "workspace:* dependency"
      pattern: "@riff3d/ecson.*workspace"
    - from: "packages/canonical-ir/package.json"
      to: "packages/ecson"
      via: "workspace:* dependency"
      pattern: "@riff3d/ecson.*workspace"
    - from: "turbo.json"
      to: "all packages"
      via: "^build dependsOn for topological ordering"
      pattern: "\\^build"
---

<objective>
Scaffold the pnpm + Turborepo monorepo with all 5 core packages (ecson, patchops, canonical-ir, fixtures, conformance), an editor app placeholder, strict TypeScript configuration, linting, and a GitHub Actions CI pipeline.

Purpose: Establish the project skeleton so all subsequent plans can work within established package boundaries. This is the foundation that enforces the dependency direction rule (ecson -> patchops -> canonical-ir -> adapters -> editor) from day one.

Output: A fully functional monorepo where `pnpm install && pnpm turbo typecheck lint test` passes, CI runs on every push, and each package has its own TypeScript config, Vitest config, and correctly scoped dependencies.
</objective>

<execution_context>
@/home/frank/.claude/get-shit-done/workflows/execute-plan.md
@/home/frank/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-contracts-testing-spine/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create monorepo scaffold with all packages and shared configuration</name>
  <files>
    package.json
    pnpm-workspace.yaml
    turbo.json
    tsconfig.base.json
    vitest.config.ts
    .gitignore
    .eslintrc.cjs
    packages/ecson/package.json
    packages/ecson/tsconfig.json
    packages/ecson/vitest.config.ts
    packages/ecson/src/index.ts
    packages/patchops/package.json
    packages/patchops/tsconfig.json
    packages/patchops/vitest.config.ts
    packages/patchops/src/index.ts
    packages/canonical-ir/package.json
    packages/canonical-ir/tsconfig.json
    packages/canonical-ir/vitest.config.ts
    packages/canonical-ir/src/index.ts
    packages/fixtures/package.json
    packages/fixtures/tsconfig.json
    packages/fixtures/vitest.config.ts
    packages/fixtures/src/index.ts
    packages/conformance/package.json
    packages/conformance/tsconfig.json
    packages/conformance/vitest.config.ts
    packages/conformance/src/index.ts
    apps/editor/package.json
  </files>
  <action>
    Create the monorepo structure:

    1. **Root package.json**: name `riff3d`, private, type `module`, scripts for `build`, `test`, `typecheck`, `lint` (all via `turbo`). devDependencies: `turbo`, `typescript` ^5.7, `eslint` ^9, `vitest` ^4, `@fast-check/vitest`, `fast-check` ^4.

    2. **pnpm-workspace.yaml**: packages glob `packages/*` and `apps/*`.

    3. **turbo.json**: Schema from turbo.build. Tasks: `build` (dependsOn `^build`, outputs `dist/**`), `test` (dependsOn `^build`, no outputs), `typecheck` (dependsOn `^build`, no outputs), `lint` (no deps, no outputs).

    4. **tsconfig.base.json**: Strict mode with `strict: true`, `noUncheckedIndexedAccess: true`, `exactOptionalPropertyTypes: true`, `noImplicitReturns: true`, `noFallthroughCasesInSwitch: true`, target `ES2022`, module `ESNext`, moduleResolution `bundler`, `declaration: true`, `declarationMap: true`, `sourceMap: true`, `esModuleInterop: true`, `skipLibCheck: true`.

    5. **Root vitest.config.ts**: Use `projects: ['packages/*']` for monorepo test discovery.

    6. **Each package** (`ecson`, `patchops`, `canonical-ir`, `fixtures`, `conformance`):
       - `package.json`: name `@riff3d/{name}`, private, type `module`, exports field restricting to `./src/index.ts`, scripts (test, typecheck, lint). Dependencies per package:
         - ecson: `zod` ^3.25 (Zod v4 via dual-publish), `nanoid` ^5
         - patchops: `zod`, `nanoid`, `@riff3d/ecson` workspace:*
         - canonical-ir: `zod`, `@riff3d/ecson` workspace:*
         - fixtures: `@riff3d/ecson` workspace:*
         - conformance: `@riff3d/canonical-ir` workspace:*, `@riff3d/fixtures` workspace:*, `@riff3d/patchops` workspace:*
       - `tsconfig.json`: extends `../../tsconfig.base.json`, compilerOptions with `outDir: ./dist`, `rootDir: ./src`, include `src/**/*.ts`
       - `vitest.config.ts`: include `__tests__/**/*.test.ts` and `src/**/*.test.ts`
       - `src/index.ts`: placeholder export (e.g., `export const VERSION = '0.0.1';`)

    7. **apps/editor/package.json**: Minimal placeholder (`@riff3d/editor`, private, no dependencies yet).

    8. **.gitignore**: Add `node_modules/`, `dist/`, `.turbo/`, `*.tsbuildinfo`, `.env`, `.env.local`.

    9. **.eslintrc.cjs**: Minimal ESLint config for TypeScript (extends recommended + typescript-eslint). Add rule to prevent imports from packages not in declared dependencies.

    10. Run `pnpm install` to install all dependencies and verify workspace links.

    IMPORTANT: Use pnpm catalogs in `pnpm-workspace.yaml` to define shared dependency versions (zod, nanoid, typescript, vitest) once, then reference them in each package.json. This ensures version alignment across the monorepo.

    IMPORTANT: The `exports` field in each package.json should use `"./": { "import": "./src/index.ts", "types": "./src/index.ts" }` pattern for TypeScript monorepo development (no build step needed for internal packages during development).
  </action>
  <verify>
    Run `pnpm install` -- must succeed with no errors.
    Run `pnpm turbo typecheck` -- must pass for all packages.
    Run `pnpm turbo lint` -- must pass for all packages.
    Run `pnpm turbo test` -- must pass (trivially, no tests yet).
    Verify workspace links: `pnpm ls -r --depth 0` shows correct dependency graph.
  </verify>
  <done>
    All 5 packages + editor app placeholder exist with correct dependency boundaries. `pnpm install && pnpm turbo typecheck lint test` passes. Workspace dependency graph is correct: ecson has no internal deps, patchops depends on ecson, canonical-ir depends on ecson, fixtures depends on ecson, conformance depends on canonical-ir + fixtures + patchops.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions CI pipeline and validate end-to-end</name>
  <files>
    .github/workflows/ci.yml
  </files>
  <action>
    Create `.github/workflows/ci.yml`:

    ```yaml
    name: CI
    on:
      push:
        branches: [main]
      pull_request:
        branches: [main]

    jobs:
      check:
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4
          - uses: pnpm/action-setup@v4
            with:
              version: 9
          - uses: actions/setup-node@v4
            with:
              node-version: 22
              cache: 'pnpm'
          - run: pnpm install --frozen-lockfile
          - run: pnpm turbo typecheck lint test
    ```

    Also add a simple smoke test in `packages/ecson/__tests__/smoke.test.ts` that imports from the package and asserts the version export exists. This proves the test pipeline works end-to-end.

    Run the full pipeline locally to verify: `pnpm turbo typecheck lint test`
  </action>
  <verify>
    `pnpm turbo typecheck lint test` passes with the smoke test running.
    `.github/workflows/ci.yml` exists and is valid YAML.
    The smoke test in `packages/ecson/__tests__/smoke.test.ts` passes.
  </verify>
  <done>
    CI pipeline configuration exists and the local equivalent (`pnpm turbo typecheck lint test`) passes end-to-end including at least one real test. The monorepo scaffold is complete and ready for schema implementation.
  </done>
</task>

</tasks>

<verification>
- `pnpm install` succeeds
- `pnpm turbo typecheck lint test` passes
- `pnpm ls -r --depth 0` shows correct dependency graph
- `.github/workflows/ci.yml` exists
- All 5 packages have package.json, tsconfig.json, vitest.config.ts, src/index.ts
- No circular dependencies between packages
</verification>

<success_criteria>
The monorepo is fully scaffolded with correct package boundaries, shared TypeScript config, Turborepo caching, and a CI pipeline. A developer (or Claude) can immediately start implementing schemas in `packages/ecson/src/` with all tooling working.
</success_criteria>

<output>
After completion, create `.planning/phases/01-contracts-testing-spine/01-01-SUMMARY.md`
</output>
