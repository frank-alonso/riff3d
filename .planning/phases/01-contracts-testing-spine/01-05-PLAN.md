---
phase: 01-contracts-testing-spine
plan: 05
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - packages/ecson/src/registry/registry.ts
  - packages/ecson/src/registry/types.ts
  - packages/ecson/src/registry/components/mesh-renderer.ts
  - packages/ecson/src/registry/components/light.ts
  - packages/ecson/src/registry/components/camera.ts
  - packages/ecson/src/registry/components/rigid-body.ts
  - packages/ecson/src/registry/components/collider.ts
  - packages/ecson/src/registry/components/audio-source.ts
  - packages/ecson/src/registry/components/audio-listener.ts
  - packages/ecson/src/registry/components/animation.ts
  - packages/ecson/src/registry/components/material.ts
  - packages/ecson/src/registry/components/score-zone.ts
  - packages/ecson/src/registry/components/kill-zone.ts
  - packages/ecson/src/registry/components/spawner.ts
  - packages/ecson/src/registry/components/trigger-zone.ts
  - packages/ecson/src/registry/components/checkpoint.ts
  - packages/ecson/src/registry/components/moving-platform.ts
  - packages/ecson/src/registry/components/path-follower.ts
  - packages/ecson/src/registry/components/timer.ts
  - packages/ecson/src/registry/components/index.ts
  - packages/ecson/src/registry/index.ts
  - packages/ecson/src/registry/gltf-allowlist.ts
  - packages/ecson/src/index.ts
  - packages/ecson/__tests__/registry.test.ts
  - packages/ecson/__tests__/gltf-allowlist.test.ts
autonomous: true
requirements:
  - CORE-10

must_haves:
  truths:
    - "The component registry contains at least 17 component types (9 core 3D + 8 gameplay stubs)"
    - "Every component has a Zod schema with typed properties, defaults, and editor hints via .meta()"
    - "The registry can look up any component definition by type string and validate an instance's properties against it"
    - "Editor hints (color picker, slider, dropdown, checkbox, enum) are baked into schemas and retrievable"
    - "The glTF extension allowlist v0 is published with clear portable/non-portable categorization"
    - "Audio components (AudioSource, AudioListener) are included per user decision"
    - "Gameplay stubs define enough properties to prove the schema handles them, but are expandable in Phase 7"
  artifacts:
    - path: "packages/ecson/src/registry/registry.ts"
      provides: "Component registry with lookup, validation, and listing"
      exports: ["componentRegistry", "getComponentDef", "validateComponentProperties", "listComponents"]
    - path: "packages/ecson/src/registry/types.ts"
      provides: "ComponentDefinition interface with schema, category, editor hints"
      contains: "ComponentDefinition"
    - path: "packages/ecson/src/registry/gltf-allowlist.ts"
      provides: "glTF extension allowlist v0 with portable status"
      exports: ["GLTF_ALLOWLIST", "isAllowedExtension"]
    - path: "packages/ecson/src/registry/components/light.ts"
      provides: "Light component with type, color, intensity, range, shadows, all with editor hints"
      contains: "LightComponentDef"
    - path: "packages/ecson/src/registry/components/material.ts"
      provides: "Material component with PBR properties matching portable subset"
      contains: "MaterialComponentDef"
  key_links:
    - from: "packages/ecson/src/registry/registry.ts"
      to: "packages/ecson/src/registry/components/*.ts"
      via: "imports and registers all component definitions"
      pattern: "componentRegistry\\.set"
    - from: "packages/ecson/src/registry/types.ts"
      to: "zod"
      via: "ComponentDefinition wraps z.ZodType for schema field"
      pattern: "z\\.ZodType"
    - from: "packages/ecson/src/registry/gltf-allowlist.ts"
      to: "packages/canonical-ir/src/portable-subset.ts"
      via: "conceptual alignment -- allowlist informs what the portable subset covers"
      pattern: "portable"
---

<objective>
Build the component registry with 17 typed component definitions (9 core 3D + 8 gameplay stubs), each with Zod schemas, defaults, editor hints, and category metadata. Also publish the glTF extension allowlist v0.

Purpose: The component registry is how the editor knows what components exist, what properties they have, and how to render their inspectors. Editor hints baked into schemas (per user decision) mean Phase 2 can auto-generate inspector UIs directly from the registry.

Output: The `@riff3d/ecson` package's registry module exports all 17 component definitions, a lookup/validation API, and the glTF allowlist. Tests validate every component's schema and editor hints.
</objective>

<execution_context>
@/home/frank/.claude/get-shit-done/workflows/execute-plan.md
@/home/frank/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-contracts-testing-spine/01-RESEARCH.md
@.planning/phases/01-contracts-testing-spine/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement registry infrastructure and 9 core 3D component definitions</name>
  <files>
    packages/ecson/src/registry/types.ts
    packages/ecson/src/registry/registry.ts
    packages/ecson/src/registry/components/mesh-renderer.ts
    packages/ecson/src/registry/components/light.ts
    packages/ecson/src/registry/components/camera.ts
    packages/ecson/src/registry/components/rigid-body.ts
    packages/ecson/src/registry/components/collider.ts
    packages/ecson/src/registry/components/audio-source.ts
    packages/ecson/src/registry/components/audio-listener.ts
    packages/ecson/src/registry/components/animation.ts
    packages/ecson/src/registry/components/material.ts
    packages/ecson/src/registry/components/index.ts
    packages/ecson/src/registry/index.ts
    packages/ecson/src/index.ts
    packages/ecson/__tests__/registry.test.ts
  </files>
  <action>
    1. **types.ts** -- Define the ComponentDefinition interface:
       ```typescript
       interface ComponentDefinition {
         type: string;                    // Registry key (e.g., 'Light')
         category: 'rendering' | 'physics' | 'audio' | 'gameplay' | 'logic' | 'settings';
         description: string;
         singleton: boolean;             // true = at most one per entity
         schema: z.ZodType;             // Zod schema for this component's properties
         events?: { name: string; label: string }[];   // Events this component can emit
         actions?: { name: string; label: string }[];   // Actions this component can receive
       }
       ```

    2. **registry.ts** -- Implement the registry:
       - `componentRegistry: Map<string, ComponentDefinition>` -- the backing store
       - `registerComponent(def: ComponentDefinition): void` -- adds to registry, throws on duplicate
       - `getComponentDef(type: string): ComponentDefinition | undefined` -- lookup by type
       - `validateComponentProperties(type: string, properties: Record<string, unknown>): z.SafeParseReturnType` -- validates properties against the component's schema
       - `listComponents(): ComponentDefinition[]` -- returns all registered components
       - `listComponentsByCategory(category: string): ComponentDefinition[]` -- filtered listing
       - Auto-register all components on module load (import side-effect from components/index.ts).

    3. **Core 3D components** (one file each in `registry/components/`):

       **MeshRenderer** (rendering, singleton):
       - `primitive`: enum('box', 'sphere', 'cylinder', 'capsule', 'cone', 'plane', 'torus') | null, default null. Meta: `{ editorHint: 'dropdown', label: 'Primitive Shape' }`
       - `meshAssetId`: string | null, default null. Meta: `{ editorHint: 'asset-ref', assetType: 'mesh', label: 'Mesh Asset' }`
       - `castShadows`: boolean, default true. Meta: `{ editorHint: 'checkbox', label: 'Cast Shadows' }`
       - `receiveShadows`: boolean, default true. Meta: `{ editorHint: 'checkbox', label: 'Receive Shadows' }`
       - `materialAssetId`: string | null, default null. Meta: `{ editorHint: 'asset-ref', assetType: 'material', label: 'Material' }`

       **Light** (rendering, singleton):
       - `lightType`: enum('directional', 'point', 'spot'), default 'point'. Meta: `{ editorHint: 'dropdown' }`
       - `color`: string (hex), default '#ffffff'. Meta: `{ editorHint: 'color' }`
       - `intensity`: number min 0 max 100, default 1. Meta: `{ editorHint: 'slider', step: 0.1 }`
       - `range`: number min 0, default 10. Meta: `{ editorHint: 'slider' }`
       - `innerConeAngle`: number, default 30 (spot only). Meta: `{ editorHint: 'slider', min: 0, max: 90 }`
       - `outerConeAngle`: number, default 45 (spot only). Meta: `{ editorHint: 'slider', min: 0, max: 90 }`
       - `castShadows`: boolean, default false. Meta: `{ editorHint: 'checkbox' }`
       - `shadowBias`: number, default 0.005. Meta: `{ editorHint: 'number' }`

       **Camera** (rendering, singleton):
       - `projection`: enum('perspective', 'orthographic'), default 'perspective'. Meta: `{ editorHint: 'dropdown' }`
       - `fov`: number min 1 max 179, default 60. Meta: `{ editorHint: 'slider' }`
       - `nearClip`: number, default 0.1. Meta: `{ editorHint: 'number' }`
       - `farClip`: number, default 1000. Meta: `{ editorHint: 'number' }`
       - `orthoSize`: number, default 5 (ortho only). Meta: `{ editorHint: 'number' }`
       - `clearColor`: string, default '#000000'. Meta: `{ editorHint: 'color' }`
       - `priority`: number, default 0. Meta: `{ editorHint: 'number' }`

       **RigidBody** (physics, singleton):
       - `bodyType`: enum('dynamic', 'fixed', 'kinematicPosition', 'kinematicVelocity'), default 'dynamic'. Meta: `{ editorHint: 'dropdown' }`
       - `mass`: number min 0, default 1. Meta: `{ editorHint: 'number' }`
       - `friction`: number min 0, default 0.5. Meta: `{ editorHint: 'slider', min: 0, max: 1 }`
       - `restitution`: number min 0, default 0.3. Meta: `{ editorHint: 'slider', min: 0, max: 1 }`
       - `linearDamping`: number, default 0.01. Meta: `{ editorHint: 'number' }`
       - `angularDamping`: number, default 0.05. Meta: `{ editorHint: 'number' }`
       - `gravityScale`: number, default 1. Meta: `{ editorHint: 'number' }`
       - `ccdEnabled`: boolean, default false. Meta: `{ editorHint: 'checkbox' }`

       **Collider** (physics, not singleton -- entity can have multiple):
       - `shape`: enum('box', 'sphere', 'capsule', 'cylinder', 'cone', 'mesh'), default 'box'. Meta: `{ editorHint: 'dropdown' }`
       - `size`: Vec3, default {x:1,y:1,z:1}. Meta: `{ editorHint: 'vec3' }`
       - `offset`: Vec3, default {x:0,y:0,z:0}. Meta: `{ editorHint: 'vec3' }`
       - `radius`: number, default 0.5 (sphere/capsule). Meta: `{ editorHint: 'number' }`
       - `height`: number, default 1 (capsule/cylinder). Meta: `{ editorHint: 'number' }`
       - `isTrigger`: boolean, default false. Meta: `{ editorHint: 'checkbox' }`
       - `meshAssetId`: string | null (mesh shape only). Meta: `{ editorHint: 'asset-ref', assetType: 'mesh' }`

       **AudioSource** (audio, not singleton):
       - `audioAssetId`: string | null, default null. Meta: `{ editorHint: 'asset-ref', assetType: 'audio' }`
       - `autoPlay`: boolean, default false. Meta: `{ editorHint: 'checkbox' }`
       - `loop`: boolean, default false. Meta: `{ editorHint: 'checkbox' }`
       - `volume`: number min 0 max 1, default 1. Meta: `{ editorHint: 'slider' }`
       - `pitch`: number min 0.1 max 4, default 1. Meta: `{ editorHint: 'slider' }`
       - `spatial`: boolean, default true. Meta: `{ editorHint: 'checkbox' }`
       - `refDistance`: number, default 1. Meta: `{ editorHint: 'number' }`
       - `maxDistance`: number, default 100. Meta: `{ editorHint: 'number' }`
       - `rolloffFactor`: number, default 1. Meta: `{ editorHint: 'number' }`
       Events: `onPlay`, `onStop`, `onEnd`.

       **AudioListener** (audio, singleton):
       - `active`: boolean, default true. Meta: `{ editorHint: 'checkbox' }`
       (Minimal -- marks which entity "hears" audio)

       **Animation** (rendering, not singleton):
       - `clips`: array of `{ name: string, assetId: string | null }`, default []. Meta: `{ editorHint: 'array' }`
       - `defaultClip`: string | null, default null. Meta: `{ editorHint: 'dropdown' }`
       - `speed`: number, default 1. Meta: `{ editorHint: 'slider', min: 0, max: 5 }`
       - `loop`: boolean, default true. Meta: `{ editorHint: 'checkbox' }`
       Events: `onClipStart`, `onClipEnd`.

       **Material** (rendering, not singleton -- component-level material override):
       - `materialAssetId`: string | null, default null. Meta: `{ editorHint: 'asset-ref', assetType: 'material' }`
       - PBR inline fallback (used when no asset): `baseColor` (hex, default '#cccccc'), `metallic` (0-1, default 0), `roughness` (0-1, default 0.5), `emissive` (hex, default '#000000'), `emissiveIntensity` (number, default 0), `opacity` (0-1, default 1), `alphaMode` (enum 'opaque'|'mask'|'blend', default 'opaque'), `alphaCutoff` (0-1, default 0.5), `doubleSided` (boolean, default false).
       - Texture slots: `baseColorMap`, `normalMap`, `metallicRoughnessMap`, `emissiveMap`, `occlusionMap` -- all string | null asset IDs, default null. Meta: `{ editorHint: 'asset-ref', assetType: 'texture' }`.

    4. **components/index.ts**: Import all component files (triggers registration side-effects).
    5. **registry/index.ts**: Export registry API and types.
    6. **Update ecson src/index.ts**: Export registry module.

    **Tests** (`packages/ecson/__tests__/registry.test.ts`):
    - Registry contains exactly 9 core components after import
    - Each component has required fields (type, category, description, singleton, schema)
    - `getComponentDef('Light')` returns the Light definition
    - `validateComponentProperties('Light', { lightType: 'point', color: '#ff0000' })` succeeds
    - `validateComponentProperties('Light', { lightType: 'invalid' })` fails
    - Defaults are applied correctly for each component
    - Editor hints are present and accessible via `.meta()` on each property
    - Material component includes all PBR portable subset properties
    - Singleton components marked correctly (Light=true, Collider=false)
    - Events and actions are defined for components that have them
  </action>
  <verify>
    `pnpm --filter @riff3d/ecson test` passes with all registry tests green.
    `pnpm --filter @riff3d/ecson typecheck` passes.
    Registry contains exactly 9 core 3D component definitions.
  </verify>
  <done>
    The component registry infrastructure is built and 9 core 3D components are defined with Zod schemas, defaults, editor hints, events, and category metadata. All components validate correctly and editor hints are accessible.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add 8 gameplay stub components and publish glTF extension allowlist v0</name>
  <files>
    packages/ecson/src/registry/components/score-zone.ts
    packages/ecson/src/registry/components/kill-zone.ts
    packages/ecson/src/registry/components/spawner.ts
    packages/ecson/src/registry/components/trigger-zone.ts
    packages/ecson/src/registry/components/checkpoint.ts
    packages/ecson/src/registry/components/moving-platform.ts
    packages/ecson/src/registry/components/path-follower.ts
    packages/ecson/src/registry/components/timer.ts
    packages/ecson/src/registry/components/index.ts
    packages/ecson/src/registry/gltf-allowlist.ts
    packages/ecson/__tests__/registry.test.ts
    packages/ecson/__tests__/gltf-allowlist.test.ts
  </files>
  <action>
    1. **Gameplay stub components** (category: 'gameplay', all non-singleton unless noted):

       **ScoreZone** (gameplay):
       - `points`: number, default 10. Meta: `{ editorHint: 'number' }`
       - `teamFilter`: string | null, default null. Meta: `{ editorHint: 'textbox' }`
       - `repeatable`: boolean, default false. Meta: `{ editorHint: 'checkbox' }`
       - `cooldown`: number min 0, default 0 (seconds). Meta: `{ editorHint: 'number' }`
       Events: `onScore`. Actions: `activate`, `deactivate`.

       **KillZone** (gameplay):
       - `respawnBehavior`: enum('respawnPoint', 'lastCheckpoint', 'spectate'), default 'lastCheckpoint'. Meta: `{ editorHint: 'dropdown' }`
       - `damage`: number, default Infinity (instant kill). Meta: `{ editorHint: 'number' }`
       Events: `onKill`. Actions: `activate`, `deactivate`.

       **Spawner** (gameplay):
       - `templateEntityId`: string | null, default null. Meta: `{ editorHint: 'entity-ref' }`
       - `spawnInterval`: number min 0, default 5 (seconds). Meta: `{ editorHint: 'number' }`
       - `maxActive`: number min 1, default 5. Meta: `{ editorHint: 'number' }`
       - `spawnOnStart`: boolean, default true. Meta: `{ editorHint: 'checkbox' }`
       Events: `onSpawn`. Actions: `spawn`, `reset`.

       **TriggerZone** (gameplay):
       - `triggerOnce`: boolean, default false. Meta: `{ editorHint: 'checkbox' }`
       - `filterTags`: string[], default []. Meta: `{ editorHint: 'tags' }`
       Events: `onEnter`, `onExit`, `onStay`. Actions: `activate`, `deactivate`.

       **Checkpoint** (gameplay):
       - `orderIndex`: number, default 0. Meta: `{ editorHint: 'number' }`
       - `respawnOffset`: Vec3, default {x:0,y:1,z:0}. Meta: `{ editorHint: 'vec3' }`
       Events: `onActivate`. Actions: none.

       **MovingPlatform** (gameplay):
       - `axis`: enum('x', 'y', 'z'), default 'y'. Meta: `{ editorHint: 'dropdown' }`
       - `distance`: number, default 5. Meta: `{ editorHint: 'number' }`
       - `speed`: number min 0, default 2. Meta: `{ editorHint: 'slider' }`
       - `easing`: enum('linear', 'easeInOut', 'easeIn', 'easeOut'), default 'easeInOut'. Meta: `{ editorHint: 'dropdown' }`
       - `pauseDuration`: number min 0, default 1 (seconds). Meta: `{ editorHint: 'number' }`
       Events: `onReachEnd`, `onReachStart`. Actions: `start`, `stop`, `reverse`.

       **PathFollower** (gameplay):
       - `waypointEntityIds`: string[], default []. Meta: `{ editorHint: 'entity-ref-list' }`
       - `speed`: number min 0, default 3. Meta: `{ editorHint: 'slider' }`
       - `loopMode`: enum('once', 'loop', 'pingPong'), default 'loop'. Meta: `{ editorHint: 'dropdown' }`
       - `lookAtNext`: boolean, default true. Meta: `{ editorHint: 'checkbox' }`
       Events: `onWaypointReached`, `onPathComplete`. Actions: `start`, `stop`, `reset`.

       **Timer** (logic):
       - `duration`: number min 0, default 60 (seconds). Meta: `{ editorHint: 'number' }`
       - `autoStart`: boolean, default false. Meta: `{ editorHint: 'checkbox' }`
       - `loop`: boolean, default false. Meta: `{ editorHint: 'checkbox' }`
       Events: `onStart`, `onTick`, `onComplete`. Actions: `start`, `stop`, `reset`.

    2. **Update components/index.ts** to import all 8 gameplay stubs (triggering registration).

    3. **glTF Extension Allowlist v0** (`packages/ecson/src/registry/gltf-allowlist.ts`):
       ```typescript
       interface GltfExtensionEntry {
         name: string;
         status: 'ratified' | 'draft';
         portable: boolean;          // true = in portable subset v0
         fixturesCovering: string[]; // which golden fixtures exercise this
         notes: string;
       }
       ```

       Define the allowlist:
       - `core_gltf_2.0`: ratified, portable, fixtures: all. "Meshes, materials (metallic-roughness), animations, scene graph"
       - `KHR_lights_punctual`: ratified, portable, fixtures: materials-lights. "Directional, point, spot lights"
       - `KHR_materials_unlit`: ratified, portable, fixtures: materials-lights. "Unlit materials for UI/effects"
       - `KHR_texture_transform`: ratified, non-portable (deferred), fixtures: none yet. "UV offset/scale/rotation -- schema defined but not in portable subset v0"
       - `KHR_physics_rigid_bodies`: draft, non-portable (inspiration only), fixtures: none. "Schema inspired by, not dependent on"

       Export `GLTF_ALLOWLIST`, `isAllowedExtension(name: string): boolean`, `getPortableExtensions(): GltfExtensionEntry[]`.

    4. **Tests:**
       Update `registry.test.ts`:
       - Registry now contains exactly 17 component types total
       - Each gameplay stub validates with defaults
       - `listComponentsByCategory('gameplay')` returns 7 gameplay + 1 logic = 8 stubs
       - Events/actions defined on gameplay components

       New `gltf-allowlist.test.ts`:
       - Allowlist contains expected entries
       - `isAllowedExtension('KHR_lights_punctual')` returns true
       - `isAllowedExtension('KHR_draco_mesh_compression')` returns false (not in allowlist)
       - `getPortableExtensions()` returns only portable entries
  </action>
  <verify>
    `pnpm --filter @riff3d/ecson test` passes all tests (schemas + ids + migrations + registry + gltf).
    `pnpm --filter @riff3d/ecson typecheck` passes.
    `pnpm turbo typecheck lint test` passes for full monorepo.
    Registry lists exactly 17 component types.
  </verify>
  <done>
    The component registry has 17 component types (9 core 3D + 8 gameplay stubs), all with Zod schemas, editor hints, defaults, events, and actions. The glTF extension allowlist v0 is published. The registry validates component properties and provides lookup by type and category.
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter @riff3d/ecson test` -- all tests pass
- Registry contains exactly 17 component types
- Every component has: typed Zod schema, defaults, editor hints, category, singleton flag
- glTF allowlist classifies extensions as portable/non-portable
- Material component's PBR properties align with portable subset v0
- Full monorepo pipeline passes
</verification>

<success_criteria>
The component registry defines 17 schema-driven component types with editor hints that Phase 2 can read directly to auto-generate inspector panels. The glTF allowlist v0 clarifies which extensions are in scope for the portable subset. All component properties are validated by Zod.
</success_criteria>

<output>
After completion, create `.planning/phases/01-contracts-testing-spine/01-05-SUMMARY.md`
</output>
