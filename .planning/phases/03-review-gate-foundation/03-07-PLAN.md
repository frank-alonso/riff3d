---
phase: 03-review-gate-foundation
plan: 07
type: execute
wave: 4
depends_on: [03-01, 03-02, 03-03, 03-04, 03-05, 03-06]
files_modified:
  - .planning/reviews/phase-3/PHASE_3_EVIDENCE.md
  - .planning/reviews/phase-3/PHASE_3_REVIEW.md
  - .planning/reviews/phase-3/PHASE_3_REVIEW_RESPONSE.md
  - .planning/reviews/phase-3/PHASE_3_FINAL_REVIEW.md
  - .planning/reviews/phase-3/PHASE_3_DECISION.md
  - .planning/reviews/phase-3/PHASE_3_MANUAL_CHECKLIST.md
  - .planning/STATE.md
  - .planning/ROADMAP.md
autonomous: false
requirements: []

must_haves:
  truths:
    - "All 6 Phase 3 success criteria are verified with evidence"
    - "All carry-forward items (CF-P2-01 through CF-P2-04) are resolved with proof"
    - "Codex expanded-scope review covers PatchOps integrity, adapter boundary, and cumulative debt"
    - "No S0 or S1 findings remain unresolved after review loop"
    - "Human manual checklist provides executive summary spot-check"
    - "Gate decision is PASS, PASS_WITH_CONDITIONS, or FAIL with clear rationale"
  artifacts:
    - path: ".planning/reviews/phase-3/PHASE_3_EVIDENCE.md"
      provides: "Comprehensive evidence packet with all success criteria, carry-forward resolution, test results"
    - path: ".planning/reviews/phase-3/PHASE_3_DECISION.md"
      provides: "Final gate decision with rationale"
    - path: ".planning/reviews/phase-3/PHASE_3_MANUAL_CHECKLIST.md"
      provides: "Human walkthrough checklist with executive summary"
  key_links:
    - from: ".planning/reviews/phase-3/PHASE_3_EVIDENCE.md"
      to: "scripts/codex-review.sh"
      via: "Evidence fed to Codex for expanded-scope review"
      pattern: "codex-review.sh post-review 3"
---

<objective>
Run the expanded-scope Phase 3 Review Gate. Compile evidence for all 6 success criteria, resolve carry-forward items, run the Codex expanded-scope audit with extra scrutiny on PatchOps integrity, adapter boundary, and cumulative debt, and provide a manual walkthrough checklist with executive summary.

Purpose: Phase 3 is the Foundation review gate -- the last checkpoint before building collaboration (Phase 5) and the second adapter (Phase 4) on top. This review validates that contracts are sound, the editor pipeline is stable, and no compounding debt exists from Phases 1-2. If the foundation is unsound, everything built on top will inherit the problems.

Output: Evidence packet, Codex review artifacts, manual checklist, gate decision, updated STATE.md and ROADMAP.md.
</objective>

<execution_context>
@/home/frank/.claude/get-shit-done/workflows/execute-plan.md
@/home/frank/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/PHASE_REVIEW_PROTOCOL.md
@.planning/phases/03-review-gate-foundation/03-01-SUMMARY.md
@.planning/phases/03-review-gate-foundation/03-02-SUMMARY.md
@.planning/phases/03-review-gate-foundation/03-03-SUMMARY.md
@.planning/phases/03-review-gate-foundation/03-04-SUMMARY.md
@.planning/phases/03-review-gate-foundation/03-05-SUMMARY.md
@.planning/phases/03-review-gate-foundation/03-06-SUMMARY.md
@.planning/reviews/phase-01/PHASE_01_DECISION.md
@.planning/reviews/phase-2/PHASE_2_DECISION.md
@scripts/codex-review.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Compile evidence packet and run expanded-scope Codex review</name>
  <files>
    .planning/reviews/phase-3/PHASE_3_EVIDENCE.md
    .planning/reviews/phase-3/PHASE_3_REVIEW.md
    .planning/reviews/phase-3/PHASE_3_REVIEW_RESPONSE.md
    .planning/reviews/phase-3/PHASE_3_FINAL_REVIEW.md
    .planning/reviews/phase-3/PHASE_3_DECISION.md
    .planning/reviews/phase-3/PHASE_3_MANUAL_CHECKLIST.md
  </files>
  <action>
    **Step 1: Run full test suite and capture results:**

    ```bash
    cd /home/frank/riff3d
    pnpm turbo typecheck lint test 2>&1 | tee /tmp/phase3-test-output.txt
    bash scripts/check-adapter-loc.sh 2>&1 | tee /tmp/phase3-loc-output.txt
    ```

    **Step 2: Compile evidence packet (PHASE_3_EVIDENCE.md):**

    Cover all 6 Phase 3 success criteria with concrete evidence:

    1. **All golden fixtures load, edit, save, compile, and render without errors**
       - Test output from conformance round-trip, replay, benchmarks
       - Reference to E2E smoke test (or manual verification if E2E requires live Supabase)

    2. **PatchOps operation log accurately captures every edit**
       - Reference patchops test suite results (80+ tests)
       - Reference mutation-bypass enforcement tests
       - Reference the centralized `isReadOnly` guard added in 02-08
       - Reference the `__environment__` path restriction added in 02-08
       - Enumerate approved exceptions (loadProject, playtest stop) per CLAUDE.md

    3. **Round-trip tests pass at 100% for portable subset**
       - Conformance round-trip test output
       - Lossiness contract test output
       - Property test output (fast-check determinism)

    4. **Performance budgets met for all golden fixtures**
       - Conformance benchmark output (CI-measurable budgets: compilation, PatchOp timing)
       - Reference tiered budget definitions from budgets.ts
       - Note: FPS/memory are local-only metrics -- include manual measurement or note as non-CI

    5. **All carry-forward actions resolved**
       - CF-P2-01: Adapter unit tests (03-01 summary)
       - CF-P2-02: RLS policy tests (03-04 summary)
       - CF-P2-03: Schema-validated test fixtures (03-02 summary)
       - CF-P2-04: Adapter split + LoC enforcement (03-03 summary)
       - CF-04 from Phase 1: Explicitly re-scheduled to Phase 4/7 (per ROADMAP)

    6. **No unaddressed architecture drift**
       - Adapter boundary: adapters still only read Canonical IR
       - Package dependency direction: ecson -> patchops -> canonical-ir -> adapters -> editor
       - PatchOps as single mutation path (with documented exceptions)
       - LoC budget enforcement via CI script

    **Include expanded-scope sections (per Phase Review Protocol for review gate phases):**
    - **Cross-phase integration (Phases 1-2):** Contract definitions still accurate? IR schema matches ECSON schema?
    - **Cumulative debt:** Phase 1 PASS_WITH_CONDITIONS findings all resolved? Phase 2 findings all resolved?
    - **Architecture drift:** Any deviations from original FOUNDATION.md contract definitions?

    **Step 3: Run Codex expanded-scope review:**

    ```bash
    ./scripts/codex-review.sh post-review 3
    ```

    The review prompt should emphasize three focus areas (per locked decisions):
    1. **PatchOps integrity** -- verify ALL edits flow through PatchOps (the architectural non-negotiable)
    2. **Adapter boundary** -- verify adapters only read Canonical IR, never touch ECSON or PatchOps
    3. **Cumulative debt** -- assess whether PASS_WITH_CONDITIONS from Phase 1-2 created compounding issues

    Save Codex output to `PHASE_3_REVIEW.md`.

    **Step 4: Write review response (PHASE_3_REVIEW_RESPONSE.md):**

    For each Codex finding:
    - Classify severity (S0-S3)
    - Triage: fix now (S0/S1), carry forward (S2/S3 that could compound), or defer (S2/S3 cosmetic)
    - Fix blocking items immediately and re-run affected tests
    - Per locked decision: "block on anything that could compound, defer cosmetic issues"

    **Step 5: Run Codex final review:**

    ```bash
    ./scripts/codex-review.sh final-review 3
    ```

    Save to `PHASE_3_FINAL_REVIEW.md`.

    **Step 6: Write gate decision (PHASE_3_DECISION.md):**

    Based on final review, issue `PASS`, `PASS_WITH_CONDITIONS`, or `FAIL`:
    - PASS: No open S0/S1/S2, all criteria met
    - PASS_WITH_CONDITIONS: S2 carry-forwards with clear targets, all criteria fundamentally met
    - FAIL: S0/S1 findings unresolved, or a success criterion not met

    **Step 7: Create manual walkthrough checklist (PHASE_3_MANUAL_CHECKLIST.md):**

    Structured checklist for human review with executive summary at the top:

    ```markdown
    # Phase 3 Manual Walkthrough Checklist

    ## Executive Summary (Spot-Check)
    Quick 2-minute verification for when time is short:
    - [ ] Open editor, load a project -- scene renders in viewport
    - [ ] Move an entity -- gizmo works, undo reverts
    - [ ] Save and reload -- state persists
    - [ ] Run `pnpm turbo test` -- all green

    ## Full Walkthrough (10-15 minutes)
    ### Contracts
    - [ ] Run `pnpm turbo test --filter @riff3d/conformance` -- all pass
    - [ ] Run `pnpm turbo test --filter @riff3d/patchops` -- all pass
    - [ ] Run `bash scripts/check-adapter-loc.sh` -- PASS

    ### Editor Pipeline
    - [ ] Create new project from dashboard
    - [ ] Add entity via hierarchy panel
    - [ ] Edit transform via gizmo
    - [ ] Edit property via inspector
    - [ ] Verify PatchOps appear in operation log
    - [ ] Undo/redo works
    - [ ] Save, close, reopen -- state preserved

    ### Adapter
    - [ ] Scene renders with PBR materials
    - [ ] Camera controls work (orbit, fly)
    - [ ] Selection highlight visible
    - [ ] Grid renders at ground plane

    ### Drag Preview (new)
    - [ ] Drag asset from browser to viewport -- ghost appears
    - [ ] Ghost follows cursor
    - [ ] Drop creates entity at ghost position
    - [ ] Drag leave removes ghost

    ### Performance
    - [ ] Scene loads in under 1 second
    - [ ] Editor feels responsive (no visible lag)
    ```
  </action>
  <verify>
    Verify all 5 review artifacts exist in `.planning/reviews/phase-3/`:
    - PHASE_3_EVIDENCE.md
    - PHASE_3_REVIEW.md
    - PHASE_3_REVIEW_RESPONSE.md
    - PHASE_3_FINAL_REVIEW.md
    - PHASE_3_DECISION.md
    Plus PHASE_3_MANUAL_CHECKLIST.md.
    Verify gate decision is recorded.
    Run `pnpm turbo test` -- all tests pass after any review fixes.
  </verify>
  <done>
    - Evidence packet compiled with all 6 success criteria, carry-forward resolution, expanded-scope analysis
    - Codex review completed with PatchOps/adapter/debt focus areas
    - All S0/S1 findings fixed; S2/S3 triaged per compounding risk
    - Gate decision recorded
    - Manual checklist ready for human spot-check or full walkthrough
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification of Phase 3 Review Gate</name>
  <files>.planning/reviews/phase-3/PHASE_3_DECISION.md</files>
  <action>
    Human verification of the Phase 3 Review Gate: Foundation.

    What was built: Expanded-scope review covering all 4 carry-forward items resolved (CF-P2-01 through CF-P2-04), drag-preview ghost feature, tiered performance budgets, E2E smoke test and visual baseline beta, and Codex audit with PatchOps integrity, adapter boundary, and cumulative debt focus.

    Steps to verify:
    1. Review `.planning/reviews/phase-3/PHASE_3_DECISION.md` for gate decision
    2. Run the executive summary spot-check from PHASE_3_MANUAL_CHECKLIST.md:
       - Open editor, load a project -- scene renders
       - Move an entity -- gizmo works, undo reverts
       - Save and reload -- state persists
       - Run `pnpm turbo test` -- all green
    3. Optionally run the full manual walkthrough (10-15 min)
    4. Review any PASS_WITH_CONDITIONS carry-forward items

    Type "approved" to accept the gate decision, or describe issues to investigate.
  </action>
  <verify>Gate decision reviewed and accepted by human.</verify>
  <done>Phase 3 Review Gate verified by human. Gate decision accepted.</done>
</task>

</tasks>

<verification>
- All 6 Phase 3 success criteria have evidence in PHASE_3_EVIDENCE.md
- Codex review artifacts present in `.planning/reviews/phase-3/`
- Gate decision is one of: PASS, PASS_WITH_CONDITIONS, FAIL
- Manual checklist exists with executive summary and full walkthrough
- `pnpm turbo test` passes after all review fixes
- STATE.md and ROADMAP.md updated to reflect Phase 3 completion
</verification>

<success_criteria>
Phase 3 Review Gate is complete: all success criteria verified, carry-forwards resolved, Codex expanded-scope audit performed, gate decision issued, and human verification confirms the foundation is solid for Phase 4 (Dual Adapter Validation) and Phase 5 (Collaboration).
</success_criteria>

<output>
After completion, create `.planning/phases/03-review-gate-foundation/03-07-SUMMARY.md`

After human approval, update:
- `.planning/STATE.md` -- Phase 3 complete, Phase 4 ready
- `.planning/ROADMAP.md` -- Phase 3 progress updated, plans list finalized
</output>
