---
phase: 03-review-gate-foundation
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/editor/__tests__/rls-policies.test.ts
  - apps/editor/__tests__/rls-integration.test.ts
  - apps/editor/vitest.config.ts
  - apps/editor/package.json
autonomous: true
requirements: []

must_haves:
  truths:
    - "Mocked RLS policy tests verify migration SQL contains correct policy definitions (fast, no Supabase dependency)"
    - "Integration RLS tests verify actual row-level security behavior against a live Supabase instance"
    - "Mocked tests run as part of standard `pnpm test` -- no external dependencies"
    - "Integration tests run separately via `pnpm test:integration` -- require Supabase connection"
  artifacts:
    - path: "apps/editor/__tests__/rls-policies.test.ts"
      provides: "Structural policy tests verifying migration SQL patterns"
    - path: "apps/editor/__tests__/rls-integration.test.ts"
      provides: "Live Supabase integration tests for RLS behavior"
  key_links:
    - from: "apps/editor/__tests__/rls-policies.test.ts"
      to: "apps/editor/supabase/migration-001-projects.sql"
      via: "readFileSync reading migration SQL for structural assertions"
      pattern: "readFileSync.*migration.*sql"
    - from: "apps/editor/__tests__/rls-integration.test.ts"
      to: "@supabase/supabase-js"
      via: "createClient with test auth context"
      pattern: "createClient.*supabase"
---

<objective>
Add two layers of RLS (Row Level Security) policy tests: (1) mocked structural tests that verify the migration SQL contains correct policy definitions, and (2) integration tests against a live Supabase instance that verify actual RLS behavior. Mocked tests run in CI; integration tests run separately via `pnpm test:integration`.

Purpose: Resolves carry-forward CF-P2-02 from Phase 2 review. RLS policies are the security boundary for user data isolation. Without tests, policy changes could silently break data isolation (e.g., a user seeing another user's projects). The two-layer approach provides fast CI feedback (mocked) and real security validation (integration).

Output: 2 test files (mocked + integration), editor vitest config updated for integration test exclusion, package.json with `test:integration` script.
</objective>

<execution_context>
@/home/frank/.claude/get-shit-done/workflows/execute-plan.md
@/home/frank/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-review-gate-foundation/03-RESEARCH.md
@apps/editor/supabase/migration-001-projects.sql
@apps/editor/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mocked RLS policy structural tests and Supabase integration tests</name>
  <files>
    apps/editor/__tests__/rls-policies.test.ts
    apps/editor/__tests__/rls-integration.test.ts
    apps/editor/vitest.config.ts
    apps/editor/package.json
  </files>
  <action>
    **1. Create mocked policy tests (`__tests__/rls-policies.test.ts`):**

    These tests read the migration SQL file and verify structural correctness of RLS policy definitions. No database needed.

    ```typescript
    import { describe, it, expect } from "vitest";
    import { readFileSync } from "fs";
    import { resolve } from "path";
    ```

    Read `apps/editor/supabase/migration-001-projects.sql` via `readFileSync`.

    Test cases:
    - **RLS enabled on projects table**: SQL contains `ALTER TABLE ... ENABLE ROW LEVEL SECURITY` or `ENABLE ROW LEVEL SECURITY` for the projects table
    - **Owner SELECT policy**: SQL contains a SELECT policy checking `auth.uid() = owner_id`
    - **Owner INSERT policy**: SQL contains an INSERT policy with `WITH CHECK` using `auth.uid() = owner_id`
    - **Owner UPDATE policy**: SQL contains an UPDATE policy checking `auth.uid() = owner_id`
    - **Owner DELETE policy**: SQL contains a DELETE policy checking `auth.uid() = owner_id`
    - **Public read policy**: SQL contains a SELECT policy using `is_public = true` (if the schema has a public flag). If not present, verify that only owner-based policies exist.
    - **No GRANT on projects to anon bypassing RLS**: Verify the SQL does not contain `ALTER TABLE ... DISABLE ROW LEVEL SECURITY` or `GRANT ALL` without RLS consideration
    - **No unsafe policy patterns**: No `USING (true)` on UPDATE/DELETE/INSERT policies (which would allow any authenticated user)

    These tests use regex matching on the SQL string. The patterns should be flexible enough to handle whitespace variations but strict enough to verify security-critical elements.

    **2. Create integration tests (`__tests__/rls-integration.test.ts`):**

    These tests verify actual RLS behavior against a live Supabase instance. They require environment variables `SUPABASE_URL` and `SUPABASE_ANON_KEY` (and optionally `SUPABASE_SERVICE_KEY` for test setup).

    Structure:
    ```typescript
    import { describe, it, expect, beforeAll, afterAll } from "vitest";
    import { createClient } from "@supabase/supabase-js";

    // Skip if env vars not set
    const SUPABASE_URL = process.env.SUPABASE_URL;
    const SUPABASE_ANON_KEY = process.env.SUPABASE_ANON_KEY;
    const canRun = SUPABASE_URL && SUPABASE_ANON_KEY;

    describe.skipIf(!canRun)("RLS integration", () => { ... });
    ```

    Test cases (using Supabase client with different auth contexts):
    - **Owner can read own project**: Sign in as user A, create a project, read it back -> success
    - **Non-owner cannot read private project**: Sign in as user A, create a private project. Sign in as user B, attempt to read it -> 0 rows returned
    - **Owner can update own project**: Sign in as user A, update project name -> success
    - **Non-owner cannot update project**: Sign in as user A, create project. Sign in as user B, attempt update -> 0 rows affected
    - **Anonymous can read public project** (if public projects are supported): Query with no auth, expect public project visible
    - **Cleanup**: afterAll deletes test-created projects and signs out test users

    For test user management: Use `supabase.auth.signInWithPassword()` with test email/password. Test users should be pre-created OR use `supabase.auth.admin.createUser()` if service role key is available.

    **Important:** Use `test_` prefix on all test project names. Add cleanup in `afterAll` that deletes all projects with `test_` prefix using a service-role client.

    **3. Update vitest config for the editor (`apps/editor/vitest.config.ts`):**

    If the editor already has a vitest config, add `exclude` for integration tests so they don't run during standard `pnpm test`:
    ```typescript
    test: {
      exclude: ["__tests__/*integration*"],
    }
    ```

    If no vitest config exists, create one with appropriate settings for the editor package.

    **4. Add `test:integration` script to `apps/editor/package.json`:**

    ```jsonc
    "test:integration": "vitest run --config vitest.integration.config.ts"
    ```

    Or simpler: `"test:integration": "vitest run __tests__/rls-integration.test.ts"`

    The integration config should include the integration files and exclude nothing (or you can just point vitest at the specific file).

    **Note:** The integration tests will naturally skip (via `describe.skipIf`) when `SUPABASE_URL` is not set. This means `pnpm test` won't fail in environments without Supabase access, but `pnpm test:integration` with proper env vars will run the full suite.
  </action>
  <verify>
    Run `cd /home/frank/riff3d && pnpm vitest run --filter @riff3d/editor __tests__/rls-policies.test.ts` -- mocked tests pass (no Supabase needed).
    Run `cd /home/frank/riff3d && pnpm turbo test` -- full test suite green (integration tests skipped due to missing env vars in standard test run).
    Run `cd /home/frank/riff3d && pnpm turbo typecheck` -- no type errors.
    Verify `apps/editor/package.json` has `test:integration` script.
  </verify>
  <done>
    - Mocked RLS policy tests verify structural correctness of migration SQL
    - Integration RLS tests verify actual Supabase RLS behavior (skipped without env vars)
    - Standard `pnpm test` runs only mocked tests (no Supabase dependency)
    - `pnpm test:integration` runs real Supabase integration tests
    - CF-P2-02 fully resolved: both test layers implemented as required
  </done>
</task>

</tasks>

<verification>
- `pnpm turbo test` passes (mocked RLS tests run, integration tests skipped)
- `grep -l "rls-policies" apps/editor/__tests__/` returns the mocked test file
- `grep -l "rls-integration" apps/editor/__tests__/` returns the integration test file
- `pnpm turbo typecheck` passes
</verification>

<success_criteria>
CF-P2-02 is fully resolved: RLS policies have two test layers -- mocked structural tests (fast, CI-safe, no external dependencies) and live Supabase integration tests (run separately via `pnpm test:integration` with env vars). Both layers verify the security-critical data isolation guarantees.
</success_criteria>

<output>
After completion, create `.planning/phases/03-review-gate-foundation/03-04-SUMMARY.md`
</output>
