---
phase: 03-review-gate-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/adapter-playcanvas/__tests__/scene-builder.test.ts
  - packages/adapter-playcanvas/__tests__/component-mappers.test.ts
  - packages/adapter-playcanvas/__tests__/environment.test.ts
  - packages/adapter-playcanvas/__tests__/adapter.test.ts
  - packages/adapter-playcanvas/__tests__/gizmo-manager.test.ts
  - packages/adapter-playcanvas/__tests__/selection-manager.test.ts
  - packages/adapter-playcanvas/__tests__/camera-controller.test.ts
  - packages/adapter-playcanvas/__tests__/grid.test.ts
  - packages/adapter-playcanvas/__tests__/glb-loader.test.ts
  - packages/adapter-playcanvas/__tests__/helpers/pc-mocks.ts
  - packages/adapter-playcanvas/vitest.config.ts
autonomous: true
requirements: []

must_haves:
  truths:
    - "All adapter core modules (scene-builder, component-mappers, environment, adapter) have unit tests verifying Canonical IR consumption"
    - "All adapter editor-tools modules (gizmo-manager, selection-manager, camera-controller, grid, glb-loader) have unit tests verifying API call correctness"
    - "passWithNoTests is removed from vitest.config.ts and all tests pass"
    - "PlayCanvas classes are mocked via vi.mock -- no WebGL/GPU dependency in tests"
  artifacts:
    - path: "packages/adapter-playcanvas/__tests__/helpers/pc-mocks.ts"
      provides: "Shared PlayCanvas mock factory for all adapter tests"
    - path: "packages/adapter-playcanvas/__tests__/scene-builder.test.ts"
      provides: "Tests for IR node-to-entity mapping, BFS ordering, transforms, visibility"
    - path: "packages/adapter-playcanvas/__tests__/component-mappers.test.ts"
      provides: "Tests for MeshRenderer, Light, Camera, Material component mappers"
    - path: "packages/adapter-playcanvas/__tests__/adapter.test.ts"
      provides: "Tests for adapter lifecycle, loadScene, rebuildScene, play mode toggle"
    - path: "packages/adapter-playcanvas/__tests__/gizmo-manager.test.ts"
      provides: "Tests for gizmo mode switching, entity attachment, PatchOp dispatch on drag"
    - path: "packages/adapter-playcanvas/__tests__/selection-manager.test.ts"
      provides: "Tests for click picking, shift-click toggle, box select, entity map updates"
  key_links:
    - from: "packages/adapter-playcanvas/__tests__/helpers/pc-mocks.ts"
      to: "playcanvas"
      via: "vi.mock factory providing Entity, Application, StandardMaterial fakes"
      pattern: "vi\\.mock.*playcanvas"
---

<objective>
Add comprehensive unit test coverage for the PlayCanvas adapter, covering both core modules (scene-builder, component-mappers, environment, adapter) and editor interaction modules (gizmo-manager, selection-manager, camera-controller, grid, glb-loader). Remove `passWithNoTests: true` from vitest.config.ts.

Purpose: Resolves carry-forward CF-P2-01 from Phase 2 review. The adapter is the single most critical runtime package -- it translates Canonical IR into actual 3D rendering. Without unit tests, adapter bugs are only caught by manual visual inspection or the E2E smoke test. This plan establishes mock-based testing that verifies correct PlayCanvas API usage without WebGL/GPU dependency.

Output: 9 test files + 1 shared mock helper, `passWithNoTests` removed, all tests passing.
</objective>

<execution_context>
@/home/frank/.claude/get-shit-done/workflows/execute-plan.md
@/home/frank/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-review-gate-foundation/03-RESEARCH.md
@packages/adapter-playcanvas/src/index.ts
@packages/adapter-playcanvas/src/scene-builder.ts
@packages/adapter-playcanvas/src/environment.ts
@packages/adapter-playcanvas/src/adapter.ts
@packages/adapter-playcanvas/src/types.ts
@packages/adapter-playcanvas/src/component-mappers/index.ts
@packages/adapter-playcanvas/src/component-mappers/mesh-renderer.ts
@packages/adapter-playcanvas/src/component-mappers/light.ts
@packages/adapter-playcanvas/src/component-mappers/camera.ts
@packages/adapter-playcanvas/src/component-mappers/material.ts
@packages/adapter-playcanvas/src/gizmo-manager.ts
@packages/adapter-playcanvas/src/selection-manager.ts
@packages/adapter-playcanvas/src/camera-controller.ts
@packages/adapter-playcanvas/src/grid.ts
@packages/adapter-playcanvas/src/glb-loader.ts
@packages/adapter-playcanvas/vitest.config.ts
@packages/canonical-ir/src/schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared PlayCanvas mock helper and core adapter tests (scene-builder, component-mappers, environment, adapter)</name>
  <files>
    packages/adapter-playcanvas/__tests__/helpers/pc-mocks.ts
    packages/adapter-playcanvas/__tests__/scene-builder.test.ts
    packages/adapter-playcanvas/__tests__/component-mappers.test.ts
    packages/adapter-playcanvas/__tests__/environment.test.ts
    packages/adapter-playcanvas/__tests__/adapter.test.ts
    packages/adapter-playcanvas/vitest.config.ts
  </files>
  <action>
    **1. Create shared mock factory (`__tests__/helpers/pc-mocks.ts`):**

    Create a reusable PlayCanvas mock factory that other test files import. The factory provides fake implementations of: `pc.Entity` (with setLocalPosition, setLocalRotation, setLocalScale, addChild, addComponent, removeComponent, destroy, findByName, enabled, children, parent, name, tags), `pc.Application` (with root entity, scene object, systems, graphicsDevice, assets, fire, on, off, start, destroy), `pc.StandardMaterial` (with diffuse, emissive, metalness, shininess, opacity, update, destroy), `pc.Color` (constructor), `pc.Vec3` (with x,y,z, copy, sub2, normalize, cross, length), `pc.Quat` (with x,y,z,w, setFromEulerAngles, copy), and PlayCanvas constants (BLEND_NORMAL, SHADOW_PCF3, FILLMODE_NONE, etc.).

    Each mock class should use `vi.fn()` for methods so tests can assert on call arguments. The factory should export a `setupPlayCanvasMocks()` function that calls `vi.mock("playcanvas", ...)` with all the mocks, and also export individual mock constructors for direct assertions.

    **2. Create scene-builder tests (`__tests__/scene-builder.test.ts`):**

    Import the mock factory at the top (before other imports per Vitest hoisting rules). Test `buildScene`:
    - Creates entities for each IR node with correct names
    - Applies position, rotation, scale via setLocalPosition/setLocalRotation/setLocalScale
    - Handles parent-child hierarchy (addChild called with correct parent)
    - Returns entityMap with ECSON IDs as keys
    - Handles visibility (entity.enabled = false for invisible nodes)
    - Handles empty scene (0 nodes) without errors

    Test `destroySceneEntities`:
    - Calls destroy() on all entities in the map
    - Returns empty entity map after destruction

    **3. Create component-mappers tests (`__tests__/component-mappers.test.ts`):**

    Test each mapper function:
    - `applyMeshRenderer`: Verifies addComponent("render") with correct type for box, sphere, cylinder, cone, plane, capsule, torus. Tests shadow cast/receive settings.
    - `applyLight`: Verifies addComponent("light") with correct type mapping (directional/point/spot -> directional/omni/spot), color, intensity, shadow settings.
    - `applyCamera`: Verifies addComponent("camera") with correct projection (perspective vs orthographic), fov, near/far clip.
    - `createMaterial`: Verifies StandardMaterial creation with correct diffuse color, metalness, roughness-to-gloss conversion (gloss = 1 - roughness), emissive, opacity.

    **4. Create environment tests (`__tests__/environment.test.ts`):**

    Test `applyEnvironment`:
    - Sets ambient light color and intensity
    - Configures fog type, start, end, density, color
    - Handles fog disabled case (type = "none" / fog disabled)

    Test `getSkyboxColor`:
    - Returns correct Color from hex string
    - Handles missing/default environment values

    **5. Create adapter lifecycle tests (`__tests__/adapter.test.ts`):**

    Test PlayCanvasAdapter class:
    - `initialize`: Creates Application, calls start, sets up editor camera
    - `loadScene`: Calls buildScene and applyEnvironment with correct args, populates entityMap
    - `rebuildScene`: Destroys existing entities before building new ones
    - `dispose`: Destroys Application and cleans up
    - `setPlayMode(true)`: Adjusts timeScale
    - `setPlayMode(false)`: Restores timeScale
    - `getEntityMap()`: Returns current entity map
    - Does not crash when called before initialize

    **6. Update vitest.config.ts:**

    Remove `passWithNoTests: true`. Keep the existing `include` patterns.

    **Key testing principle:** Assert on "was the right PlayCanvas API called with the right arguments?" -- NOT on simulated PlayCanvas internal behavior. Mock fidelity is intentionally low (per research pitfall #1). Real rendering correctness is validated by Playwright visual tests in plan 03-06.
  </action>
  <verify>
    Run `cd /home/frank/riff3d && pnpm vitest run --filter @riff3d/adapter-playcanvas` -- all tests pass, no `passWithNoTests` warning.
    Run `cd /home/frank/riff3d && pnpm turbo test` -- full test suite still green across all packages.
  </verify>
  <done>
    - 5 test files created for core adapter modules (scene-builder, component-mappers, environment, adapter, plus shared mock helper)
    - `passWithNoTests: true` removed from vitest.config.ts
    - All core adapter tests pass via `pnpm vitest run`
    - Full monorepo test suite still green
  </done>
</task>

<task type="auto">
  <name>Task 2: Create editor interaction module tests (gizmo-manager, selection-manager, camera-controller, grid, glb-loader)</name>
  <files>
    packages/adapter-playcanvas/__tests__/gizmo-manager.test.ts
    packages/adapter-playcanvas/__tests__/selection-manager.test.ts
    packages/adapter-playcanvas/__tests__/camera-controller.test.ts
    packages/adapter-playcanvas/__tests__/grid.test.ts
    packages/adapter-playcanvas/__tests__/glb-loader.test.ts
  </files>
  <action>
    **1. Create gizmo-manager tests (`__tests__/gizmo-manager.test.ts`):**

    Use the shared mock factory from Task 1. Test GizmoManager:
    - `setMode("translate" | "rotate" | "scale")`: Switches gizmo mode correctly
    - `attachToEntity(entityId)`: Attaches gizmo to the correct pc.Entity from entity map
    - `detach()`: Removes gizmo from current entity
    - Drag end dispatches a PatchOp (via the DispatchTransformCallback) with correct position/rotation/scale values
    - Handles missing entity gracefully (entity not in map)
    - `dispose()`: Cleans up event listeners

    Mock the store API (GizmoStoreApi) as a simple object with vi.fn() methods for `getGizmoMode()`, `getSelectedEntityIds()`.

    **2. Create selection-manager tests (`__tests__/selection-manager.test.ts`):**

    Test SelectionManager:
    - Click on entity: Calls setSelection callback with picked entity ID
    - Shift-click: Adds/removes entity from selection (toggle behavior)
    - Click on empty space: Clears selection
    - `updateEntityMap(newMap)`: Updates internal entity map reference
    - Box select: Given a rectangle region, selects entities whose screen positions fall within
    - `dispose()`: Removes all event listeners

    Mock the store API (SelectionStoreApi) as a simple object.

    **3. Create camera-controller tests (`__tests__/camera-controller.test.ts`):**

    Test CameraController:
    - `switchMode("fly")`: Sets fly mode
    - `switchMode("orbit")`: Sets orbit mode
    - `initialize(canvas, cameraEntity)`: Attaches event listeners to canvas
    - `dispose()`: Removes all event listeners
    - Fly mode: right-click + mouse move rotates camera, WASD moves camera
    - Orbit mode: alt+click orbits, scroll zooms

    Since the camera controller uses DOM events, create a minimal canvas mock (`document.createElement("canvas")`) with `addEventListener`/`removeEventListener` as vi.fn(). Fire synthetic events and verify camera entity position/rotation updates.

    **4. Create grid tests (`__tests__/grid.test.ts`):**

    Test `createGrid`:
    - Returns a GridHandle with dispose method
    - Creates lines at expected grid intervals
    - `dispose()`: Cleans up all grid entities/drawcalls

    **5. Create glb-loader tests (`__tests__/glb-loader.test.ts`):**

    Test `importGlb`:
    - Walks hierarchy of loaded GLB and extracts entity structure
    - Extracts material information from mesh instances
    - Returns correct GlbImportResult with hierarchy nodes and materials
    - Handles single-mesh GLB (flat hierarchy)
    - Handles multi-mesh GLB (nested hierarchy)

    Mock `app.assets.loadFromUrlAndFilename` and the loaded asset's `resource` (a pc.ContainerResource with instantiateRenderEntity method).

    **Testing note:** For modules that depend on DOM APIs (camera-controller, selection-manager), use `vi.stubGlobal` or JSDOM (already available in Vitest) to provide minimal DOM primitives. Do NOT add `@vitest/browser` -- headless DOM is sufficient for event wiring tests.
  </action>
  <verify>
    Run `cd /home/frank/riff3d && pnpm vitest run --filter @riff3d/adapter-playcanvas` -- all 9 test files pass.
    Run `cd /home/frank/riff3d && pnpm turbo test` -- full test suite still green.
  </verify>
  <done>
    - 5 test files created for editor interaction modules
    - All 9 adapter test files (4 core + 5 editor-tools) pass
    - Full monorepo test suite remains green
    - CF-P2-01 fully resolved: adapter has comprehensive unit test coverage for all modules
  </done>
</task>

</tasks>

<verification>
- `pnpm vitest run --filter @riff3d/adapter-playcanvas` runs all adapter tests with 0 failures
- `packages/adapter-playcanvas/vitest.config.ts` does NOT contain `passWithNoTests`
- At least 30 test assertions across the 9 test files (coverage of all key API surface)
- `pnpm turbo test` passes across entire monorepo
</verification>

<success_criteria>
CF-P2-01 is fully resolved: the PlayCanvas adapter has unit test coverage for all 9 source modules (4 core + 5 editor-tools), `passWithNoTests` is removed, and all tests verify correct PlayCanvas API usage via Vitest mocking without WebGL/GPU dependency.
</success_criteria>

<output>
After completion, create `.planning/phases/03-review-gate-foundation/03-01-SUMMARY.md`
</output>
