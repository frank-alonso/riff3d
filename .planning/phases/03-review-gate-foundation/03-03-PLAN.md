---
phase: 03-review-gate-foundation
plan: 03
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - packages/adapter-playcanvas/src/editor-tools/index.ts
  - packages/adapter-playcanvas/src/editor-tools/gizmo-manager.ts
  - packages/adapter-playcanvas/src/editor-tools/selection-manager.ts
  - packages/adapter-playcanvas/src/editor-tools/camera-controller.ts
  - packages/adapter-playcanvas/src/editor-tools/grid.ts
  - packages/adapter-playcanvas/src/editor-tools/glb-loader.ts
  - packages/adapter-playcanvas/src/index.ts
  - packages/adapter-playcanvas/package.json
  - apps/editor/src/components/editor/viewport/viewport-canvas.tsx
  - apps/editor/src/lib/glb-to-ecson.ts
  - scripts/check-adapter-loc.sh
  - turbo.json
autonomous: true
requirements: []

must_haves:
  truths:
    - "Adapter core exports are available at @riff3d/adapter-playcanvas (adapter, scene-builder, environment, component-mappers, types)"
    - "Editor-tools exports are available at @riff3d/adapter-playcanvas/editor-tools (gizmo-manager, selection-manager, camera-controller, grid, glb-loader)"
    - "Editor app imports are updated to use the correct subpath"
    - "CI LoC budget script enforces the 1500 LoC core budget and fails if exceeded"
    - "All existing tests pass after the split"
  artifacts:
    - path: "packages/adapter-playcanvas/src/editor-tools/index.ts"
      provides: "Barrel export for all editor interaction modules"
    - path: "scripts/check-adapter-loc.sh"
      provides: "CI-ready LoC budget enforcement script"
    - path: "packages/adapter-playcanvas/package.json"
      provides: "Subpath exports configuration: . (core) and ./editor-tools"
  key_links:
    - from: "apps/editor/src/components/editor/viewport/viewport-canvas.tsx"
      to: "@riff3d/adapter-playcanvas/editor-tools"
      via: "import { GizmoManager, SelectionManager, ... }"
      pattern: "from.*adapter-playcanvas/editor-tools"
    - from: "scripts/check-adapter-loc.sh"
      to: "packages/adapter-playcanvas/src/"
      via: "wc -l on core files with 1500 LoC budget check"
      pattern: "wc -l.*adapter-playcanvas"
---

<objective>
Split the PlayCanvas adapter package into core and editor-tools subpath exports, and add a CI LoC budget enforcement script. Core exports (`@riff3d/adapter-playcanvas`) contain the adapter, scene-builder, environment, types, and component-mappers. Editor-tools exports (`@riff3d/adapter-playcanvas/editor-tools`) contain gizmo-manager, selection-manager, camera-controller, grid, and glb-loader.

Purpose: Resolves carry-forward CF-P2-04 from Phase 2 review. The adapter package currently exports everything from a single entry point, making it impossible to enforce the 1500 LoC core budget at a package boundary. Splitting into subpath exports creates a clean architectural boundary between IR-consuming core code and editor interaction code, and enables automated LoC budget enforcement.

Output: Reorganized adapter package with subpath exports, updated editor imports, CI LoC enforcement script, all tests passing.
</objective>

<execution_context>
@/home/frank/.claude/get-shit-done/workflows/execute-plan.md
@/home/frank/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-review-gate-foundation/03-RESEARCH.md
@.planning/phases/03-review-gate-foundation/03-01-SUMMARY.md
@packages/adapter-playcanvas/src/index.ts
@packages/adapter-playcanvas/package.json
@packages/adapter-playcanvas/tsconfig.json
@apps/editor/src/components/editor/viewport/viewport-canvas.tsx
@apps/editor/src/components/editor/viewport/viewport-provider.tsx
@apps/editor/src/lib/glb-to-ecson.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move editor-tools files to subdirectory and update adapter exports</name>
  <files>
    packages/adapter-playcanvas/src/editor-tools/index.ts
    packages/adapter-playcanvas/src/editor-tools/gizmo-manager.ts
    packages/adapter-playcanvas/src/editor-tools/selection-manager.ts
    packages/adapter-playcanvas/src/editor-tools/camera-controller.ts
    packages/adapter-playcanvas/src/editor-tools/grid.ts
    packages/adapter-playcanvas/src/editor-tools/glb-loader.ts
    packages/adapter-playcanvas/src/index.ts
    packages/adapter-playcanvas/package.json
  </files>
  <action>
    **1. Create `src/editor-tools/` directory and move files:**

    Move these files from `src/` to `src/editor-tools/`:
    - `gizmo-manager.ts` -> `editor-tools/gizmo-manager.ts`
    - `selection-manager.ts` -> `editor-tools/selection-manager.ts`
    - `camera-controller.ts` -> `editor-tools/camera-controller.ts`
    - `grid.ts` -> `editor-tools/grid.ts`
    - `glb-loader.ts` -> `editor-tools/glb-loader.ts`

    **2. Create `src/editor-tools/index.ts` barrel export:**

    ```typescript
    export { GizmoManager, type GizmoMode, type GizmoStoreApi, type DispatchTransformCallback } from "./gizmo-manager";
    export { SelectionManager, type SelectionStoreApi, type SetSelectionCallback } from "./selection-manager";
    export { CameraController, createEditorCamera } from "./camera-controller";
    export { createGrid, type GridHandle } from "./grid";
    export { importGlb, type GlbImportResult, type GlbHierarchyNode, type GlbMaterialInfo } from "./glb-loader";
    ```

    **3. Update `src/index.ts` to export only core modules:**

    Remove all editor-tools re-exports. The core index should ONLY export:
    ```typescript
    export { PlayCanvasAdapter } from "./adapter";
    export type { EngineAdapter, CameraMode } from "./types";
    export { buildScene, destroySceneEntities, type BuildSceneResult } from "./scene-builder";
    export { applyEnvironment, getSkyboxColor } from "./environment";
    export { applyMeshRenderer, applyLight, applyCamera, createMaterial, hexToColor } from "./component-mappers/index";
    ```

    **4. Update `package.json` exports field:**

    Add the `./editor-tools` subpath export:
    ```jsonc
    {
      "exports": {
        ".": {
          "types": "./src/index.ts",
          "import": "./src/index.ts"
        },
        "./editor-tools": {
          "types": "./src/editor-tools/index.ts",
          "import": "./src/editor-tools/index.ts"
        }
      }
    }
    ```

    **5. Fix internal imports within moved files:**

    Any imports in the editor-tools files that reference sibling modules (e.g., `./types`, `./adapter`, `./scene-builder`) must be updated to reference the parent directory (e.g., `../types`, `../adapter`, `../scene-builder`). Check each moved file for relative imports.

    **6. Update test file imports:**

    The adapter test files created in 03-01 import from source paths. Update any that import editor-tools modules to use the new paths (e.g., `../src/gizmo-manager` -> `../src/editor-tools/gizmo-manager`).

    **7. Update editor app imports:**

    In `apps/editor/`, change imports:
    - `viewport-canvas.tsx`: Split the import -- core types from `@riff3d/adapter-playcanvas`, editor tools from `@riff3d/adapter-playcanvas/editor-tools`
    - `viewport-provider.tsx`: Likely only uses `PlayCanvasAdapter` -- stays with core import
    - `glb-to-ecson.ts`: Uses `GlbImportResult` -- move to `@riff3d/adapter-playcanvas/editor-tools`

    **8. Verify no remaining broken imports:**

    Run `pnpm turbo typecheck` across the entire monorepo to catch any broken imports.
  </action>
  <verify>
    Run `cd /home/frank/riff3d && pnpm turbo typecheck` -- no type errors.
    Run `cd /home/frank/riff3d && pnpm turbo test` -- all tests pass.
    Run `cd /home/frank/riff3d && pnpm turbo lint` -- no lint errors.
    Verify `ls packages/adapter-playcanvas/src/editor-tools/` shows 6 files (5 modules + index.ts).
    Verify `packages/adapter-playcanvas/src/gizmo-manager.ts` no longer exists (moved, not copied).
  </verify>
  <done>
    - Editor-tools modules moved to `src/editor-tools/` subdirectory
    - Core `src/index.ts` exports only IR-consuming modules
    - `src/editor-tools/index.ts` exports only editor interaction modules
    - `package.json` has both `.` and `./editor-tools` subpath exports
    - All internal, test, and editor app imports updated
    - Monorepo typechecks, tests, and lints cleanly
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CI LoC budget enforcement script and integrate with Turbo</name>
  <files>
    scripts/check-adapter-loc.sh
    turbo.json
  </files>
  <action>
    **1. Create `scripts/check-adapter-loc.sh`:**

    ```bash
    #!/usr/bin/env bash
    set -euo pipefail

    BUDGET=1500
    ADAPTER_DIR="packages/adapter-playcanvas/src"

    # Core files: adapter, scene-builder, environment, types, index, component-mappers
    CORE_FILES=(
      "$ADAPTER_DIR/adapter.ts"
      "$ADAPTER_DIR/scene-builder.ts"
      "$ADAPTER_DIR/environment.ts"
      "$ADAPTER_DIR/types.ts"
      "$ADAPTER_DIR/index.ts"
    )

    # Include all component mapper files
    for f in "$ADAPTER_DIR"/component-mappers/*.ts; do
      CORE_FILES+=("$f")
    done

    TOTAL=$(wc -l "${CORE_FILES[@]}" | tail -1 | awk '{print $1}')

    echo "Adapter core LoC: $TOTAL / $BUDGET"
    echo ""
    echo "File breakdown:"
    wc -l "${CORE_FILES[@]}"

    if [ "$TOTAL" -gt "$BUDGET" ]; then
      echo ""
      echo "FAIL: Core adapter exceeds LoC budget ($TOTAL > $BUDGET)"
      exit 1
    else
      echo ""
      echo "PASS: Core adapter within LoC budget"
    fi
    ```

    Make it executable: `chmod +x scripts/check-adapter-loc.sh`

    **2. Add a `check-loc` task to turbo.json:**

    Add a new task:
    ```jsonc
    "check-loc": {}
    ```

    **3. Add a `check-loc` script to the adapter package.json:**

    ```jsonc
    "check-loc": "bash ../../scripts/check-adapter-loc.sh"
    ```

    **4. Verify the script works:**

    Run the script and confirm it reports the current core LoC (should be ~818 per Phase 2 review) and outputs PASS.
  </action>
  <verify>
    Run `cd /home/frank/riff3d && bash scripts/check-adapter-loc.sh` -- outputs "PASS" with LoC under 1500.
    Run `cd /home/frank/riff3d && pnpm turbo check-loc` -- passes via Turbo task.
    Verify script is executable: `test -x scripts/check-adapter-loc.sh`
  </verify>
  <done>
    - `scripts/check-adapter-loc.sh` created and executable
    - Script correctly counts only core adapter files (not editor-tools)
    - Script reports current LoC and PASS/FAIL against 1500 budget
    - Turbo task `check-loc` is configured and runnable
    - CF-P2-04 fully resolved: adapter split into subpath exports with CI LoC budget enforcement
  </done>
</task>

</tasks>

<verification>
- `pnpm turbo typecheck lint test` -- full monorepo pipeline green
- `bash scripts/check-adapter-loc.sh` -- PASS with LoC details
- `packages/adapter-playcanvas/src/editor-tools/` contains 6 files
- `packages/adapter-playcanvas/src/index.ts` does NOT export gizmo-manager, selection-manager, camera-controller, grid, or glb-loader
- Editor app imports use `@riff3d/adapter-playcanvas/editor-tools` for editor-tools modules
</verification>

<success_criteria>
CF-P2-04 is fully resolved: the adapter package is cleanly split into core (IR-consuming, ~818 LoC) and editor-tools (interaction, ~1625 LoC) subpath exports. The CI LoC budget script enforces the 1500 LoC limit on core modules. All imports updated, all tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/03-review-gate-foundation/03-03-SUMMARY.md`
</output>
