---
phase: 03-review-gate-foundation
plan: 06
type: execute
wave: 3
depends_on: [03-03]
files_modified:
  - apps/editor/playwright.config.ts
  - apps/editor/e2e/golden-path.e2e.ts
  - apps/editor/e2e/visual/fixture-render.visual.ts
  - apps/editor/e2e/helpers/auth.ts
  - apps/editor/package.json
  - packages/adapter-playcanvas/src/adapter.ts
autonomous: true
requirements: []

must_haves:
  truths:
    - "A golden-path E2E smoke test runs the full editor lifecycle: create -> edit -> save -> reload -> verify"
    - "Visual baseline tests capture Playwright screenshots of golden fixtures rendered in PlayCanvas"
    - "Visual tests are non-blocking beta (pnpm test:visual) -- do not gate Phase 3 pass/fail"
    - "E2E runs locally via pnpm test:e2e -- no cloud CI dependency"
    - "Adapter emits __sceneReady signal for reliable screenshot timing"
  artifacts:
    - path: "apps/editor/playwright.config.ts"
      provides: "Playwright configuration with e2e and visual test projects"
    - path: "apps/editor/e2e/golden-path.e2e.ts"
      provides: "Golden-path E2E smoke test: create, edit, save, reload, verify"
    - path: "apps/editor/e2e/visual/fixture-render.visual.ts"
      provides: "Visual baseline screenshots for golden fixtures in PlayCanvas"
    - path: "apps/editor/e2e/helpers/auth.ts"
      provides: "Shared Playwright auth helper for test login"
  key_links:
    - from: "apps/editor/e2e/golden-path.e2e.ts"
      to: "http://localhost:3000"
      via: "Playwright navigation to editor app"
      pattern: "page\\.goto"
    - from: "apps/editor/e2e/visual/fixture-render.visual.ts"
      to: "__sceneReady"
      via: "window.addEventListener for scene ready signal before screenshot"
      pattern: "__sceneReady"
    - from: "packages/adapter-playcanvas/src/adapter.ts"
      to: "window"
      via: "CustomEvent dispatch after loadScene completes"
      pattern: "__sceneReady"
---

<objective>
Set up Playwright for E2E testing and visual regression. Create a golden-path E2E smoke test that exercises the full editor lifecycle (create, edit, save, reload, verify) and a beta visual baseline test suite that captures screenshots of golden fixtures rendered in PlayCanvas.

Purpose: The E2E smoke test validates the complete editor pipeline end-to-end in an automated, repeatable way. Visual baseline testing (beta, non-blocking) establishes the foundation for Phase 4 dual-adapter visual comparison. The `__sceneReady` signal ensures screenshots are captured at a deterministic point.

Output: Playwright config, E2E smoke test, visual baseline tests, `__sceneReady` signal in adapter.
</objective>

<execution_context>
@/home/frank/.claude/get-shit-done/workflows/execute-plan.md
@/home/frank/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-review-gate-foundation/03-RESEARCH.md
@.planning/phases/03-review-gate-foundation/03-03-SUMMARY.md
@packages/adapter-playcanvas/src/adapter.ts
@apps/editor/package.json
@packages/fixtures/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add __sceneReady signal to adapter and set up Playwright configuration</name>
  <files>
    packages/adapter-playcanvas/src/adapter.ts
    apps/editor/playwright.config.ts
    apps/editor/e2e/helpers/auth.ts
    apps/editor/package.json
  </files>
  <action>
    **1. Add `__sceneReady` signal to PlayCanvasAdapter:**

    In `packages/adapter-playcanvas/src/adapter.ts`, update the `loadScene` method to emit a custom DOM event after the scene is rendered:

    After `buildScene`, `applyEnvironment`, and `entityMap` assignment, add:
    ```typescript
    // Signal scene is ready for visual testing / screenshot capture
    // Wait one frame for rendering to complete
    if (this.app) {
      this.app.once("frameend", () => {
        if (typeof window !== "undefined") {
          window.dispatchEvent(new CustomEvent("__sceneReady"));
        }
      });
    }
    ```

    Also add the signal in `rebuildScene` (same pattern).

    **2. Install Playwright as devDependency on editor:**

    Add to `apps/editor/package.json` devDependencies:
    ```jsonc
    "@playwright/test": "^1.58"
    ```

    Run `pnpm install` to install.

    **3. Create Playwright configuration (`apps/editor/playwright.config.ts`):**

    ```typescript
    import { defineConfig } from "@playwright/test";

    export default defineConfig({
      testDir: "./e2e",
      timeout: 60_000,
      retries: 0,
      use: {
        baseURL: "http://localhost:3000",
        browserName: "chromium",
        viewport: { width: 1280, height: 720 },
        screenshot: "only-on-failure",
        trace: "on-first-retry",
      },
      projects: [
        {
          name: "e2e",
          testMatch: /.*\.e2e\.ts/,
        },
        {
          name: "visual",
          testMatch: /.*\.visual\.ts/,
        },
      ],
      expect: {
        toHaveScreenshot: {
          maxDiffPixelRatio: 0.02,
          threshold: 0.3,
        },
      },
      webServer: {
        command: "pnpm dev",
        url: "http://localhost:3000",
        reuseExistingServer: true,
        timeout: 30_000,
      },
    });
    ```

    **4. Create auth helper (`e2e/helpers/auth.ts`):**

    Shared login helper for E2E tests:
    ```typescript
    import { Page } from "@playwright/test";

    export async function loginAsTestUser(page: Page): Promise<void> {
      // Navigate to login page
      // Fill email and password for test user
      // Submit and wait for redirect to dashboard
      // The test user credentials come from env vars or use magic link flow
    }
    ```

    Use environment variables `E2E_TEST_EMAIL` and `E2E_TEST_PASSWORD` for test user credentials. If not set, skip tests that require auth.

    **5. Add scripts to editor package.json:**

    ```jsonc
    "test:e2e": "playwright test --project=e2e",
    "test:visual": "playwright test --project=visual",
    "test:visual:update": "playwright test --project=visual --update-snapshots"
    ```

    **6. Add `.gitignore` entries for Playwright artifacts:**

    Add to `apps/editor/.gitignore` (or project root):
    ```
    # Playwright
    test-results/
    playwright-report/
    ```

    But DO commit `e2e/**/*-snapshots/` (visual baselines).
  </action>
  <verify>
    Run `cd /home/frank/riff3d && pnpm turbo typecheck` -- no type errors (adapter, editor).
    Verify `apps/editor/playwright.config.ts` exists with both e2e and visual projects.
    Verify `packages/adapter-playcanvas/src/adapter.ts` contains `__sceneReady` dispatch.
    Run `cd /home/frank/riff3d && pnpm turbo test` -- all existing tests still pass.
  </verify>
  <done>
    - `__sceneReady` signal added to adapter's loadScene and rebuildScene
    - Playwright installed and configured with e2e + visual projects
    - Auth helper created for test login
    - Scripts added: `test:e2e`, `test:visual`, `test:visual:update`
    - Generous thresholds set for WebGL visual comparison (2% pixel diff, 0.3 color threshold)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create golden-path E2E smoke test and visual baseline beta tests</name>
  <files>
    apps/editor/e2e/golden-path.e2e.ts
    apps/editor/e2e/visual/fixture-render.visual.ts
  </files>
  <action>
    **1. Create golden-path E2E smoke test (`e2e/golden-path.e2e.ts`):**

    This single E2E test exercises the full editor lifecycle. Use `@playwright/test` imports.

    ```typescript
    import { test, expect } from "@playwright/test";
    ```

    **Test flow (create -> edit -> save -> reload -> verify):**

    1. **Login**: Navigate to `/`, authenticate as test user (skip if no test credentials)
    2. **Create project**: Click "New Project" on dashboard, enter name "E2E Test Project", submit
    3. **Wait for editor**: Wait for the editor shell to load (wait for viewport canvas element)
    4. **Wait for scene**: Wait for `__sceneReady` event (scene rendered in PlayCanvas)
    5. **Verify viewport**: Assert canvas element exists and has non-zero dimensions
    6. **Edit**: Click an entity in the hierarchy panel, verify it's selected (inspector shows entity name)
    7. **Modify**: Change a property in the inspector (e.g., entity name or position value)
    8. **Save**: Trigger save (Ctrl+S or wait for auto-save debounce)
    9. **Reload**: Navigate away and back to the editor page (`page.reload()`)
    10. **Verify persistence**: Wait for `__sceneReady`, verify the modification persists (entity name matches)
    11. **Cleanup**: Delete the test project (navigate to dashboard, delete project)

    Use `test.skip()` if required env vars (`E2E_TEST_EMAIL`, `E2E_TEST_PASSWORD`, or Supabase credentials) are not set.

    **Important:** This test must work with the real editor app at `http://localhost:3000`. It needs the dev server running. The Playwright config's `webServer` handles this.

    **2. Create visual baseline tests (`e2e/visual/fixture-render.visual.ts`):**

    These tests load golden fixtures into the editor and capture screenshots. Non-blocking beta.

    ```typescript
    import { test, expect } from "@playwright/test";

    const FIXTURES = ["simple-scene", "all-components", "deep-hierarchy"];
    // Use fixture names from packages/fixtures
    ```

    For each fixture:
    1. Navigate to the editor with the fixture loaded (either via URL param or by creating a project with fixture data)
    2. Wait for `__sceneReady` signal:
       ```typescript
       await page.evaluate(() => {
         return new Promise<void>((resolve) => {
           if ((window as any).__sceneAlreadyReady) {
             resolve();
             return;
           }
           window.addEventListener("__sceneReady", () => resolve(), { once: true });
         });
       });
       ```
    3. Capture screenshot:
       ```typescript
       await expect(page.locator("canvas")).toHaveScreenshot(`${fixtureName}.png`);
       ```

    **Note:** First run generates baselines (no comparison). Use `pnpm test:visual:update` to regenerate baselines.

    **Visual test approach:**
    - If loading fixtures via the normal editor flow requires auth, use the auth helper
    - Alternatively, create a dev-only route `/editor/fixture/[fixtureName]` that loads a fixture directly without Supabase (check if such a route exists or is feasible)
    - If neither approach works within context budget, create visual tests that load a fixture programmatically via `page.evaluate()` by calling adapter APIs directly

    **3. Add test documentation:**

    Add a comment at the top of each test file explaining how to run it:
    ```typescript
    /**
     * Golden-path E2E smoke test.
     * Run: pnpm test:e2e (requires dev server + Supabase + test user)
     * Env vars: E2E_TEST_EMAIL, E2E_TEST_PASSWORD
     */
    ```
  </action>
  <verify>
    Verify `apps/editor/e2e/golden-path.e2e.ts` exists with create/edit/save/reload/verify flow.
    Verify `apps/editor/e2e/visual/fixture-render.visual.ts` exists with fixture screenshot capture.
    Run `cd /home/frank/riff3d && pnpm turbo typecheck` -- no type errors in e2e files.
    Verify scripts in package.json: `test:e2e`, `test:visual`, `test:visual:update`.
  </verify>
  <done>
    - Golden-path E2E smoke test covers full lifecycle: create, edit, save, reload, verify
    - Visual baseline tests capture screenshots for golden fixtures
    - Tests skip gracefully when env vars missing (no failures in CI)
    - Visual tests are opt-in beta (`pnpm test:visual`) -- do NOT gate Phase 3
    - `__sceneReady` signal ensures deterministic screenshot timing
    - All infrastructure ready for Phase 4 dual-adapter visual comparison
  </done>
</task>

</tasks>

<verification>
- `apps/editor/playwright.config.ts` exists and is valid
- `apps/editor/e2e/golden-path.e2e.ts` exists with full lifecycle test
- `apps/editor/e2e/visual/fixture-render.visual.ts` exists with fixture screenshots
- `__sceneReady` event dispatched in adapter `loadScene` and `rebuildScene`
- `pnpm turbo typecheck` passes across monorepo
- `pnpm turbo test` passes (Playwright tests are NOT in the standard test pipeline)
</verification>

<success_criteria>
E2E infrastructure is established: a golden-path smoke test validates the complete editor lifecycle, visual baseline tests capture PlayCanvas rendering for future dual-adapter comparison, and the `__sceneReady` signal provides reliable screenshot timing. All tests run locally via Playwright commands, not in CI (per locked decision).
</success_criteria>

<output>
After completion, create `.planning/phases/03-review-gate-foundation/03-06-SUMMARY.md`
</output>
