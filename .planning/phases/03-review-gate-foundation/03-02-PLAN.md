---
phase: 03-review-gate-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/patchops/__tests__/engine.test.ts
  - packages/patchops/__tests__/inverse.test.ts
  - packages/canonical-ir/__tests__/compiler.test.ts
  - packages/canonical-ir/__tests__/decompiler.test.ts
  - packages/canonical-ir/__tests__/round-trip.test.ts
  - packages/conformance/__tests__/round-trip.test.ts
  - packages/conformance/__tests__/replay.test.ts
  - packages/conformance/__tests__/lossiness-contract.test.ts
  - packages/fixtures/__tests__/builders.test.ts
autonomous: true
requirements: []

must_haves:
  truths:
    - "All test files constructing ECSON documents use SceneDocumentSchema.parse() instead of raw object literals"
    - "Schema validation catches any test data that would violate ECSON contracts"
    - "All existing tests still pass after migration -- no regressions"
  artifacts:
    - path: "packages/patchops/__tests__/engine.test.ts"
      provides: "PatchOps engine tests using schema-validated test documents"
    - path: "packages/conformance/__tests__/round-trip.test.ts"
      provides: "Round-trip conformance tests using schema-validated documents"
  key_links:
    - from: "packages/patchops/__tests__/engine.test.ts"
      to: "@riff3d/ecson"
      via: "SceneDocumentSchema.parse() import"
      pattern: "SceneDocumentSchema\\.parse"
---

<objective>
Migrate all test document construction across the monorepo to use `SceneDocumentSchema.parse()` instead of raw object literals. This ensures test data is always contract-valid and prevents schema drift where tests silently use outdated or invalid ECSON shapes.

Purpose: Resolves carry-forward CF-P2-03 from Phase 2 review. When tests construct ECSON documents as raw objects, they bypass Zod validation and can drift from the actual schema. This was identified when test fog objects used `type: "none"` which is not in the FogTypeEnum. Schema-validated construction catches these issues at test time.

Output: All test files across patchops, canonical-ir, conformance, and fixtures packages updated to use `SceneDocumentSchema.parse()` for document construction.
</objective>

<execution_context>
@/home/frank/.claude/get-shit-done/workflows/execute-plan.md
@/home/frank/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-review-gate-foundation/03-RESEARCH.md
@packages/ecson/src/schemas.ts
@packages/patchops/__tests__/engine.test.ts
@packages/patchops/__tests__/inverse.test.ts
@packages/canonical-ir/__tests__/compiler.test.ts
@packages/canonical-ir/__tests__/decompiler.test.ts
@packages/canonical-ir/__tests__/round-trip.test.ts
@packages/conformance/__tests__/round-trip.test.ts
@packages/conformance/__tests__/replay.test.ts
@packages/conformance/__tests__/lossiness-contract.test.ts
@packages/fixtures/__tests__/builders.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit all test files for raw ECSON document construction and migrate to SceneDocumentSchema.parse()</name>
  <files>
    packages/patchops/__tests__/engine.test.ts
    packages/patchops/__tests__/inverse.test.ts
    packages/canonical-ir/__tests__/compiler.test.ts
    packages/canonical-ir/__tests__/decompiler.test.ts
    packages/canonical-ir/__tests__/round-trip.test.ts
    packages/conformance/__tests__/round-trip.test.ts
    packages/conformance/__tests__/replay.test.ts
    packages/conformance/__tests__/lossiness-contract.test.ts
    packages/fixtures/__tests__/builders.test.ts
  </files>
  <action>
    **Step 1: Audit** — Search all test files in `packages/*/\__tests__/` for patterns that construct ECSON documents:
    - Direct `SceneDocument` type assertions (e.g., `as SceneDocument` or `: SceneDocument`)
    - Object literals with `schemaVersion`, `rootEntityId`, `entities` fields
    - Helper functions like `createTestDoc`, `createEmptyDoc`, `makeDoc`, etc.
    - Entity construction with raw objects matching EntitySchema shape

    **Step 2: Create shared test helper** — If multiple test files use similar document construction patterns, consider a shared helper (e.g., in the fixtures package or a local `helpers/` directory). The helper should use `SceneDocumentSchema.parse()` so all consumers get validated documents automatically.

    Pattern for migration:
    ```typescript
    // BEFORE (raw object, can drift from schema):
    const doc: SceneDocument = {
      id: "doc_001",
      name: "Test",
      schemaVersion: 1,
      rootEntityId: "root_001",
      entities: { ... },
      environment: { fog: { type: "none" } }, // BUG: invalid fog type
    };

    // AFTER (schema-validated, defaults applied):
    import { SceneDocumentSchema, CURRENT_SCHEMA_VERSION } from "@riff3d/ecson";
    const doc = SceneDocumentSchema.parse({
      id: "doc_001",
      name: "Test",
      schemaVersion: CURRENT_SCHEMA_VERSION,
      rootEntityId: "root_001",
      entities: { ... },
      // environment gets schema defaults -- no invalid fog types possible
    });
    ```

    **Step 3: Migrate each file** — For each file identified in the audit:
    1. Add `import { SceneDocumentSchema, CURRENT_SCHEMA_VERSION } from "@riff3d/ecson"` (or from fixtures if using shared helper)
    2. Replace raw object construction with `SceneDocumentSchema.parse(...)`
    3. Remove explicit type annotations (`.parse()` returns the correct type via Zod inference)
    4. Let Zod defaults fill in optional fields instead of manually specifying them
    5. Fix any test data that would fail validation (e.g., invalid enum values, missing required fields)

    **Step 4: Handle edge cases:**
    - Some tests may intentionally construct invalid documents (e.g., mutation-bypass tests, error handling tests). These should NOT be migrated -- they need raw objects to test error paths. Add a comment: `// Intentionally raw: testing invalid document handling`
    - Property test generators (`fast-check` arbitraries) that generate documents may already use schema construction. Verify and leave alone if so.
    - The fixtures package's builder functions (`buildSimpleScene`, etc.) already use `SceneDocumentSchema.parse()` per 01-06 decisions. Verify these are correct.

    **Step 5: Verify no test regressions** — Run the full test suite after migration. Any failures indicate test data that was silently invalid. Fix the test data to be schema-compliant, not the schema.
  </action>
  <verify>
    Run `cd /home/frank/riff3d && pnpm turbo test` -- all tests pass across all packages.
    Search for remaining raw document construction: `grep -r "as SceneDocument" packages/*/\__tests__/` should return only intentionally raw cases (commented).
    Run `cd /home/frank/riff3d && pnpm turbo typecheck` -- no type errors.
  </verify>
  <done>
    - All test document construction uses `SceneDocumentSchema.parse()` (except intentionally raw test cases which are commented)
    - CURRENT_SCHEMA_VERSION is used instead of hardcoded version numbers
    - Zod defaults handle optional fields instead of manual specification
    - All tests pass -- no regressions from migration
    - Any previously-invalid test data has been fixed to be schema-compliant
    - CF-P2-03 fully resolved
  </done>
</task>

</tasks>

<verification>
- `pnpm turbo test` passes across entire monorepo
- `grep -rn "SceneDocumentSchema.parse" packages/*/\__tests__/` shows usage in all migrated files
- No raw `as SceneDocument` casts remain in test files (except intentionally raw cases)
- `pnpm turbo typecheck` passes
</verification>

<success_criteria>
CF-P2-03 is fully resolved: all test files across the monorepo construct ECSON documents via `SceneDocumentSchema.parse()`, preventing schema drift and ensuring test data is always contract-valid. All existing tests continue to pass.
</success_criteria>

<output>
After completion, create `.planning/phases/03-review-gate-foundation/03-02-SUMMARY.md`
</output>
