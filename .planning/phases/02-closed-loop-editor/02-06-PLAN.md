---
phase: 02-closed-loop-editor
plan: 06
type: execute
wave: 5
depends_on: ["02-02", "02-05"]
files_modified:
  - apps/editor/src/components/editor/assets/asset-browser.tsx
  - apps/editor/src/components/editor/assets/asset-card.tsx
  - apps/editor/src/components/editor/assets/asset-strip.tsx
  - apps/editor/src/components/editor/assets/glb-import.tsx
  - apps/editor/src/components/editor/inspector/widgets/environment-panel.tsx
  - apps/editor/src/lib/asset-manager.ts
  - apps/editor/src/lib/glb-to-ecson.ts
  - packages/adapter-playcanvas/src/glb-loader.ts
  - packages/adapter-playcanvas/src/environment.ts
  - apps/editor/src/stores/slices/scene-slice.ts
  - apps/editor/src/components/editor/shell/editor-shell.tsx
autonomous: true
requirements:
  - EDIT-09
  - RNDR-04
  - RNDR-05

must_haves:
  truths:
    - "Asset browser panel shows starter assets organized by category (primitives, lights, cameras)"
    - "User can drag an asset from the browser to spawn it in the scene as a new entity"
    - "User can import a GLB file and see it render in the viewport with textures and materials"
    - "User can adjust environment settings (ambient light, fog, sky color) and see changes in viewport"
    - "Compact asset strip below viewport allows quick drag-and-drop of frequently used assets"
  artifacts:
    - path: "apps/editor/src/components/editor/assets/asset-browser.tsx"
      provides: "Full asset browser panel with categories"
      contains: "AssetCard"
    - path: "apps/editor/src/lib/glb-to-ecson.ts"
      provides: "GLB hierarchy conversion to ECSON PatchOps"
      exports: ["glbToEcsonOps"]
    - path: "packages/adapter-playcanvas/src/glb-loader.ts"
      provides: "PlayCanvas GLB loading and hierarchy extraction"
      exports: ["importGlb"]
    - path: "apps/editor/src/components/editor/inspector/widgets/environment-panel.tsx"
      provides: "Environment settings editor (ambient, fog, sky)"
      contains: "EnvironmentSettings"
  key_links:
    - from: "apps/editor/src/components/editor/assets/asset-browser.tsx"
      to: "editorStore dispatchOp"
      via: "drag-to-scene creates CreateEntity + AddComponent PatchOps"
      pattern: "CreateEntity"
    - from: "apps/editor/src/lib/glb-to-ecson.ts"
      to: "@riff3d/patchops"
      via: "converts GLB hierarchy to PatchOp batch"
      pattern: "BatchOp"
    - from: "apps/editor/src/components/editor/inspector/widgets/environment-panel.tsx"
      to: "editorStore dispatchOp"
      via: "environment changes dispatch SetProperty PatchOps on environment"
      pattern: "SetProperty.*environment"
---

<objective>
Build the asset browser (with starter assets), GLB import pipeline, and environment settings editor. Users can browse and drag starter assets into the scene, import external GLB/glTF files with materials and textures, and configure the scene environment (ambient light, fog, sky color).

Purpose: Assets and environment turn the editor from a primitive-shapes-only tool into one that can handle real content. GLB import is the primary way users bring existing 3D content into Riff3D.
Output: Asset browser with categories, GLB import with material/texture extraction, environment panel, compact asset strip.
</objective>

<execution_context>
@/home/frank/.claude/get-shit-done/workflows/execute-plan.md
@/home/frank/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-closed-loop-editor/02-RESEARCH.md
@.planning/phases/02-closed-loop-editor/02-CONTEXT.md
@.planning/phases/02-closed-loop-editor/02-02-SUMMARY.md
@.planning/phases/02-closed-loop-editor/02-05-SUMMARY.md
@packages/ecson/src/schemas/environment.ts
@packages/ecson/src/schemas/asset.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Asset browser, starter assets, and asset strip</name>
  <files>
    apps/editor/src/components/editor/assets/asset-browser.tsx
    apps/editor/src/components/editor/assets/asset-card.tsx
    apps/editor/src/components/editor/assets/asset-strip.tsx
    apps/editor/src/lib/asset-manager.ts
    apps/editor/src/stores/slices/scene-slice.ts
    apps/editor/src/components/editor/shell/editor-shell.tsx
  </files>
  <action>
    **Asset Manager** (`lib/asset-manager.ts`):
    - Define `StarterAsset` type: `{ id, name, category, icon, description, createOps(parentId) => PatchOp[] }`
    - Define starter asset catalog (curated primitives and basic objects):
      - **Primitives:** Cube, Sphere, Cylinder, Cone, Capsule, Plane
      - **Lights:** Point Light, Spot Light, Directional Light
      - **Cameras:** Perspective Camera, Orthographic Camera
      - **Other:** Empty Entity
    - Each starter asset's `createOps(parentId)` returns a BatchOp containing:
      - `CreateEntity` with appropriate name
      - `AddComponent` for each component (e.g., MeshRenderer for primitives, Light for lights)
      - Default transform (positioned slightly in front of camera or at origin)
    - Categories: `'primitives' | 'lights' | 'cameras' | 'other'`

    **Asset Browser** (`assets/asset-browser.tsx`):
    - Full panel shown when Assets tab is active in the activity bar.
    - Category tabs/sections at the top: Primitives, Lights, Cameras, Other.
    - Grid of AssetCards within each category.
    - Search input to filter assets by name.
    - Each card is draggable (HTML5 drag and drop) -- on drag start, set transfer data with asset ID.
    - On drop in the viewport: read asset ID, call `asset.createOps(currentParentId)`, dispatch as BatchOp. Select the newly created entity.

    **Asset Card** (`assets/asset-card.tsx`):
    - Small card with icon (Lucide icon matching the asset type), name, and category badge.
    - Hover: subtle highlight. Draggable cursor.
    - Click: also spawns the asset at origin (alternative to drag).

    **Asset Strip** (`assets/asset-strip.tsx`):
    - Per user decision: compact bottom strip below viewport for drag-and-drop into scene.
    - Horizontal scrollable strip showing most-used assets as small icon buttons.
    - Includes: Cube, Sphere, Point Light, Empty Entity (the most common adds).
    - Same drag-and-drop behavior as the full browser.

    **Update EditorShell:**
    - Mount AssetBrowser in the left sidebar when `activePanel === 'assets'`.
    - Mount AssetStrip in the bottom area of the center panel (below viewport, above any future timeline area).
    - Add drop handler on viewport canvas container: on `dragover` prevent default, on `drop` read asset data and dispatch ops.

    **Update scene-slice:** Add `addEntity(parentId: string, name: string, components: ComponentInstance[])` convenience action that generates CreateEntity + AddComponent PatchOps from the asset data and dispatches as BatchOp.
  </action>
  <verify>
    - `pnpm typecheck --filter @riff3d/editor` passes
    - `pnpm lint --filter @riff3d/editor` passes
    - Asset browser shows categories with starter assets
    - Clicking an asset spawns it in the scene
    - Drag-and-drop from browser/strip to viewport spawns the asset
    - Asset strip shows horizontally scrollable quick-add buttons
    - New entities appear in hierarchy and viewport after adding
  </verify>
  <done>
    Asset browser panel with 12+ starter assets in categories (primitives, lights, cameras, other). Drag-and-drop or click to spawn assets as new entities via PatchOps. Compact asset strip below viewport for quick access.
  </done>
</task>

<task type="auto">
  <name>Task 2: GLB import and environment settings</name>
  <files>
    apps/editor/src/components/editor/assets/glb-import.tsx
    apps/editor/src/lib/glb-to-ecson.ts
    packages/adapter-playcanvas/src/glb-loader.ts
    packages/adapter-playcanvas/src/environment.ts
    apps/editor/src/components/editor/inspector/widgets/environment-panel.tsx
  </files>
  <action>
    **GLB Loader** (`packages/adapter-playcanvas/src/glb-loader.ts`):
    - `importGlb(app: pc.Application, url: string): Promise<GlbImportResult>`:
      1. Load GLB via `app.assets.loadFromUrl(url, 'container', callback)`
      2. Get container resource: `asset.resource`
      3. Instantiate: `asset.resource.instantiateRenderEntity({ castShadows: true, receiveShadows: true })`
      4. Walk the instantiated hierarchy and extract:
         - Entity tree structure (names, parent-child relationships)
         - Materials (StandardMaterial properties: diffuse, metalness, gloss, emissive, opacity, textures)
         - Mesh references (for render components)
         - Animations (if any -- store as asset refs for Phase 7)
      5. Return `GlbImportResult`: `{ rootEntity, materials, meshes, animations, hierarchy }`
    - `GlbImportResult` type captures all extracted data.

    **GLB to ECSON** (`apps/editor/src/lib/glb-to-ecson.ts`):
    - `glbToEcsonOps(importResult: GlbImportResult, parentId: string): PatchOp[]`:
      1. Walk the GLB hierarchy and create PatchOps:
         - `CreateEntity` for each node (generate new ECSON entity IDs)
         - `AddComponent` with `MeshRenderer` for mesh nodes
         - `AddComponent` with `Material` for material properties (extract from PlayCanvas StandardMaterial)
         - `AddAsset` for texture/mesh asset entries (store URL or binary reference)
      2. Maintain ID mapping: GLB node -> ECSON entity ID for parent-child linking
      3. Set transforms from the GLB node local transforms
      4. Return as BatchOp for atomic dispatch
    - Material extraction: map PlayCanvas StandardMaterial back to ECSON Material component properties:
      - `diffuse` Color -> `baseColor` hex string
      - `metalness` -> `metallic`
      - `gloss` -> `roughness` (invert: roughness = 1 - gloss)
      - `emissive` Color -> `emissive` hex string
      - `emissiveIntensity` -> `emissiveIntensity`
      - `opacity` -> `opacity`

    **GLB Import UI** (`assets/glb-import.tsx`):
    - Import button in asset browser (or file menu area) that opens a file picker.
    - Accept `.glb`, `.gltf` file types.
    - On file selected:
      1. Upload file to Supabase Storage bucket (`project-assets/[projectId]/[filename]`)
      2. Get public URL from Supabase Storage
      3. Call `importGlb(app, url)` to load into PlayCanvas
      4. Call `glbToEcsonOps(result, rootEntityId)` to generate PatchOps
      5. Dispatch BatchOp to add all entities and components to ECSON
      6. Show toast: "Imported [filename] (N entities, M materials)"
    - Loading indicator while importing (spinner on the import button or toast).
    - Error handling: toast with error message if import fails.

    **Environment Settings Panel** (`inspector/widgets/environment-panel.tsx`):
    - Separate panel section that appears when user selects "Environment" from the activity bar or a dedicated panel area.
    - Or: show in inspector when no entity is selected (common editor pattern).
    - Settings mapped from ECSON `EnvironmentSettings` schema:
      - **Ambient Light:** Color picker + intensity slider
      - **Fog:** Type dropdown (none, linear, exp, exp2), color picker, density/start/end sliders (conditional on fog type)
      - **Sky:** Color picker for solid color skybox. (Image-based skybox deferred -- note in UI as "coming soon")
      - **Exposure:** Slider (0.5 to 3.0, default 1.0)
    - Each change dispatches a `SetProperty` PatchOp targeting `environment.[property]` path.
    - Changes immediately reflected in viewport via adapter `applyEnvironment()` call (subscribe to environment changes in store).

    **Update adapter environment.ts:** Ensure `applyEnvironment()` handles all the environment settings:
    - `scene.ambientLight` from ambient color
    - Fog: `scene.fog` type + color + density/start/end
    - Sky color: set `scene.skybox` to a solid color cubemap or set `scene.clearColor`
    - Exposure: `scene.exposure`
    - Subscribe to store environment changes for incremental updates (not full recompile).
  </action>
  <verify>
    - `pnpm typecheck` passes across all packages
    - `pnpm lint` passes
    - GLB import loads a .glb file and creates entities in the scene
    - Imported GLB shows correct materials and textures
    - Environment panel shows ambient, fog, sky, exposure controls
    - Changing environment settings updates the viewport in real-time
    - All changes produce PatchOps (verifiable in undo stack)
  </verify>
  <done>
    GLB/glTF import pipeline loads files, extracts hierarchy/materials/textures, and creates ECSON entities via PatchOps. Environment settings panel controls ambient light, fog, sky color, and exposure with real-time viewport feedback. All edits flow through PatchOps.
  </done>
</task>

</tasks>

<verification>
- Asset browser categorizes starter assets correctly
- Drag-and-drop from browser/strip to viewport spawns entities
- GLB import loads file from disk, uploads to storage, renders in viewport
- Imported GLB preserves materials (colors, metalness, roughness)
- Environment settings (ambient, fog, sky, exposure) render correctly in viewport
- All asset additions and environment changes produce PatchOps
- Undo works for asset addition and environment changes
</verification>

<success_criteria>
- Asset library with curated starter assets and drag-to-spawn (EDIT-09)
- GLB/glTF import with textures, materials, and hierarchy (RNDR-04)
- Environment settings (skybox color, fog, ambient light) editable (RNDR-05)
- Compact asset strip below viewport for quick access
- All mutations through PatchOps
</success_criteria>

<output>
After completion, create `.planning/phases/02-closed-loop-editor/02-06-SUMMARY.md`
</output>
