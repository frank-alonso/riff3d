---
phase: 02-closed-loop-editor
plan: 05
type: execute
wave: 4
depends_on: ["02-02", "02-03"]
files_modified:
  - apps/editor/src/stores/slices/scene-slice.ts
  - apps/editor/src/stores/editor-store.ts
  - apps/editor/src/hooks/use-keyboard-shortcuts.ts
  - apps/editor/src/hooks/use-auto-save.ts
  - apps/editor/src/lib/clipboard.ts
  - apps/editor/src/components/editor/shell/top-bar.tsx
  - packages/patchops/__tests__/nightly-property.test.ts
  - packages/conformance/__tests__/lossiness-contract.test.ts
  - packages/patchops/__tests__/mutation-bypass.test.ts
autonomous: true
requirements:
  - EDIT-05
  - EDIT-06
  - EDIT-08

must_haves:
  truths:
    - "User can undo the last edit with Ctrl+Z and see the scene revert"
    - "User can redo a previously undone edit with Ctrl+Shift+Z"
    - "Undo/redo works for all edit types (transform, property change, reparent, add/remove entity)"
    - "User can copy selected entities with Ctrl+C and paste with Ctrl+V"
    - "User can duplicate selected entities with Ctrl+D"
    - "Scene auto-saves to Supabase after 5 seconds of inactivity"
    - "Manual save with Ctrl+S saves immediately"
    - "Top bar shows save status (Saved / Saving... / Unsaved changes)"
  artifacts:
    - path: "apps/editor/src/stores/slices/scene-slice.ts"
      provides: "Undo/redo stacks and dispatch logic"
      contains: "undoStack"
    - path: "apps/editor/src/lib/clipboard.ts"
      provides: "Copy/paste/duplicate logic with PatchOp generation"
      exports: ["copyEntities", "pasteEntities", "duplicateEntities"]
    - path: "apps/editor/src/hooks/use-auto-save.ts"
      provides: "Auto-save hook with debounce and save-on-significant-change"
      exports: ["useAutoSave"]
  key_links:
    - from: "apps/editor/src/stores/slices/scene-slice.ts"
      to: "@riff3d/patchops applyOp"
      via: "undo pops inverse from undoStack, applies it"
      pattern: "undoStack.*applyOp"
    - from: "apps/editor/src/hooks/use-auto-save.ts"
      to: "supabase.from('projects').update"
      via: "saves ECSON doc to Supabase projects table"
      pattern: "update.*ecson"
    - from: "apps/editor/src/lib/clipboard.ts"
      to: "editorStore dispatchOp"
      via: "paste generates CreateEntity + AddComponent PatchOps"
      pattern: "CreateEntity"
---

<objective>
Implement undo/redo (via invertible PatchOps), copy/paste/duplicate, save and auto-save, and resolve Phase 1 carry-forward testing items (CF-01, CF-02, CF-03). This plan makes editing non-destructive (undo everything) and persistent (auto-save).

Purpose: Undo/redo is essential for any editor. Auto-save prevents data loss. Copy/paste enables efficient workflow. The carry-forward testing items strengthen the contract guarantees from Phase 1.
Output: Working undo/redo stacks, copy/paste/duplicate, auto-save with save indicator, nightly property tests, lossiness contract tests, mutation-bypass test.
</objective>

<execution_context>
@/home/frank/.claude/get-shit-done/workflows/execute-plan.md
@/home/frank/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-closed-loop-editor/02-RESEARCH.md
@.planning/phases/02-closed-loop-editor/02-CONTEXT.md
@.planning/phases/02-closed-loop-editor/02-02-SUMMARY.md
@packages/patchops/src/engine.ts
@packages/ecson/src/helpers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Undo/redo stacks and copy/paste/duplicate</name>
  <files>
    apps/editor/src/stores/slices/scene-slice.ts
    apps/editor/src/stores/editor-store.ts
    apps/editor/src/lib/clipboard.ts
    apps/editor/src/hooks/use-keyboard-shortcuts.ts
  </files>
  <action>
    **Undo/Redo in scene-slice.ts:**
    - Add to scene slice state:
      ```typescript
      undoStack: PatchOp[];   // Stack of inverse ops
      redoStack: PatchOp[];   // Stack of re-do ops
      ```
    - Update `dispatchOp(op)`:
      1. Apply op via `applyOp(ecsonDoc, op)` -> returns `inverseOp`
      2. Push `inverseOp` to `undoStack`
      3. Clear `redoStack` (new op invalidates redo history)
      4. Recompile Canonical IR
      5. Increment a `docVersion` counter (used by auto-save to detect changes)
    - Add `undo()`:
      1. If `undoStack` is empty, return
      2. Pop last op from `undoStack`
      3. Apply it via `applyOp(ecsonDoc, inverseOp)` -> returns `reInverse`
      4. Push `reInverse` to `redoStack`
      5. Recompile IR
      6. Increment `docVersion`
    - Add `redo()`:
      1. If `redoStack` is empty, return
      2. Pop last op from `redoStack`
      3. Apply it via `applyOp(ecsonDoc, redoOp)` -> returns `inverse`
      4. Push `inverse` to `undoStack`
      5. Recompile IR
      6. Increment `docVersion`
    - Add `canUndo: boolean` and `canRedo: boolean` derived from stack lengths (for UI button states).

    **Copy/Paste/Duplicate** (`lib/clipboard.ts`):
    - `copyEntities(entityIds: string[], ecsonDoc: SceneDocument)`:
      1. For each entity ID, read entity data from ECSON doc
      2. Include all components and descendants (walk children recursively)
      3. Serialize to JSON and write to clipboard via `navigator.clipboard.writeText()`
      4. Return serialized data for internal paste buffer (fallback if clipboard API fails)
    - `pasteEntities(clipboardData: string, parentId: string)`:
      1. Parse clipboard JSON
      2. For each entity in clipboard data:
         - Generate new entity ID (via `generateEntityId()` from `@riff3d/ecson`)
         - Create `CreateEntity` PatchOp with new ID, same name + " (Copy)", parent = parentId
         - Create `AddComponent` PatchOps for each component
         - Map old entity ID references to new IDs for parent-child relationships within the pasted group
      3. Return array of PatchOps to dispatch as a `BatchOp`
    - `duplicateEntities(entityIds: string[], ecsonDoc: SceneDocument)`:
      1. Same as copy+paste but inline: read entities, generate new IDs, create PatchOps
      2. Position offset: shift duplicated entities slightly (+0.5 on X) so they're visually distinct
      3. Dispatch as BatchOp
      4. Select the new (duplicated) entities

    **Update keyboard shortcuts:**
    - `Ctrl+Z` -> `undo()`
    - `Ctrl+Shift+Z` or `Ctrl+Y` -> `redo()`
    - `Ctrl+C` -> `copyEntities(selectedEntityIds, ecsonDoc)`
    - `Ctrl+V` -> `pasteEntities(clipboardContent, rootEntityId or selectedParentId)`
    - `Ctrl+D` -> `duplicateEntities(selectedEntityIds, ecsonDoc)`
    - `Ctrl+A` -> select all entities (all keys in ecsonDoc.entities except root)
  </action>
  <verify>
    - `pnpm typecheck` passes
    - `pnpm lint` passes
    - Undo/redo state logic is correct (push/pop from stacks)
    - Copy produces JSON in clipboard
    - Paste generates CreateEntity + AddComponent PatchOps with new IDs
    - Duplicate generates new entities offset from originals
    - Keyboard shortcuts bound correctly
  </verify>
  <done>
    Undo/redo works via invertible PatchOp stacks. Copy/paste serializes entities to clipboard JSON and recreates them with new IDs via PatchOps. Duplicate creates offset copies. All keyboard shortcuts registered.
  </done>
</task>

<task type="auto">
  <name>Task 2: Auto-save, manual save, save status indicator, and carry-forward tests</name>
  <files>
    apps/editor/src/hooks/use-auto-save.ts
    apps/editor/src/components/editor/shell/top-bar.tsx
    packages/patchops/__tests__/nightly-property.test.ts
    packages/conformance/__tests__/lossiness-contract.test.ts
    packages/patchops/__tests__/mutation-bypass.test.ts
  </files>
  <action>
    **Auto-Save Hook** (`hooks/use-auto-save.ts`):
    - `useAutoSave(projectId: string)` hook:
      1. Subscribe to `editorStore` `docVersion` changes
      2. On change, start a 5-second idle debounce timer (reset on each new change)
      3. On timer expiry: call `saveProject()` which upserts ECSON doc to Supabase:
         ```typescript
         supabase.from('projects').update({
           ecson: ecsonDoc,
           entity_count: Object.keys(ecsonDoc.entities).length,
           updated_at: new Date().toISOString()
         }).eq('id', projectId)
         ```
      4. Set save status: 'saving' during save, 'saved' on success, 'error' on failure
      5. Structural changes (CreateEntity, DeleteEntity, Reparent, AddComponent, RemoveComponent) trigger immediate save (bypass debounce)
      6. Window blur event (`document.addEventListener('visibilitychange')`) triggers immediate save
    - Track `lastSavedVersion` to avoid unnecessary saves when nothing changed.
    - On save error: show toast via sonner with "Failed to save" and retry button.

    **Manual Save:**
    - `Ctrl+S` triggers immediate save (bypass debounce).
    - Prevent browser default save dialog: `e.preventDefault()` in keyboard shortcut handler.

    **Save Status in TopBar** (`shell/top-bar.tsx`):
    - Update the top bar to show save status: "Saved" (green check), "Saving..." (spinner), "Unsaved changes" (yellow dot), "Save failed" (red warning).
    - Use `useEditorStore(s => s.saveStatus)` to read status.
    - Add `saveStatus: 'saved' | 'saving' | 'unsaved' | 'error'` and `lastSavedAt: Date | null` to the store (in a new ui or save slice).

    **Thumbnail Capture on Save:**
    - After successful save, capture a viewport thumbnail:
      1. Access the PlayCanvas app via viewport adapter ref
      2. Call `app.renderNextFrame = true; app.autoRender = false;` -- render one frame
      3. Call `canvas.toDataURL('image/png')` immediately after render
      4. Restore `app.autoRender = true;`
      5. Upload thumbnail PNG blob to Supabase Storage bucket (`project-thumbnails/[projectId].png`)
      6. Update project row with `thumbnail_url`
    - If thumbnail capture fails, silently continue (non-critical feature).

    **Carry-Forward CF-01: Nightly property test suite:**
    - Create `packages/patchops/__tests__/nightly-property.test.ts` (or add to existing property tests):
      - Tests run with rotating seed: use `Date.now()` as seed instead of fixed seed=42
      - Run 1000 iterations (vs 100 in standard CI) -- these are slower, meant for nightly runs
      - On failure: log the seed that caused the failure for reproduction
      - Mark test file with a Vitest tag or env-guard so standard `pnpm test` skips it:
        ```typescript
        describe.skipIf(!process.env.NIGHTLY)('Nightly property tests', () => { ... });
        ```
      - Tests cover: apply-inverse identity, replay determinism, batch equivalence (same as CI property tests but with more iterations and random seeds)

    **Carry-Forward CF-02: Lossiness contract tests:**
    - Create `packages/conformance/__tests__/lossiness-contract.test.ts`:
      - Enumerate which fields ARE expected to be stripped during ECSON -> IR -> ECSON round-trip: tags, locked, metadata, component tuning sections
      - For each golden fixture, run round-trip and assert:
        1. All expected-stripped fields are indeed absent in the round-tripped output
        2. ALL other fields are preserved identically
      - This is a contract: if a new field is added to ECSON but not to the portable subset, it MUST be explicitly listed as "expected stripped" -- otherwise the test fails, forcing the developer to make a conscious decision.

    **Carry-Forward CF-03: Mutation bypass enforcement test:**
    - Create `packages/patchops/__tests__/mutation-bypass.test.ts`:
      - A negative test that verifies ECSON documents cannot be mutated outside of PatchOps
      - Approach: Use a deep-freeze utility to freeze the document before operation
      - Test: Frozen ECSON doc + direct property mutation -> throws TypeError
      - Test: Frozen ECSON doc + applyOp -> succeeds (applyOp creates new objects, doesn't mutate in place)
      - This validates the architectural rule that PatchOps don't mutate in place
      - Add a comment noting that runtime enforcement (lint rule or proxy) can be added later

    Add `Ctrl+S` to the keyboard shortcuts hook from 02-03.
  </action>
  <verify>
    - `pnpm typecheck` passes
    - `pnpm test --filter @riff3d/patchops` passes (including mutation-bypass test)
    - `pnpm test --filter @riff3d/conformance` passes (including lossiness test)
    - Auto-save hook compiles and exports correctly
    - TopBar shows save status indicator
    - `NIGHTLY=true pnpm test --filter @riff3d/patchops` runs the nightly property tests
  </verify>
  <done>
    Auto-save persists ECSON to Supabase with 5-second debounce and immediate save on structural changes. Manual save via Ctrl+S. Save status shows in top bar. Thumbnail capture on save. CF-01 nightly property tests with rotating seeds and 1000 iterations. CF-02 lossiness contract tests. CF-03 mutation-bypass enforcement test. All carry-forwards addressed.
  </done>
</task>

</tasks>

<verification>
- Ctrl+Z undoes last edit, Ctrl+Shift+Z redoes
- Undo/redo works for transform, property, reparent, create, delete operations
- Ctrl+C copies, Ctrl+V pastes (new entities with new IDs)
- Ctrl+D duplicates (offset copies)
- Auto-save triggers after 5s inactivity
- Structural changes trigger immediate save
- Ctrl+S manual save works
- Top bar shows accurate save status
- Nightly property tests run with random seeds (CF-01)
- Lossiness contract tests verify field preservation (CF-02)
- Mutation-bypass test validates PatchOps don't mutate in place (CF-03)
</verification>

<success_criteria>
- Undo/redo via invertible PatchOps with proper stacks (EDIT-05)
- Copy/paste/duplicate within same scene (EDIT-06)
- Save and auto-save with ECSON to Supabase persistence (EDIT-08)
- CF-01, CF-02, CF-03 carry-forward items resolved
</success_criteria>

<output>
After completion, create `.planning/phases/02-closed-loop-editor/02-05-SUMMARY.md`
</output>
