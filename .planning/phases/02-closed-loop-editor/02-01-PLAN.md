---
phase: 02-closed-loop-editor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/editor/package.json
  - apps/editor/src/app/layout.tsx
  - apps/editor/src/app/globals.css
  - apps/editor/src/app/page.tsx
  - apps/editor/src/app/(auth)/login/page.tsx
  - apps/editor/src/app/(auth)/auth/callback/route.ts
  - apps/editor/src/app/(dashboard)/page.tsx
  - apps/editor/src/app/(dashboard)/layout.tsx
  - apps/editor/src/app/editor/[projectId]/page.tsx
  - apps/editor/src/app/editor/[projectId]/layout.tsx
  - apps/editor/src/lib/supabase/client.ts
  - apps/editor/src/lib/supabase/server.ts
  - apps/editor/src/lib/supabase/middleware.ts
  - apps/editor/src/middleware.ts
  - apps/editor/src/components/ui/button.tsx
  - apps/editor/src/components/ui/modal.tsx
  - apps/editor/src/components/ui/input.tsx
  - apps/editor/src/components/dashboard/project-card.tsx
  - apps/editor/src/components/dashboard/project-grid.tsx
  - apps/editor/src/components/dashboard/new-project-modal.tsx
  - apps/editor/src/components/dashboard/empty-state.tsx
  - apps/editor/src/components/editor/shell/editor-shell.tsx
  - apps/editor/src/components/editor/shell/activity-bar.tsx
  - apps/editor/src/components/editor/shell/top-bar.tsx
  - apps/editor/src/stores/editor-store.ts
  - apps/editor/src/stores/slices/ui-slice.ts
  - apps/editor/src/stores/hooks.ts
  - apps/editor/.env.local.example
  - packages/patchops/src/engine.ts
autonomous: false
requirements:
  - PROJ-01
  - PROJ-02
  - PROJ-03

user_setup:
  - service: supabase
    why: "Auth and database for user accounts and project storage"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY
        source: "Supabase Dashboard -> Settings -> API -> anon/public key"
    dashboard_config:
      - task: "Create Supabase project"
        location: "https://supabase.com/dashboard -> New Project"
      - task: "Enable auth providers (Google, Discord, GitHub)"
        location: "Supabase Dashboard -> Authentication -> Providers"
      - task: "Create projects table with RLS policies"
        location: "Supabase Dashboard -> SQL Editor (migration SQL will be provided)"

must_haves:
  truths:
    - "User can log in via Google, Discord, or GitHub social auth"
    - "User sees a project dashboard with card grid layout after login"
    - "User can create a new project via modal and see it appear in the dashboard"
    - "Clicking a project card navigates to the editor shell at /editor/[projectId]"
    - "Editor shell shows VS Code-style layout: activity bar, left sidebar, center viewport placeholder, right sidebar"
    - "Unauthenticated users are redirected to login page"
    - "Dark theme is applied as default"
    - "User can toggle a project to public and copy a shareable link that opens it for anyone with the URL"
  artifacts:
    - path: "apps/editor/src/lib/supabase/client.ts"
      provides: "Browser Supabase client"
      exports: ["createClient"]
    - path: "apps/editor/src/lib/supabase/server.ts"
      provides: "Server Supabase client"
      exports: ["createClient"]
    - path: "apps/editor/src/middleware.ts"
      provides: "Auth session refresh middleware"
      contains: "getUser"
    - path: "apps/editor/src/stores/editor-store.ts"
      provides: "Vanilla Zustand store with subscribeWithSelector"
      exports: ["editorStore"]
    - path: "apps/editor/src/components/editor/shell/editor-shell.tsx"
      provides: "VS Code-style editor layout"
      contains: "react-resizable-panels"
  key_links:
    - from: "apps/editor/src/middleware.ts"
      to: "apps/editor/src/lib/supabase/middleware.ts"
      via: "session refresh on every request"
      pattern: "updateSession"
    - from: "apps/editor/src/app/(auth)/login/page.tsx"
      to: "supabase.auth.signInWithOAuth"
      via: "social login buttons"
      pattern: "signInWithOAuth"
    - from: "apps/editor/src/app/(dashboard)/page.tsx"
      to: "supabase projects table"
      via: "server component data fetch"
      pattern: "from.*projects"
    - from: "apps/editor/src/app/editor/[projectId]/layout.tsx"
      to: "apps/editor/src/lib/supabase/middleware.ts"
      via: "public project access check: middleware lets /editor/* through, layout checks is_public"
      pattern: "is_public"
---

<objective>
Set up the Next.js editor application with Supabase auth (social logins), project management (CRUD + dashboard), and the editor shell layout. This establishes the foundation that all subsequent plans build on: routing, auth, database, state management, and the VS Code-style panel layout.

Purpose: Without auth, projects, and the editor shell, no other editor feature can function. This is the skeleton everything attaches to.
Output: Working auth flow, project dashboard with cards, editor shell with resizable panels, Zustand vanilla store, dark theme, Supabase integration.
</objective>

<execution_context>
@/home/frank/.claude/get-shit-done/workflows/execute-plan.md
@/home/frank/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-closed-loop-editor/02-RESEARCH.md
@.planning/phases/02-closed-loop-editor/02-CONTEXT.md
@.planning/phases/01-contracts-testing-spine/01-01-SUMMARY.md
</context>

<executor_notes>
**Context budget warning:** This plan touches ~29 files across 2 auto tasks + 1 checkpoint. Task 1 is large (~20 files) but all files are in the same auth/dashboard domain. To manage context:
- Task 1: Focus on auth/Supabase setup first, then dashboard components, then PROJ-03 shareable link pieces. Read only the files you need for each chunk.
- Task 2: Treat as a clean separate concern (editor shell + Zustand). Read 02-01 Task 1 outputs only if needed for type references.
- If context runs tight in Task 1, prioritize: auth flow > middleware > dashboard page > project card > new project modal > PROJ-03 UI. The shared UI components (button, modal, input) are simple Tailwind components and can be lightweight.
</executor_notes>

<tasks>

<task type="auto">
  <name>Task 1: Supabase auth, middleware, project database, and dashboard</name>
  <files>
    apps/editor/package.json
    apps/editor/src/lib/supabase/client.ts
    apps/editor/src/lib/supabase/server.ts
    apps/editor/src/lib/supabase/middleware.ts
    apps/editor/src/middleware.ts
    apps/editor/src/app/layout.tsx
    apps/editor/src/app/globals.css
    apps/editor/src/app/page.tsx
    apps/editor/src/app/(auth)/login/page.tsx
    apps/editor/src/app/(auth)/auth/callback/route.ts
    apps/editor/src/app/(dashboard)/page.tsx
    apps/editor/src/app/(dashboard)/layout.tsx
    apps/editor/src/components/ui/button.tsx
    apps/editor/src/components/ui/modal.tsx
    apps/editor/src/components/ui/input.tsx
    apps/editor/src/components/dashboard/project-card.tsx
    apps/editor/src/components/dashboard/project-grid.tsx
    apps/editor/src/components/dashboard/new-project-modal.tsx
    apps/editor/src/components/dashboard/empty-state.tsx
    apps/editor/.env.local.example
    packages/patchops/src/engine.ts
  </files>
  <action>
    **Install dependencies** in apps/editor:
    ```
    pnpm add @supabase/supabase-js @supabase/ssr react-resizable-panels react-arborist react-hotkeys-hook lucide-react sonner zustand
    ```

    **Supabase client setup** (follow @supabase/ssr patterns for Next.js 16 App Router):
    - `lib/supabase/client.ts`: `createBrowserClient()` with env vars `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY`
    - `lib/supabase/server.ts`: `createServerClient()` using `cookies()` from `next/headers` with `getAll()`/`setAll()` batch cookie methods
    - `lib/supabase/middleware.ts`: `updateSession()` function that creates a server client in middleware context and calls `supabase.auth.getUser()` (NOT `getSession()`) to validate JWT. Redirect unauthenticated users to `/login` for protected routes (`/dashboard`). Allow `/login` and `/auth/callback` through. **PROJ-03 exception:** For `/editor/[projectId]` routes, do NOT redirect unauthenticated users immediately. Instead, allow the request through -- the editor page layout server component will check if the project exists and is public. If the project is public, allow read-only access. If the project is private and the user is unauthenticated, THEN redirect to `/login` with a `?redirect=/editor/[projectId]` query param so they return after login.
    - `middleware.ts`: Re-export `updateSession` as Next.js middleware with config matcher excluding static assets and API routes.
    - `.env.local.example`: Template with `NEXT_PUBLIC_SUPABASE_URL=` and `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=` placeholders.

    **CRITICAL:** Use `getUser()` not `getSession()` for server-side auth checks per Supabase docs.

    **Auth pages:**
    - `(auth)/login/page.tsx`: Client component with three social login buttons (Google, Discord, GitHub) using `supabase.auth.signInWithOAuth({ provider, options: { redirectTo: origin + '/auth/callback' } })`. Dark theme, centered card layout. Include Riff3D logo/title.
    - `(auth)/auth/callback/route.ts`: Route handler that exchanges code for session via `exchangeCodeForSession()` and redirects to `/`.

    **Root layout update:**
    - Update `app/layout.tsx` with dark theme as default: set `<html lang="en" className="dark">`, import Sonner `<Toaster>`, add CSS custom properties for theming (design for future light theme support). Use Tailwind dark mode with CSS custom properties (--background, --foreground, --card, --border, etc.) in globals.css. Keep Geist Sans and Geist Mono fonts.
    - `globals.css`: Add Tailwind v4 theme tokens using `@theme` directive. Define dark palette: backgrounds (neutral-900/950), foreground (neutral-50/100), borders (neutral-700/800), cards (neutral-800/850), accent (blue-500/600). Use `@layer base` to set body styling.
    - Root `page.tsx`: Redirect authenticated users to `/dashboard`, unauthenticated to `/login`.

    **Dashboard:**
    - `(dashboard)/layout.tsx`: Server component that fetches user via Supabase server client, renders nav bar with user avatar and sign-out button.
    - `(dashboard)/page.tsx`: Server component that fetches projects from Supabase `projects` table ordered by `updated_at DESC`. Passes to `ProjectGrid` or `EmptyState` based on count.
    - `ProjectGrid`: Renders card grid (responsive: 1 col mobile, 2 col md, 3 col lg). Each card shows thumbnail, project name, relative time (e.g. "2 hours ago"), entity count.
    - `ProjectCard`: Card component with thumbnail image, project name, metadata row. On click, navigates to `/editor/[projectId]`. Hover state with subtle scale/shadow.
    - `NewProjectModal`: Modal with project name input field and "Blank Scene" button (active) + "Templates" section (placeholder/locked slots for Phase 8). On create: insert project row in Supabase with default ECSON (use `createEmptyDocument()` from @riff3d/ecson), navigate to `/editor/[projectId]`. Per user decision: modal opens from "New Project" button.
    - `EmptyState`: Hero CTA for new users. Welcoming illustration/graphic area (use a placeholder SVG or Lucide icon composition) with prominent "Create your first project" button that opens NewProjectModal. Per user decision.

    **Supabase migration SQL** (provide as comment in code or separate .sql file for user to run):
    ```sql
    CREATE TABLE projects (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      owner_id UUID REFERENCES auth.users(id) NOT NULL,
      name TEXT NOT NULL,
      ecson JSONB NOT NULL DEFAULT '{}',
      thumbnail_url TEXT,
      entity_count INT DEFAULT 0,
      is_public BOOLEAN DEFAULT false,
      created_at TIMESTAMPTZ DEFAULT now(),
      updated_at TIMESTAMPTZ DEFAULT now()
    );

    ALTER TABLE projects ENABLE ROW LEVEL SECURITY;

    CREATE POLICY "Users can read own projects" ON projects FOR SELECT USING (auth.uid() = owner_id);
    CREATE POLICY "Users can insert own projects" ON projects FOR INSERT WITH CHECK (auth.uid() = owner_id);
    CREATE POLICY "Users can update own projects" ON projects FOR UPDATE USING (auth.uid() = owner_id);
    CREATE POLICY "Users can delete own projects" ON projects FOR DELETE USING (auth.uid() = owner_id);
    CREATE POLICY "Public projects are readable by anyone" ON projects FOR SELECT USING (is_public = true);
    ```

    **Shared UI components:**
    - `ui/button.tsx`: Button with variant support (primary, secondary, ghost, danger). Tailwind classes, dark theme colors. Accepts `asChild` prop pattern.
    - `ui/modal.tsx`: Modal overlay component with backdrop, centered content, close button. Uses React portal.
    - `ui/input.tsx`: Input with label, error state, dark theme styling.

    **Carry-forward CF-05:** Fix unused eslint-disable directive at `packages/patchops/src/engine.ts:518`. Read the file, find the unused directive, and remove it.

    **Shareable project links (PROJ-03):**
    - The URL pattern `/editor/[projectId]` IS the shareable link.
    - **Middleware exception:** As described above, `/editor/*` routes allow unauthenticated requests through to the page, which checks project visibility.
    - **Editor layout server component** (`editor/[projectId]/layout.tsx`): Fetch project. If not found -> 404. If `is_public === false` and user is not authenticated -> redirect to `/login?redirect=/editor/[projectId]`. If `is_public === false` and user is authenticated but not the owner -> 403 "Access denied" page. If `is_public === true` or user is the owner -> render editor (owner gets full edit mode, non-owner gets read-only view with editing controls hidden).
    - **"Make Public" toggle:** Add a toggle switch in the `ProjectCard` kebab/more menu (three dots) on the dashboard. Toggling it calls `supabase.from('projects').update({ is_public: !current }).eq('id', projectId)` and shows a toast confirming the change. Also accessible from the editor's top-bar project settings dropdown.
    - **"Copy Link" button:** When a project is public, show a "Copy Link" button next to the Make Public toggle (and in the top-bar project settings). Clicking it copies `window.location.origin + '/editor/' + projectId` to the clipboard and shows a "Link copied!" toast via sonner.
    - **Read-only indicator:** When a non-owner views a public project, show a "View Only" badge in the top bar and disable all editing controls (gizmos, inspector edits, hierarchy mutations, save). The viewport and hierarchy tree are still navigable for viewing.
    - The RLS policy `"Public projects are readable by anyone"` (already in the migration SQL above) handles the database access for unauthenticated/non-owner reads.
  </action>
  <verify>
    - `pnpm typecheck --filter @riff3d/editor` passes
    - `pnpm lint --filter @riff3d/editor` passes
    - `.env.local.example` exists with correct variables
    - Supabase migration SQL is documented
    - All route files exist: login, callback, dashboard, editor/[projectId]
    - The eslint-disable directive at patchops/src/engine.ts:518 is removed (CF-05)
    - Make Public toggle exists on project card and in editor top-bar settings
    - Copy Link button copies shareable URL to clipboard for public projects
    - Unauthenticated user can access a public project at /editor/[projectId] in read-only mode
    - Unauthenticated user accessing a private project is redirected to /login with redirect param
  </verify>
  <done>
    Auth flow compiles (social login -> callback -> session). Dashboard renders project cards from Supabase data. New project modal creates a project with empty ECSON. Editor route exists at /editor/[projectId]. Shareable links work: public projects accessible to anyone via URL, non-owners see read-only view, Make Public toggle and Copy Link button provided. Dark theme applied globally. CF-05 resolved.
  </done>
</task>

<task type="auto">
  <name>Task 2: Editor shell layout with resizable panels and Zustand store</name>
  <files>
    apps/editor/src/app/editor/[projectId]/page.tsx
    apps/editor/src/app/editor/[projectId]/layout.tsx
    apps/editor/src/components/editor/shell/editor-shell.tsx
    apps/editor/src/components/editor/shell/activity-bar.tsx
    apps/editor/src/components/editor/shell/top-bar.tsx
    apps/editor/src/stores/editor-store.ts
    apps/editor/src/stores/slices/ui-slice.ts
    apps/editor/src/stores/hooks.ts
  </files>
  <action>
    **Zustand vanilla store setup:**
    - `stores/editor-store.ts`: Create store using `createStore` from `zustand/vanilla` with `subscribeWithSelector` middleware. This is the single store for the entire editor, composed from slices. For now, include the UI slice. Other slices (scene, viewport, playtest) are added in subsequent plans when their features are built.

    Interface (initial -- expanded by later plans):
    ```typescript
    interface EditorState {
      // UI state (from ui-slice)
      activePanel: 'hierarchy' | 'assets' | null;
      inspectorVisible: boolean;
      activeSidebarTab: string;

      // Placeholder for scene state (02-02 adds)
      // Placeholder for viewport state (02-02 adds)

      // UI actions
      setActivePanel: (panel: 'hierarchy' | 'assets' | null) => void;
      toggleInspector: () => void;
    }
    ```

    - `stores/slices/ui-slice.ts`: UI slice with panel visibility state, active sidebar tab, inspector toggle. Defaults: `activePanel: 'hierarchy'`, `inspectorVisible: true`.
    - `stores/hooks.ts`: `useEditorStore<T>(selector)` React hook wrapping `useStore(editorStore, selector)`. Export typed selectors for common patterns.

    **Editor shell layout** (per user decisions -- VS Code-style, fixed positions):
    - `editor/[projectId]/layout.tsx`: Server component that fetches project data from Supabase. If project not found, redirect to dashboard. Pass project data to client-side editor shell.
    - `editor/[projectId]/page.tsx`: Client component wrapper. Uses `dynamic(() => import('...EditorShell'), { ssr: false })` to prevent SSR of PlayCanvas components. Shows loading skeleton during load (dark panels with `animate-pulse` placeholders).

    **EditorShell** (client component):
    Uses `react-resizable-panels` with `PanelGroup`, `Panel`, `PanelResizeHandle`.
    Layout structure:
    ```
    [ActivityBar 48px] | [LeftPanel 280px min:200 max:400] | [CenterArea flex:1] | [RightPanel 320px min:250 max:450]
    ```
    - ActivityBar is fixed-width on the far left (not part of PanelGroup).
    - CenterArea will hold viewport (placeholder for now -- "Viewport will render here") and a compact bottom strip area for asset drag-and-drop (placeholder).
    - TopBar spans full width above everything.
    - Panel sizes persist to localStorage via react-resizable-panels `autoSaveId`.

    **ActivityBar:**
    - Vertical strip with icon buttons: Hierarchy (ListTree), Assets (Package), Settings (Settings2).
    - Clicking an icon toggles the corresponding left sidebar content. Active icon has accent highlight.
    - Icons from `lucide-react`.
    - Dark background (darker than panels, e.g., neutral-950).

    **TopBar:**
    - Minimal horizontal bar. Left: project name (editable inline text). Center: Play/Pause/Stop buttons (placeholder, non-functional until 02-07). Right: save status indicator ("Saved" / "Saving..." -- placeholder), user avatar with dropdown.
    - Per user decision: Play/Pause/Stop controls centered in the top bar, always visible.

    **Panel resize handles:** 4px wide, cursor `col-resize`, subtle border color. React-resizable-panels handles all edge cases natively.

    **Viewport placeholder in center:** Dark rectangle with text "3D Viewport" and a subtle PlayCanvas icon or grid pattern. This gets replaced by the real canvas in 02-02.
  </action>
  <verify>
    - `pnpm typecheck --filter @riff3d/editor` passes
    - `pnpm lint --filter @riff3d/editor` passes
    - EditorShell renders with activity bar, resizable panels, top bar
    - Zustand store exports `editorStore` and `useEditorStore` hook
    - Panel resize works (drag handles)
    - Activity bar toggles left panel content
  </verify>
  <done>
    Editor shell at /editor/[projectId] shows VS Code-style layout with activity bar, resizable left/right panels, center viewport placeholder, and top bar with play controls placeholder. Zustand vanilla store is initialized with UI slice. Panels resize and persist sizes. Dark theme throughout.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify auth flow and editor shell</name>
  <files>apps/editor/src/app/(auth)/login/page.tsx</files>
  <action>
    Human verification of the complete auth flow and editor shell layout. Claude has automated all code -- this checkpoint verifies it works end-to-end in the browser.

    What was built: Complete auth flow (login -> social auth -> dashboard -> editor shell) and VS Code-style editor layout with resizable panels, activity bar, and dark theme.

    Steps to verify:
    1. Copy `.env.local.example` to `.env.local` and fill in Supabase credentials
    2. Run the Supabase migration SQL in your Supabase SQL Editor
    3. Configure at least one auth provider (GitHub is easiest) in Supabase Dashboard -> Authentication -> Providers
    4. Run `pnpm dev --filter @riff3d/editor`
    5. Visit http://localhost:3000 -- should redirect to /login
    6. Click a social login button -- should redirect to provider, then back to /auth/callback, then to /dashboard
    7. Dashboard should show empty state hero CTA (since no projects yet)
    8. Click "Create your first project" -> modal opens with name field and "Blank Scene" button
    9. Create a project -> card should appear in dashboard grid
    10. Click the project card -> navigates to /editor/[projectId]
    11. Editor shell should show: activity bar (left icons), left panel, center viewport placeholder, right inspector panel
    12. Try resizing panels by dragging handles
    13. Click activity bar icons to toggle left panel content
    14. Verify dark theme is consistent throughout
    15. On the dashboard, click the project card "..." menu -> toggle "Make Public"
    16. Click "Copy Link" -> URL should be in clipboard
    17. Open an incognito/private browser window and paste the link -> should see the project in read-only mode (no editing controls)
    18. In incognito, try visiting a private project link -> should redirect to /login
  </action>
  <verify>User confirms all 18 verification steps pass by typing "approved"</verify>
  <done>Auth flow, dashboard, and editor shell verified working in the browser by the user.</done>
</task>

</tasks>

<verification>
- Auth flow: login -> OAuth callback -> session -> dashboard redirect works end-to-end
- Project CRUD: create, read (list), navigate to editor
- Editor shell: VS Code layout with activity bar, resizable panels, top bar
- Zustand store: vanilla store created, React hook works, UI slice functional
- Dark theme: consistent across all pages
- RLS: users can only see their own projects (test by checking Supabase policies)
- CF-05: unused eslint-disable directive removed from patchops/src/engine.ts
</verification>

<success_criteria>
- Authenticated user can create a project from the dashboard and navigate to the editor shell
- Editor shell shows the VS Code-style layout with activity bar, resizable left/right panels, center viewport area, and top bar
- Unauthenticated access redirects to login
- Dark theme applied with CSS custom properties (future-theming ready)
- Zustand vanilla store initialized and accessible from both React hooks and imperative access
- PROJ-01 (user accounts), PROJ-02 (project CRUD), PROJ-03 (shareable links with public toggle, copy link, and read-only access) requirements addressed
</success_criteria>

<output>
After completion, create `.planning/phases/02-closed-loop-editor/02-01-SUMMARY.md`
</output>
