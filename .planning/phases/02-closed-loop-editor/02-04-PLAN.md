---
phase: 02-closed-loop-editor
plan: 04
type: execute
wave: 4
depends_on: ["02-02", "02-03"]
files_modified:
  - apps/editor/src/components/editor/hierarchy/scene-tree.tsx
  - apps/editor/src/components/editor/hierarchy/tree-node.tsx
  - apps/editor/src/components/editor/hierarchy/tree-context-menu.tsx
  - apps/editor/src/components/editor/inspector/inspector-panel.tsx
  - apps/editor/src/components/editor/inspector/entity-header.tsx
  - apps/editor/src/components/editor/inspector/component-inspector.tsx
  - apps/editor/src/components/editor/inspector/property-widget.tsx
  - apps/editor/src/components/editor/inspector/widgets/slider-field.tsx
  - apps/editor/src/components/editor/inspector/widgets/color-picker.tsx
  - apps/editor/src/components/editor/inspector/widgets/vec3-input.tsx
  - apps/editor/src/components/editor/inspector/widgets/checkbox-field.tsx
  - apps/editor/src/components/editor/inspector/widgets/dropdown-field.tsx
  - apps/editor/src/components/editor/inspector/widgets/number-field.tsx
  - apps/editor/src/components/editor/inspector/widgets/textbox-field.tsx
  - apps/editor/src/components/editor/shell/editor-shell.tsx
autonomous: true
requirements:
  - EDIT-03
  - EDIT-04

must_haves:
  truths:
    - "Scene hierarchy tree view shows all entities in the scene as a tree"
    - "User can click an entity in the tree to select it (syncs with viewport selection)"
    - "User can drag an entity in the tree to reparent it (produces Reparent PatchOp)"
    - "User can multi-select entities in the tree"
    - "User can search/filter entities in the tree by name"
    - "Inspector panel shows all components of the selected entity"
    - "Inspector auto-generates form widgets from component registry editorHints"
    - "Editing a property in the inspector creates a SetComponentProperty PatchOp"
  artifacts:
    - path: "apps/editor/src/components/editor/hierarchy/scene-tree.tsx"
      provides: "Scene hierarchy tree using react-arborist"
      contains: "react-arborist"
    - path: "apps/editor/src/components/editor/inspector/inspector-panel.tsx"
      provides: "Inspector panel for selected entity"
      contains: "ComponentInspector"
    - path: "apps/editor/src/components/editor/inspector/property-widget.tsx"
      provides: "Widget dispatcher based on editorHint type"
      contains: "switch.*editorHint"
  key_links:
    - from: "apps/editor/src/components/editor/hierarchy/scene-tree.tsx"
      to: "editorStore setSelection"
      via: "tree node click updates store selection"
      pattern: "setSelection"
    - from: "apps/editor/src/components/editor/hierarchy/scene-tree.tsx"
      to: "editorStore dispatchOp Reparent"
      via: "drag-to-reparent creates Reparent PatchOp"
      pattern: "Reparent"
    - from: "apps/editor/src/components/editor/inspector/component-inspector.tsx"
      to: "editorStore dispatchOp SetComponentProperty"
      via: "property change creates SetComponentProperty PatchOp"
      pattern: "SetComponentProperty"
    - from: "apps/editor/src/components/editor/inspector/component-inspector.tsx"
      to: "@riff3d/ecson getComponentDef"
      via: "reads component definition for editorHints"
      pattern: "getComponentDef"
---

<objective>
Build the scene hierarchy tree (left panel) and properties inspector (right panel). The hierarchy shows all entities as a tree with drag-to-reparent, multi-select, and search. The inspector auto-generates form widgets from the component registry's editorHints. Both produce PatchOps for all mutations.

Purpose: The hierarchy and inspector are how users navigate and edit scene content. Together with gizmos (02-03), they provide full editing capability. The inspector auto-generation from editorHints is a key architectural proof -- new components automatically get editor UI.
Output: Working hierarchy tree with reparent, inspector with auto-generated widgets, all edits flow through PatchOps.
</objective>

<execution_context>
@/home/frank/.claude/get-shit-done/workflows/execute-plan.md
@/home/frank/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-closed-loop-editor/02-RESEARCH.md
@.planning/phases/02-closed-loop-editor/02-CONTEXT.md
@.planning/phases/02-closed-loop-editor/02-02-SUMMARY.md
@.planning/phases/02-closed-loop-editor/02-03-SUMMARY.md
@packages/ecson/src/registry/types.ts
@packages/ecson/src/schemas/entity.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scene hierarchy tree with drag-to-reparent and search</name>
  <files>
    apps/editor/src/components/editor/hierarchy/scene-tree.tsx
    apps/editor/src/components/editor/hierarchy/tree-node.tsx
    apps/editor/src/components/editor/hierarchy/tree-context-menu.tsx
    apps/editor/src/components/editor/shell/editor-shell.tsx
  </files>
  <action>
    **Scene Tree** (`hierarchy/scene-tree.tsx`):
    - Use `react-arborist` `Tree` component for the hierarchy tree view.
    - Data source: Derive tree data from `ecsonDoc.entities` in the store. Convert flat entity map to tree structure:
      - Root entity is the tree root
      - Each entity has `id`, `name`, `children` (entity IDs whose `parentId` matches)
      - Memoize the tree data derivation to avoid recomputing on every render (use `useMemo` with `ecsonDoc` as dependency)
    - **Selection sync:** When user clicks a tree node, call `setSelection([nodeId])`. Use `useEditorStore(s => s.selectedEntityIds)` to highlight selected nodes. Selection is bidirectional -- selecting in viewport highlights in tree, selecting in tree highlights in viewport.
    - **Multi-select:** react-arborist supports multi-select. Map to `setSelection(selectedIds)`.
    - **Search/filter:** Use react-arborist's built-in search. Add a search input above the tree. Filter matches by entity name. Per user decision.
    - **Drag-to-reparent:** Use react-arborist's built-in drag-drop. On drop:
      1. Determine the new parent entity ID and the position (index) in the children array
      2. Create a `Reparent` PatchOp: `{ type: 'Reparent', entityId, newParentId, oldParentId, position }`
      3. Dispatch via `dispatchOp(op)`
      4. The store applies the op to ECSON, recompiles IR, adapter rebuilds the subtree
    - **Rename:** Double-click a node name to rename inline. On confirm, dispatch a `SetProperty` PatchOp to update the entity name.

    **Tree Node** (`hierarchy/tree-node.tsx`):
    - Custom node renderer for react-arborist.
    - Shows: expand/collapse arrow (if has children), entity icon (based on primary component type -- Cube for MeshRenderer, Sun for Light, Camera for Camera, Box for generic), entity name.
    - Selected state: accent background highlight.
    - Hover state: subtle background change.
    - Dragging state: opacity reduction.

    **Context Menu** (`hierarchy/tree-context-menu.tsx`):
    - Right-click on tree node shows context menu with:
      - Add Entity (submenu: Empty, Cube, Sphere, Plane, Point Light, Spot Light, Camera)
      - Rename
      - Duplicate (placeholder -- implemented in 02-05)
      - Delete (dispatches DeleteEntity PatchOp)
    - Right-click on empty area: Add Entity at root level.
    - Each "Add Entity" option dispatches: CreateEntity + AddComponent PatchOps (batched).

    **Update EditorShell:** Mount SceneTree in the left sidebar panel when `activePanel === 'hierarchy'`.
  </action>
  <verify>
    - `pnpm typecheck --filter @riff3d/editor` passes
    - `pnpm lint --filter @riff3d/editor` passes
    - Tree renders all entities from the ECSON document
    - Clicking a tree node selects it in both tree and viewport
    - Dragging a node to a new parent dispatches Reparent PatchOp
    - Search input filters entities by name
    - Context menu allows adding/deleting entities
  </verify>
  <done>
    Scene hierarchy tree renders entities, supports click-to-select (synced with viewport), drag-to-reparent via PatchOps, multi-select, search/filter, context menu with add/delete/rename. All mutations flow through PatchOps.
  </done>
</task>

<task type="auto">
  <name>Task 2: Inspector panel with auto-generated property widgets</name>
  <files>
    apps/editor/src/components/editor/inspector/inspector-panel.tsx
    apps/editor/src/components/editor/inspector/entity-header.tsx
    apps/editor/src/components/editor/inspector/component-inspector.tsx
    apps/editor/src/components/editor/inspector/property-widget.tsx
    apps/editor/src/components/editor/inspector/widgets/slider-field.tsx
    apps/editor/src/components/editor/inspector/widgets/color-picker.tsx
    apps/editor/src/components/editor/inspector/widgets/vec3-input.tsx
    apps/editor/src/components/editor/inspector/widgets/checkbox-field.tsx
    apps/editor/src/components/editor/inspector/widgets/dropdown-field.tsx
    apps/editor/src/components/editor/inspector/widgets/number-field.tsx
    apps/editor/src/components/editor/inspector/widgets/textbox-field.tsx
    apps/editor/src/components/editor/shell/editor-shell.tsx
  </files>
  <action>
    **Inspector Panel** (`inspector/inspector-panel.tsx`):
    - Reads `selectedEntityIds` from store. If none selected, show "No entity selected" placeholder. If multiple selected, show "N entities selected" with shared properties view (or just the first entity for Phase 2 simplicity).
    - If one entity selected, renders:
      1. EntityHeader (name, tags, transform)
      2. For each component on the entity: ComponentInspector section

    **Entity Header** (`inspector/entity-header.tsx`):
    - Shows entity name (editable inline -- dispatches SetProperty PatchOp on change)
    - Transform section always visible: Position (Vec3), Rotation (Euler angles displayed, stored as quaternion), Scale (Vec3)
    - Transform inputs dispatch SetProperty PatchOps. Use debounced dispatch (300ms) for keyboard input to avoid flooding ops. On blur, force dispatch.
    - "Add Component" button at the bottom that opens a dropdown/popover listing available components from `listComponents()` grouped by category. Selecting a component dispatches `AddComponent` PatchOp.

    **Component Inspector** (`inspector/component-inspector.tsx`):
    - For a given entity component:
      1. Look up `ComponentDefinition` via `getComponentDef(component.type)` from `@riff3d/ecson`
      2. If no definition found, show raw JSON viewer (fallback)
      3. If definition found, render a collapsible section with:
         - Component name header with remove button (dispatches RemoveComponent PatchOp)
         - For each property in `editorHints`: render a `PropertyWidget`
    - Read current values from the entity's component data in the ECSON doc.

    **Property Widget** (`inspector/property-widget.tsx`):
    - Dispatcher component that maps `EditorHint.editorHint` type to the correct widget:
      - `'slider'` -> SliderField (range input with min/max/step, displays value)
      - `'color'` -> ColorPicker (native color input or custom hex input)
      - `'number'` -> NumberField (number input with optional min/max)
      - `'checkbox'` -> CheckboxField (toggle switch)
      - `'textbox'` -> TextboxField (text input)
      - `'dropdown'` -> DropdownField (select element)
      - `'vec3'` -> Vec3Input (three number inputs: x, y, z)
      - `'asset-ref'` -> Placeholder text input showing asset ID (full picker in 02-06)
      - `'entity-ref'` -> Placeholder text input showing entity ID
      - `'entity-ref-list'` -> Placeholder showing entity ID list
      - `'array'` -> Simple list view
      - `'tags'` -> Tag input (comma-separated for now)
    - Each widget calls `onChange(newValue)` which the ComponentInspector wraps to dispatch `SetComponentProperty` PatchOp: `{ type: 'SetComponentProperty', entityId, componentType, property: propName, value: newValue, previousValue }`.
    - Use `useEditorStore` with a fine-grained selector to read only the specific property value, minimizing re-renders (avoid selecting entire ecsonDoc).

    **Individual Widget Components:**
    - All widgets follow consistent dark theme styling: dark input backgrounds (neutral-800), light text (neutral-100), accent borders on focus (blue-500), labels (neutral-400).
    - `slider-field.tsx`: Range input + number display. Min/max/step from EditorHint.
    - `color-picker.tsx`: Color swatch + hex input. Uses native `<input type="color">` with custom styled wrapper.
    - `vec3-input.tsx`: Three inline number inputs labeled X/Y/Z with colored labels (red/green/blue to match gizmo axes).
    - `checkbox-field.tsx`: Toggle switch with label.
    - `dropdown-field.tsx`: `<select>` element with options derived from schema enum or provided options list.
    - `number-field.tsx`: Number input with up/down step buttons, min/max bounds.
    - `textbox-field.tsx`: Text input with label.

    **Update EditorShell:** Mount InspectorPanel in the right sidebar panel.
  </action>
  <verify>
    - `pnpm typecheck --filter @riff3d/editor` passes
    - `pnpm lint --filter @riff3d/editor` passes
    - Selecting an entity shows its properties in the inspector
    - Transform inputs (position, rotation, scale) dispatch SetProperty PatchOps
    - Component properties render correct widgets based on editorHints
    - Changing a slider/color/vec3/etc. dispatches SetComponentProperty PatchOp
    - Add Component dropdown lists all registered components
    - Remove Component button dispatches RemoveComponent PatchOp
    - All widgets use dark theme styling consistently
  </verify>
  <done>
    Inspector panel auto-generates form widgets from component registry editorHints. All property edits create SetComponentProperty PatchOps. Transform editing works with Vec3 inputs. Add/remove component works through PatchOps. Widget types cover: slider, color, vec3, checkbox, dropdown, number, textbox.
  </done>
</task>

</tasks>

<verification>
- Scene hierarchy tree shows entity tree structure with correct parent-child relationships
- Clicking tree nodes syncs selection with viewport (bidirectional)
- Drag-to-reparent in tree dispatches Reparent PatchOp and updates scene
- Search/filter works in hierarchy
- Inspector shows correct properties for selected entity
- Transform edits in inspector update viewport
- Component property edits create correct PatchOps
- Add/remove components via inspector works
- Context menu in hierarchy allows adding and deleting entities
</verification>

<success_criteria>
- Scene hierarchy tree with drag-to-reparent, multi-select, search/filter (EDIT-03)
- Inspector panel auto-generated from component schemas with editorHints (EDIT-04)
- All hierarchy mutations produce PatchOps (Reparent, CreateEntity, DeleteEntity)
- All property edits produce SetComponentProperty PatchOps
- Selection syncs bidirectionally between tree and viewport
</success_criteria>

<output>
After completion, create `.planning/phases/02-closed-loop-editor/02-04-SUMMARY.md`
</output>
